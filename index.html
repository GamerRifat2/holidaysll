<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Holiday Travels - Management System</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Holiday App">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="LOGO.png">
    <link rel="icon" type="image/png" href="LOGO.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base & PWA Fixes */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; transition: background-color 0.3s, color 0.3s; overscroll-behavior-y: none; }
        .arabic-text { font-family: 'Cairo', sans-serif; direction: rtl; }
        
        /* Dark Mode Styles */
        body.dark { background-color: #111827; color: #e5e7eb; }
        body.dark .bg-white { background-color: #1f2937; border-color: #374151; color: #e5e7eb; }
        body.dark .bg-gray-50 { background-color: #111827; border-color: #374151; }
        body.dark .bg-gray-100 { background-color: #374151; }
        body.dark input, body.dark select, body.dark textarea { background-color: #374151; color: white; border-color: #4b5563; }
        body.dark .text-gray-800 { color: #f3f4f6; }
        body.dark .text-gray-700 { color: #d1d5db; }
        body.dark .text-gray-600 { color: #9ca3af; }
        body.dark .text-gray-500 { color: #9ca3af; }
        body.dark .border-gray-200 { border-color: #374151; }
        body.dark .border-gray-300 { border-color: #4b5563; }
        body.dark .hover\:bg-gray-50:hover { background-color: #374151; }
        body.dark .excel-table th { background-color: #374151; color: #e5e7eb; border-color: #4b5563; }
        body.dark .excel-table td { border-color: #4b5563; }
        body.dark .excel-table tr:nth-child(even) { background-color: #1f2937; } 
        body.dark .excel-table tr:hover { background-color: #374151; }
        
        /* Specific Dark Mode Overrides */
        body.dark .bg-blue-50 { background-color: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.2); }
        body.dark .bg-green-50 { background-color: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.2); }
        body.dark .bg-red-50 { background-color: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); }
        body.dark .bg-purple-50 { background-color: rgba(168, 85, 247, 0.1); border-color: rgba(168, 85, 247, 0.2); }
        body.dark .bg-orange-50 { background-color: rgba(249, 115, 22, 0.1); border-color: rgba(249, 115, 22, 0.2); }
        body.dark .bg-yellow-50 { background-color: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.2); }
        body.dark .bg-amber-50 { background-color: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.2); }

        /* Force Header to Stay White in Dark Mode */
        body.dark #global-header {
            background-color: white !important;
            border-color: #e5e7eb !important;
        }
        /* Restore Dark Text for Header in Dark Mode */
        body.dark #global-header .text-gray-800 { color: #1f2937 !important; } 
        body.dark #global-header .text-gray-600 { color: #4b5563 !important; }
        body.dark #global-header .text-gray-500 { color: #6b7280 !important; }

        /* Invoice Paper (Always White) */
        .invoice-paper {
            max-width: 210mm; min-height: 297mm; margin: 0 auto; padding: 2rem;
            background-color: white; 
            color: black;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; position: relative;
        }
        body.dark .invoice-paper {
            background-color: white; 
            color: black;
        }
        body.dark .invoice-paper .editable { color: black; }
        body.dark .invoice-paper input { background-color: transparent; color: black; border-color: #ddd; }

        /* Tab Animations */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Paid Stamp */
        .paid-seal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            border: 0.4rem solid #22c55e; border-radius: 0.8rem; padding: 0.5rem 2rem;
            text-align: center; opacity: 0; pointer-events: none; z-index: 50; transition: opacity 0.3s ease;
            color: #22c55e; background-color: rgba(255, 255, 255, 0.9); box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;
        }
        .paid-seal.is-visible { opacity: 0.4 !important; display: block !important; }

        /* Excel-like Table Styles - INCREASED SIZE FOR PC */
        .excel-table { border-collapse: collapse; width: 100%; font-size: 14px; } 
        .excel-table th, .excel-table td { border: 1px solid #d1d5db; padding: 8px 6px; }
        .excel-table th { background-color: #f3f4f6; font-weight: 700; text-align: center; white-space: nowrap; }
        .excel-table tr:nth-child(even) { background-color: #f9fafb; }
        .excel-table tr:hover { background-color: #eff6ff; cursor: pointer; }
        .excel-table td { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .row-selected { background-color: #fff7ed !important; border-left: 3px solid #f97316; }
        body.dark .row-selected { background-color: rgba(249, 115, 22, 0.2) !important; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 50; display: none;
            align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 800px; max-height: 85vh;
            border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column; overflow: hidden;
        }
        body.dark .modal-content { background: #1f2937; color: #e5e7eb; border: 1px solid #374151; }

        .print-header { display: none; }

        /* Print Settings */
        @media print {
            @page { margin: 0; size: A4 portrait; } 
            body { background: white !important; color: black !important; margin: 0; padding: 0; }
            .no-print, .controls, #login-screen, .tabs-nav, #global-header, .add-row-btn, .modal-overlay { display: none !important; }
            
            .tab-content { display: none !important; }
            .tab-content.active { display: block !important; }

            .invoice-paper { box-shadow: none; margin: 0; width: 100%; max-width: 100%; padding: 5mm; min-height: auto; height: auto; }
            
            #tab-invoice.active header { flex-direction: row !important; display: flex !important; }
            #tab-invoice.active header > div { width: 33.33% !important; }
            #tab-invoice.active .grid { display: grid !important; grid-template-columns: 1fr 1fr !important; }
            
            #tab-hisab.active { width: 100%; }
            #tab-expense.active { width: 100%; }
            
            /* Due Tab Print Styling (Divided Statement Look) */
            #tab-due.active .print-header { display: flex !important; flex-direction: row; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
            #tab-due.active .print-header img { height: 60px; }
            #tab-due.active .print-header .company-details { text-align: right; }
            
            /* Stats Row */
            #tab-due.active .grid { display: flex !important; flex-direction: row; gap: 10px; margin-bottom: 20px; }
            #tab-due.active .grid > div { flex: 1; border: 1px solid #000; background: #fff !important; padding: 8px; }
            #tab-due.active .grid > div p:first-child { font-size: 9px; font-weight: bold; text-transform: uppercase; color: #000; }
            #tab-due.active .grid > div p:nth-child(2) { font-size: 14px; font-weight: bold; color: #000; }
            
            /* Layout: Side-by-Side for Dues/Payables */
            #tab-due.active #due-active-view { display: grid !important; grid-template-columns: 48% 48%; gap: 4%; padding: 0 !important; }
            #tab-due.active #due-active-view > div { border: 1px solid #000; padding: 0; margin-bottom: 10px; }
            
            /* Bank spans full width below */
            #tab-due.active #due-active-view > div:nth-child(3) { grid-column: 1 / -1; margin-top: 10px; } 
            
            /* Print Headers */
            #tab-due.active h3 { font-size: 10pt; font-weight: bold; border-bottom: 1px solid #000; padding: 5px; margin: 0; background-color: #eee !important; -webkit-print-color-adjust: exact; text-transform: uppercase; }

            /* Table cleanup */
            .excel-table { width: 100%; border: none; }
            .excel-table th, .excel-table td { border: 1px solid #ccc !important; font-size: 9px; color: black !important; padding: 3px; } 
            .excel-table input, .excel-table select { border: none !important; padding: 0 !important; background: transparent !important; width: 100% !important; font-size: 9px; }

            #tab-dashboard.active .chart-container { page-break-inside: avoid; }
            
            .paid-seal.is-visible { display: block !important; }
        }
    </style>
</head>
<body class="text-gray-800 pb-safe">

    <!-- PASSWORD SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-gray-100 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center border border-gray-200">
            <div class="mb-6 flex justify-center">
                <img id="login-logo-img" src="LOGO.png" alt="Holiday Travels" class="h-24 w-auto object-contain">
            </div>
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Login Required</h2>
            <p class="text-gray-500 mb-6 text-sm">Enter passcode to access.</p>
            <input type="password" id="password-input" placeholder="Passcode" class="w-full p-3 border border-gray-200 rounded-lg mb-4 text-center text-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="attemptLogin()" class="w-full bg-gray-900 text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition-all shadow-lg">Login</button>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden font-medium">Incorrect Code</p>
        </div>
    </div>

    <!-- GLOBAL LOG MODAL (POPUP) -->
    <div id="log-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="p-4 bg-gray-100 border-b border-gray-200 flex justify-between items-center dark:bg-gray-800 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2 dark:text-gray-100">
                    <i data-lucide="history" class="text-blue-600"></i> <span id="log-modal-title">Activity Log</span>
                </h3>
                <button onclick="closeLogModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-4 overflow-y-auto flex-grow bg-white dark:bg-gray-900">
                <table class="excel-table w-full">
                    <thead>
                        <tr>
                            <th style="width: 20%">Time</th>
                            <th style="width: 15%">Action</th>
                            <th style="width: 40%">Details</th>
                            <th style="width: 25%">Change / Restore</th>
                        </tr>
                    </thead>
                    <tbody id="log-modal-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
                <div id="log-modal-empty" class="text-center py-8 text-gray-400 text-sm italic hidden">No records found for this section.</div>
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center dark:bg-gray-800 dark:border-gray-700">
                <button onclick="clearLog()" class="bg-red-100 text-red-600 px-4 py-2 rounded text-sm font-bold hover:bg-red-200 flex items-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> Clear Log</button>
                <button onclick="closeLogModal()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm font-bold hover:bg-gray-700">Close</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="max-w-[290mm] mx-auto mt-6 px-4 mb-4"> 
        
        <!-- GLOBAL HEADER -->
        <div id="global-header" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <img id="header-logo-img" src="LOGO.png" alt="Holiday Travels" class="h-12 w-auto object-contain">
            </div>
            <div class="flex gap-2 w-full md:w-auto items-center">
                <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-gray-100 transition-colors mr-2" title="Toggle Dark Mode">
                    <i data-lucide="moon" class="w-5 h-5 text-gray-600 dark:hidden"></i>
                    <i data-lucide="sun" class="w-5 h-5 text-yellow-400 hidden dark:block"></i>
                </button>
                <button onclick="backupData()" class="flex-1 md:flex-none bg-gray-800 text-white px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-gray-700 flex items-center justify-center gap-2 transition-all shadow-sm">
                    <i data-lucide="download-cloud" class="w-4 h-4"></i> Backup
                </button>
                <label class="flex-1 md:flex-none bg-blue-600 text-white px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-blue-700 flex items-center justify-center gap-2 cursor-pointer transition-all shadow-sm">
                    <i data-lucide="upload-cloud" class="w-4 h-4"></i> Restore
                    <input type="file" class="hidden" onchange="restoreData(this)" accept=".json">
                </label>
            </div>
        </div>

        <!-- NAVIGATION TABS -->
        <div class="tabs-nav flex gap-2 mb-6 bg-white p-2 rounded-xl shadow-sm border border-gray-200 no-print max-w-[210mm] mx-auto overflow-x-auto touch-pan-x">
            <button onclick="switchTab('dashboard')" id="btn-tab-dashboard" class="flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all bg-gray-900 text-white shadow-md">
                <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Dashboard
            </button>
            <button onclick="switchTab('hisab')" id="btn-tab-hisab" class="flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50">
                <i data-lucide="plane" class="w-4 h-4"></i> Ticketing
            </button>
            <button onclick="switchTab('due')" id="btn-tab-due" class="flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50">
                <i data-lucide="wallet" class="w-4 h-4"></i> Due & Bank
            </button>
            <button onclick="switchTab('expense')" id="btn-tab-expense" class="flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50">
                <i data-lucide="calculator" class="w-4 h-4"></i> Expenses
            </button>
            <button onclick="switchTab('invoice')" id="btn-tab-invoice" class="flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50">
                <i data-lucide="file-text" class="w-4 h-4"></i> Invoice
            </button>
        </div>

        <!-- TAB 1: DASHBOARD (Merged with Notes/Checkin, Charts Removed) -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden max-w-[210mm] mx-auto">
                <div class="p-6 bg-gray-50 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="bar-chart-3" class="text-blue-600"></i> Sales Dashboard</h2>
                    <p class="text-sm text-gray-500">Yearly & Monthly Overview</p>
                </div>

                <!-- URGENT CHECK-IN ALERTS -->
                <div id="dashboard-alerts" class="p-6 pb-0 hidden">
                    <!-- Injected via JS -->
                </div>
                
                <!-- ROW 1: YEARLY TOTALS -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 bg-white border-b border-gray-200">
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-2xl border border-green-200 shadow-sm">
                        <div class="text-green-600 font-bold uppercase text-xs tracking-wider mb-1">Total Sale (Year)</div>
                        <div class="text-3xl font-black text-gray-800" id="dash-total-sell">0.000</div>
                        <div class="text-xs text-green-700 mt-1">OMR</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-2xl border border-blue-200 shadow-sm">
                        <div class="text-blue-600 font-bold uppercase text-xs tracking-wider mb-1">Total Profit (Year)</div>
                        <div class="text-3xl font-black text-gray-800" id="dash-total-profit">0.000</div>
                        <div class="text-xs text-blue-700 mt-1">OMR</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-2xl border border-orange-200 shadow-sm">
                        <div class="text-orange-600 font-bold uppercase text-xs tracking-wider mb-1">Total Due</div>
                        <div class="text-3xl font-black text-gray-800" id="dash-total-due">0.000</div>
                        <div class="text-xs text-orange-700 mt-1">OMR</div>
                    </div>
                </div>

                <!-- ROW 2: MONTHLY BREAKDOWN -->
                <div class="p-6 bg-gray-50 border-b border-gray-200">
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-4 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i> Monthly Performance</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-xl border border-green-200 shadow-sm">
                            <div class="text-green-600 font-bold uppercase text-[10px] tracking-wider mb-1">This Month Sale</div>
                            <div class="text-2xl font-black text-gray-800" id="dash-month-sell">0.000</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-blue-200 shadow-sm">
                            <div class="text-blue-600 font-bold uppercase text-[10px] tracking-wider mb-1">This Month Profit</div>
                            <div class="text-2xl font-black text-gray-800" id="dash-month-profit">0.000</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm opacity-80">
                            <div class="text-gray-500 font-bold uppercase text-[10px] tracking-wider mb-1">Last Month Sale</div>
                            <div class="text-xl font-black text-gray-600" id="dash-last-month-sell">0.000</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm opacity-80">
                            <div class="text-gray-500 font-bold uppercase text-[10px] tracking-wider mb-1">Last Month Profit</div>
                            <div class="text-xl font-black text-gray-600" id="dash-last-month-profit">0.000</div>
                        </div>
                    </div>
                </div>

                <!-- MERGED CONTENT FROM NOTES/CHECK-IN TAB -->
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 bg-white">
                     
                     <!-- SECTION 1: GENERAL TASKS -->
                     <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-fit">
                        <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i data-lucide="clipboard-list" class="text-indigo-600"></i> Tasks & Notes</h2>
                            <!-- NOTES LOG BUTTON -->
                            <button onclick="openLogModal('notes')" class="text-blue-500 hover:text-blue-700 p-1 bg-blue-50 rounded-full" title="Notes History"><i data-lucide="history" class="w-4 h-4"></i></button>
                        </div>
                        <div class="p-4">
                            <form onsubmit="event.preventDefault(); addNote();" class="flex gap-2 mb-4">
                                <input type="text" id="note-input" placeholder="Add a new task..." class="flex-grow p-2 border border-gray-300 rounded text-sm" required>
                                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-indigo-700">Add</button>
                            </form>
                            <ul id="notes-list" class="space-y-2 max-h-[400px] overflow-y-auto">
                                <!-- Notes inserted here -->
                            </ul>
                        </div>
                     </div>

                     <!-- SECTION 2: SALAMAIR CHECK-IN TRACKER -->
                     <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden" id="salam-section">
                        <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i data-lucide="plane" class="text-green-600"></i> SalamAir Check-in Tracker</h2>
                            <div>
                                <button onclick="toggleSalamHistory()" class="text-xs font-bold text-gray-500 hover:text-gray-700 underline mr-2">Show History</button>
                                <!-- CHECK-IN LOG BUTTON -->
                                <button onclick="openLogModal('salam')" class="text-blue-500 hover:text-blue-700 p-1 bg-blue-50 rounded-full" title="Check-in Log"><i data-lucide="history" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div class="p-4 border-b border-gray-100">
                            <form onsubmit="event.preventDefault(); addSalamReminder();" class="flex flex-wrap gap-2 items-end">
                                <input type="hidden" id="salam-edit-id">
                                <div class="flex-grow min-w-[100px]">
                                    <label class="block text-xs font-bold text-gray-500 mb-1">PNR</label>
                                    <input type="text" id="salam-pnr" class="w-full p-2 border border-gray-300 rounded text-sm font-mono" placeholder="ABC123" required>
                                </div>
                                <div class="flex-grow min-w-[150px]">
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Name</label>
                                    <input type="text" id="salam-name" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Passenger Name" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Flight Date</label>
                                    <input type="date" id="salam-date" class="w-full p-2 border border-gray-300 rounded text-sm" required>
                                </div>
                                 <div class="flex-grow w-full">
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Remark (Optional)</label>
                                    <input type="text" id="salam-remark" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Seat, Bags, etc...">
                                </div>
                                <button type="submit" id="btn-salam-add" class="w-full bg-green-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-green-700 h-[38px] mt-2">Track Check-in</button>
                            </form>
                        </div>
                        
                        <!-- Active Reminders -->
                        <div class="p-0">
                             <table class="excel-table w-full">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th style="width: 20%">Flight Date</th>
                                        <th style="width: 15%">PNR</th>
                                        <th style="width: 30%">Name</th>
                                        <th style="width: 20%">Remark</th>
                                        <th style="width: 15%">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="salam-active-list"></tbody>
                            </table>
                            <div id="salam-empty" class="text-center py-8 text-gray-400 text-xs italic">No pending check-ins.</div>
                        </div>

                        <!-- History (Hidden by default) -->
                        <div id="salam-history-container" class="hidden border-t border-gray-200 mt-4">
                            <div class="p-2 bg-gray-100 text-xs font-bold text-gray-600 text-center uppercase tracking-wide">Check-in History</div>
                            <table class="excel-table w-full opacity-60">
                                <tbody id="salam-history-list"></tbody>
                            </table>
                        </div>
                     </div>

                </div>
            </div>
        </div>

        <!-- TAB 2: TRAVEL LEDGER (HISAB) -->
        <div id="tab-hisab" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 bg-gray-50 no-print">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center gap-2">
                            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i data-lucide="plane" class="text-blue-600 w-5 h-5"></i> Ticketing Ledger</h2>
                            <div class="h-6 w-px bg-gray-300 mx-2"></div>
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wide">Month:</span>
                            <input type="month" id="hisab-month-filter" class="p-1 border border-gray-300 rounded text-sm font-bold text-gray-800" onchange="loadHisab()">
                        </div>
                        <div class="flex gap-2">
                             <!-- POPUP LOG BUTTON -->
                             <button onclick="openLogModal('hisab')" class="bg-blue-100 text-blue-700 px-3 py-2 rounded text-xs font-bold hover:bg-blue-200 flex items-center gap-1 border border-blue-200"><i data-lucide="history" class="w-3 h-3"></i> History</button>
                             <button onclick="window.print()" class="bg-gray-800 text-white px-3 py-2 rounded text-xs font-bold hover:bg-gray-700 flex items-center gap-1"><i data-lucide="printer" class="w-3 h-3"></i> Print</button>
                             <button onclick="exportHisab('month')" class="bg-green-600 text-white px-3 py-2 rounded text-xs font-bold hover:bg-green-700 flex items-center gap-1"><i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Export Excel</button>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 bg-white border-b border-gray-200 no-print">
                    <form onsubmit="event.preventDefault(); addHisabEntry();" class="grid grid-cols-2 md:grid-cols-5 lg:grid-cols-10 gap-2 items-end">
                        <input type="hidden" id="h-edit-id"> 
                        <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">DATE</label><input type="date" id="h-date" class="w-full p-2 border border-gray-300 rounded text-sm bg-yellow-50" title="Leave empty for Today's Date"></div>
                        <div class="col-span-1 md:col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">NAME</label><input type="text" id="h-name" placeholder="Passenger Name" class="w-full p-2 border border-gray-300 rounded text-sm" required></div>
                        <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">PNR</label><input type="text" id="h-pnr" placeholder="PNR" class="w-full p-2 border border-gray-300 rounded text-sm"></div>
                        <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">FLIGHT DATE</label><input type="date" id="h-fdate" class="w-full p-2 border border-gray-300 rounded text-sm" title="Leave empty to use Entry Date"></div>
                        <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">SECTOR</label><input type="text" id="h-sector" placeholder="DXB-MCT" class="w-full p-2 border border-gray-300 rounded text-sm"></div>
                        <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">PHONE</label><input type="text" id="h-phone" placeholder="968..." class="w-full p-2 border border-gray-300 rounded text-sm"></div>
                        <div class="col-span-1"><label class="block text-xs font-bold text-red-600 mb-1">NET (COST)</label><input type="number" step="0.001" id="h-net" placeholder="0.000" class="w-full p-2 border border-red-200 rounded text-sm focus:border-red-500" required></div>
                        <div class="col-span-1"><label class="block text-xs font-bold text-green-600 mb-1">SELL (SALE)</label><input type="number" step="0.001" id="h-sell" placeholder="0.000" class="w-full p-2 border border-green-200 rounded text-sm focus:border-green-500" required></div>
                        <!-- Replaced DUE with REMARK -->
                        <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">REMARK</label><input type="text" id="h-remark" placeholder="Details..." class="w-full p-2 border border-gray-300 rounded text-sm"></div>
                        <div class="col-span-1 md:col-span-1 flex gap-1">
                            <button type="submit" id="btn-add-update" class="flex-grow bg-blue-600 text-white p-1.5 rounded font-bold hover:bg-blue-700 text-xs h-[38px] mt-6 shadow-sm transition-colors">ADD</button>
                            <button type="button" id="btn-cancel-edit" onclick="cancelEdit()" class="hidden bg-gray-200 text-gray-600 p-1.5 rounded font-bold hover:bg-gray-300 text-xs h-[38px] mt-6 w-8 flex items-center justify-center"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                    </form>
                </div>

                <div class="p-6 bg-white min-h-[500px]">
                    <div class="text-center mb-4">
                        <h1 class="text-xl font-bold text-gray-800 uppercase tracking-widest">Travel Agency Ledger</h1>
                        <p class="text-sm text-gray-500" id="sheet-header-date">January 2026</p>
                    </div>
                    <div class="grid grid-cols-3 gap-0 mb-4 border border-gray-300 text-center text-sm font-bold bg-gray-50">
                        <div class="p-2 border-r border-gray-300 text-red-700">Total Net (Cost): <span id="tot-net">0.000</span></div>
                        <div class="p-2 border-r border-gray-300 text-green-700">Total Sell: <span id="tot-sell">0.000</span></div>
                        <div class="p-2 text-blue-800">Total Profit: <span id="tot-profit">0.000</span></div>
                        <!-- Removed Total Due from Header -->
                    </div>
                    <div class="overflow-x-auto">
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th style="width: 8%">DATE</th><th style="width: 15%">NAME</th><th style="width: 8%">PNR</th><th style="width: 8%">FLIGHT DATE</th><th style="width: 8%">NET</th><th style="width: 8%">SELL</th><th style="width: 8%; background-color: #e0f2fe;">PROFIT</th><th style="width: 10%">SECTOR</th><th style="width: 10%">PHONE</th><th style="width: 8%;">REMARK</th><th class="no-print" style="width: 4%"></th>
                                </tr>
                            </thead>
                            <tbody id="hisab-table-body" class="text-gray-700 font-mono"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: DUE & BANKING TRACKER -->
        <div id="tab-due" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden max-w-[210mm] mx-auto">
                
                <!-- PRINT HEADER (Hidden on Screen, Visible on Print) -->
                <div class="print-header hidden">
                     <img src="LOGO.png" alt="Logo" class="h-24 w-auto object-contain">
                     <div class="company-details text-right">
                        <h1 class="font-bold text-gray-800 text-lg uppercase leading-tight mb-1">HOLIDAY TRAVELS</h1>
                        <p class="text-xs text-gray-600">NEAR PAK MOSJID SALALAH</p>
                        <p class="text-xs text-gray-600">Salalah, Sultanate of Oman</p>
                        <p class="text-xs text-gray-600 mt-1"><strong>Phone:</strong> 78594007</p>
                     </div>
                </div>
                <!-- END PRINT HEADER -->

                <div class="p-6 bg-gray-50 border-b border-gray-200 flex flex-col gap-4 no-print">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <i data-lucide="wallet" class="text-blue-600"></i> Due & Banking
                        </h2>
                        <div class="flex gap-2">
                            <!-- DUE LOG BUTTON -->
                            <button onclick="openLogModal('due')" class="bg-blue-100 text-blue-700 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 hover:bg-blue-200 border border-blue-200"><i data-lucide="history" class="w-3 h-3"></i> Log</button>
                            <button onclick="window.print()" class="bg-gray-800 text-white px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 hover:bg-gray-700"><i data-lucide="printer" class="w-3 h-3"></i> Print</button>
                        </div>
                    </div>
                    
                    <!-- View Toggle -->
                    <div class="flex justify-center">
                        <div class="bg-gray-200 p-1 rounded-lg flex gap-1">
                            <button onclick="setDueView('active')" id="btn-due-active" class="px-6 py-1.5 rounded-md text-sm font-bold bg-white text-gray-800 shadow-sm transition-all">Active / Pending</button>
                            <button onclick="setDueView('history')" id="btn-due-history" class="px-6 py-1.5 rounded-md text-sm font-bold text-gray-600 hover:bg-gray-300 transition-all">History / Paid</button>
                        </div>
                    </div>
                </div>

                <!-- Stats (Modified for Print to look like Summary Box) -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-6 bg-white">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <p class="text-xs font-bold text-blue-600 uppercase">Customer Due (Receivable)</p>
                        <p class="text-2xl font-black text-gray-800" id="due-total-receive">0.000</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                        <p class="text-xs font-bold text-red-600 uppercase">My Payables (Liability)</p>
                        <p class="text-2xl font-black text-gray-800" id="due-total-pay">0.000</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                        <p class="text-xs font-bold text-green-600 uppercase">Total Bank Deposit</p>
                        <p class="text-2xl font-black text-gray-800" id="due-total-bank">0.000</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <p class="text-xs font-bold text-purple-600 uppercase">Projected Net Balance</p>
                        <p class="text-2xl font-black text-gray-800" id="due-total-balance">0.000</p>
                        <p class="text-[9px] text-purple-400 mt-1 uppercase tracking-wide">Due + Bank - Payables</p>
                    </div>
                </div>

                <!-- ACTIVE VIEW -->
                <div id="due-active-view" class="grid grid-cols-1 gap-6 p-6">
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-1 flex items-center gap-2"><i data-lucide="arrow-down-left" class="text-blue-500 w-4 h-4"></i> Customer Dues (Receivables)</h3>
                        <table class="excel-table w-full">
                            <thead>
                                <tr>
                                    <th style="width: 25%">Customer Name</th>
                                    <th style="width: 15%">Phone (Opt)</th>
                                    <th style="width: 20%">Amount</th>
                                    <th style="width: 20%">Notes</th>
                                    <th style="width: 15%">Status</th>
                                    <th class="no-print" style="width: 5%"></th>
                                </tr>
                            </thead>
                            <tbody id="due-table-customer"></tbody>
                        </table>
                        <button onclick="addDueRow('customer')" class="add-row-btn w-full mt-2 bg-blue-100 text-blue-700 text-xs font-bold py-2 rounded hover:bg-blue-200 dashed-border border-blue-300 border-2 border-dashed">+ Add Customer Due</button>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-1 flex items-center gap-2"><i data-lucide="arrow-up-right" class="text-red-500 w-4 h-4"></i> My Payables (Pending)</h3>
                        <table class="excel-table w-full">
                            <thead><tr><th style="width: 30%">Pay To (Name)</th><th style="width: 20%">Amount</th><th style="width: 20%">Pay Date</th><th style="width: 20%">Status</th><th class="no-print" style="width: 10%"></th></tr></thead>
                            <tbody id="due-table-payable"></tbody>
                        </table>
                        <button onclick="addDueRow('payable')" class="add-row-btn w-full mt-2 bg-red-100 text-red-700 text-xs font-bold py-2 rounded hover:bg-red-200 dashed-border border-red-300 border-2 border-dashed">+ Add Payable</button>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-1 flex items-center gap-2"><i data-lucide="landmark" class="text-green-600 w-4 h-4"></i> Recent Bank Deposits</h3>
                        <table class="excel-table w-full">
                            <thead><tr><th style="width: 20%">Date</th><th style="width: 40%">Bank Name / Details</th><th style="width: 30%">Amount</th><th class="no-print" style="width: 10%"></th></tr></thead>
                            <tbody id="due-table-bank"></tbody>
                        </table>
                        <button onclick="addDueRow('bank')" class="add-row-btn w-full mt-2 bg-green-100 text-green-700 text-xs font-bold py-2 rounded hover:bg-green-200 dashed-border border-green-300 border-2 border-dashed">+ Add Bank Deposit</button>
                    </div>
                </div>

                <!-- HISTORY VIEW (Hidden by default) -->
                <div id="due-history-view" class="hidden p-6">
                    <div class="mb-8">
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-1 flex items-center gap-2"><i data-lucide="history" class="text-gray-500 w-4 h-4"></i> Completed / Paid Dues History</h3>
                        <table class="excel-table w-full">
                            <thead>
                                <tr>
                                    <th style="width: 10%">Type</th>
                                    <th style="width: 25%">Name / Details</th>
                                    <th style="width: 15%">Amount</th>
                                    <th style="width: 15%">Notes / Due Date</th>
                                    <th style="width: 15%">Paid Date</th>
                                    <th style="width: 10%">Status</th>
                                    <th class="no-print" style="width: 10%"></th>
                                </tr>
                            </thead>
                            <tbody id="due-table-history"></tbody>
                        </table>
                        <p class="text-xs text-gray-400 mt-2 text-center">Showing Paid Dues & Payables</p>
                    </div>

                    <div>
                         <h3 class="font-bold text-gray-700 mb-2 border-b pb-1 flex items-center gap-2"><i data-lucide="landmark" class="text-green-600 w-4 h-4"></i> All Bank Deposits History</h3>
                         <table class="excel-table w-full">
                            <thead><tr><th style="width: 20%">Date</th><th style="width: 40%">Bank Name / Details</th><th style="width: 30%">Amount</th><th class="no-print" style="width: 10%"></th></tr></thead>
                            <tbody id="due-table-bank-history"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- TAB 5: EXPENSE CALCULATOR (NEW) -->
        <div id="tab-expense" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden max-w-[210mm] mx-auto">
                <!-- Expense Header -->
                <div class="p-6 bg-gray-50 border-b border-gray-200 flex justify-between items-center no-print">
                    <div class="flex items-center gap-2">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="calculator" class="text-purple-600"></i> Expense Calculator</h2>
                        <div class="h-6 w-px bg-gray-300 mx-2"></div>
                        <input type="month" id="expense-month-filter" class="p-1 border border-gray-300 rounded text-sm font-bold text-gray-800" onchange="loadExpense()">
                    </div>
                    <div class="flex gap-2">
                         <!-- EXPENSE LOG BUTTON -->
                         <button onclick="openLogModal('expense')" class="bg-blue-100 text-blue-700 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 hover:bg-blue-200 border border-blue-200"><i data-lucide="history" class="w-3 h-3"></i> History</button>
                         <button onclick="window.print()" class="bg-gray-800 text-white px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 hover:bg-gray-700"><i data-lucide="printer" class="w-3 h-3"></i> Print</button>
                         <button onclick="exportExpense()" class="bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-green-700 flex items-center gap-1"><i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Export</button>
                    </div>
                </div>

                <!-- Expense Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 bg-white">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <p class="text-xs font-bold text-blue-600 uppercase">Office Expenses</p>
                        <p class="text-2xl font-black text-gray-800" id="exp-total-office">0.000</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <p class="text-xs font-bold text-purple-600 uppercase">Personal Expenses</p>
                        <p class="text-2xl font-black text-gray-800" id="exp-total-personal">0.000</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                        <p class="text-xs font-bold text-red-600 uppercase">Total Expenses</p>
                        <p class="text-2xl font-black text-gray-800" id="exp-total-grand">0.000</p>
                    </div>
                </div>

                <!-- Add Expense Form -->
                <div class="px-6 py-4 bg-white border-b border-gray-200 no-print">
                    <form onsubmit="event.preventDefault(); addExpenseEntry();" class="flex flex-wrap gap-2 items-end">
                         <div class="w-36">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Date</label>
                            <input type="date" id="exp-date" class="w-full p-2 border border-gray-300 rounded text-sm bg-gray-50" required>
                        </div>
                        <div class="flex-grow min-w-[200px]">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Description</label>
                            <input type="text" id="exp-desc" placeholder="Expense Details..." class="w-full p-2 border border-gray-300 rounded text-sm" required>
                        </div>
                        <div class="w-32">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Type</label>
                            <select id="exp-type" class="w-full p-2 border border-gray-300 rounded text-sm bg-gray-50">
                                <option value="Office">Office</option>
                                <option value="Personal">Personal</option>
                            </select>
                        </div>
                        <div class="w-28">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Amount</label>
                            <input type="number" step="0.001" id="exp-amount" placeholder="0.000" class="w-full p-2 border border-gray-300 rounded text-sm bg-gray-50" required>
                        </div>
                        <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded font-bold hover:bg-red-700 h-[38px] text-sm shadow-sm">Add</button>
                    </form>
                </div>

                <!-- Expense Table -->
                <div class="p-6 bg-white min-h-[300px]">
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th style="width: 15%">Date</th>
                                <th style="width: 45%">Description</th>
                                <th style="width: 15%">Type</th>
                                <th style="width: 15%">Amount</th>
                                <th class="no-print" style="width: 10%"></th>
                            </tr>
                        </thead>
                        <tbody id="expense-table-body" class="text-gray-700 font-mono"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 5: INVOICE GENERATOR -->
        <div id="tab-invoice" class="tab-content">
            <!-- Controls -->
            <div class="controls bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-wrap gap-4 justify-between items-center mb-6 max-w-[210mm] mx-auto">
                <div class="flex items-center gap-2 flex-grow max-w-md">
                    <input type="number" id="search-input" placeholder="Search Invoice No" class="flex-grow p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:outline-none text-sm">
                    <button onclick="window.searchInvoice()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm hover:bg-gray-700">Search</button>
                    <button onclick="window.resetSearch()" class="text-gray-500 hover:text-red-500 p-2" title="Reset/Clear"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.generateNewInvoice()" class="flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-2 rounded text-sm hover:bg-gray-200 font-bold border border-gray-300"><i data-lucide="plus" class="w-4 h-4"></i> New</button>
                    <button onclick="window.saveInvoice()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 font-bold shadow-sm"><i data-lucide="save" class="w-4 h-4"></i> Save</button>
                    <button onclick="window.print()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 font-bold shadow-sm"><i data-lucide="printer" class="w-4 h-4"></i> Print</button>
                </div>
                <div class="w-full flex justify-end mt-2 items-center gap-2">
                    <label class="flex items-center gap-2 cursor-pointer hover:text-green-600 font-bold text-sm text-gray-500">
                        <input type="checkbox" id="paid-toggle" class="rounded text-green-600 focus:ring-green-500" onchange="window.togglePaidStamp()">
                        <span>Mark as PAID</span>
                    </label>
                </div>
            </div>

            <!-- INVOICE PAPER -->
            <div class="invoice-paper" id="invoice-view">
                <div id="paid-watermark" class="paid-seal"><div class="text-5xl font-black uppercase tracking-wider">PAID</div><div class="text-3xl font-bold arabic-text mt-0"></div></div>
                
                <header class="flex flex-col md:flex-row justify-between items-center pb-6 border-b relative z-10 gap-4">
                    <div class="text-center md:text-left w-full md:w-1/3 pt-2">
                        <h1 class="font-bold text-gray-800 text-lg uppercase leading-tight mb-1">HOLIDAY TRAVELS</h1>
                        <p class="text-xs text-gray-600">NEAR PAK MOSJID SALALAH</p>
                        <p class="text-xs text-gray-600">Salalah, Sultanate of Oman</p>
                        <p class="text-xs text-gray-600 mt-1"><strong>Phone:</strong> 78594007</p>
                        <p class="text-xs text-gray-600"><strong>Email:</strong> HOLIDAYTRAVELS.OM@GMAIL.COM</p>
                    </div>
                    <div class="text-center w-full md:w-1/3 flex justify-center">
                        <img id="invoice-logo-img" src="LOGO.png" onerror="this.style.display='none'" alt="Logo" class="h-28 w-auto object-contain mx-auto">
                    </div>
                    <div class="text-center md:text-right w-full md:w-1/3 pt-2 arabic-text">
                        <h1 contenteditable="true" class="editable font-bold text-gray-800 text-xl leading-tight mb-1"> </h1>
                        <p contenteditable="true" class="editable text-sm text-gray-600">   </p>
                        <p contenteditable="true" class="editable text-sm text-gray-600">  </p>
                        <p class="text-sm text-gray-600 mt-1"><strong class="mx-1">:</strong><span class="font-sans" contenteditable="true">78594007</span></p>
                        <p class="text-sm text-gray-600"><strong class="mx-1"> :</strong><span class="font-sans text-xs" contenteditable="true">HOLIDAYTRAVELS.OM@GMAIL.COM</span></p>
                    </div>
                </header>

                <div class="flex justify-between items-center mt-6 mb-6">
                    <div class="text-left">
                        <div class="flex flex-col">
                            <span class="text-gray-500 text-xs font-bold uppercase">Invoice No</span>
                            <span id="invoice-number" contenteditable="true" class="editable text-xl font-bold text-gray-800 font-mono outline-none" title="Click to edit">9877</span>
                        </div>
                    </div>
                    <div class="text-center"><h2 class="text-3xl font-bold uppercase text-gray-800 tracking-wide">INVOICE <span class="arabic-text font-normal text-2xl"></span></h2></div>
                    <div class="text-right"><div class="flex flex-col"><span class="text-gray-500 text-xs font-bold uppercase">Date</span><span id="invoice-date" contenteditable="true" class="editable text-xl font-bold text-gray-800"></span></div></div>
                </div>

                <section class="mb-8 bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="flex justify-between items-end mb-2"><h3 class="text-xs font-bold uppercase text-gray-500 tracking-wider">Billed To</h3><h3 class="text-sm font-bold text-gray-500 arabic-text"> </h3></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs text-gray-400">Customer Name</label><div contenteditable="true" id="customer-name" class="editable text-lg font-bold text-gray-800 w-full p-1" data-placeholder="Name">Customer Name</div></div>
                        <div class="md:text-right"><label class="block text-xs text-gray-400">Phone</label><div contenteditable="true" id="customer-phone" class="editable text-gray-600 w-full p-1 font-sans" data-placeholder="Phone">Phone Number</div></div>
                    </div>
                </section>

                <section class="flex-grow">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-gray-800 text-white">
                                <th class="p-3 text-sm font-semibold uppercase tracking-wider w-3/4 rounded-tl-lg rounded-bl-lg"><div class="flex justify-between"><span>Item Description</span><span class="arabic-text font-normal"></span></div></th>
                                <th class="p-3 text-right text-sm font-semibold uppercase tracking-wider w-1/4 rounded-tr-lg rounded-br-lg"><div class="flex flex-col items-end"><span>Amount (OMR)</span><span class="arabic-text text-xs text-gray-300"></span></div></th>
                                <th class="w-10 no-print bg-white"></th>
                            </tr>
                        </thead>
                        <tbody id="items-table-body"></tbody>
                    </table>
                    <button id="add-item-btn" onclick="window.addRow()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Add Item</button>
                </section>

                <section class="mt-8 flex justify-end">
                    <div class="w-72">
                        <div class="flex justify-between items-center py-2 border-b border-gray-200"><span class="text-gray-600 font-medium text-sm">Subtotal</span><span class="font-bold text-gray-800"><span id="subtotal">0.000</span></span></div>
                        <div class="flex justify-between items-center py-3 bg-gray-100 px-4 rounded-lg mt-3 border border-gray-200"><span class="text-lg font-bold text-gray-800">Total</span><span class="text-xl font-bold text-blue-900"><span id="total">0.000</span> <span class="text-sm text-gray-500">OMR</span></span></div>
                    </div>
                </section>

                <footer class="mt-12 pt-6 border-t border-gray-200 text-gray-500 text-sm">
                    <div class="flex flex-col md:flex-row justify-between items-end">
                        <div class="text-left space-y-1">
                            <p class="text-xs uppercase font-bold text-gray-800">Company Reg Details</p>
                            <p class="font-bold text-gray-700">Sajer Desert Rare Trading Company</p>
                            <p class="font-bold text-gray-700 arabic-text">    </p>
                            <p><strong class="text-xs">CR No:</strong> <span class="font-mono">1588173</span></p>
                        </div>
                        <div class="mt-4 md:mt-0 flex flex-col items-center">
                            <img src="WHATSAPP.jpg" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png'" alt="WhatsApp" class="w-16 h-16 object-contain mb-1">
                            <p class="text-xs font-bold text-green-600">Contact Support</p>
                        </div>
                    </div>
                    <p class="mt-8 italic text-center text-[10px] text-gray-400">This invoice is electronically generated /    </p>
                </footer>
            </div>
        </div>

    </div>

    <script>
        const STORAGE_PREFIX = 'holiday_inv_';
        const STORAGE_KEY_COUNTER = 'holidayTravelsInvoiceNum';
        const STORAGE_HISAB = 'holiday_ledger_data';
        const STORAGE_DUE = 'holiday_due_data';
        const STORAGE_EXPENSE = 'holiday_expense_data';
        const STORAGE_NOTES = 'holiday_notes_data';
        const STORAGE_SALAM = 'holiday_salam_data';
        const STORAGE_SALAM_HISTORY = 'holiday_salam_history';
        const STORAGE_LOG = 'holiday_system_log';
        const STORAGE_TRASH = 'holiday_trash_data';
        let dueViewMode = 'active'; 
        let currentTrashSource = null;
        
        lucide.createIcons();

        // --- SAFE DATE FORMATTER (FIXED) ---
        function formatDateSafe(dateStr) {
            if (!dateStr || dateStr === "Invalid Date") return '-';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return '-';
            return d.toLocaleDateString('en-GB', {day: 'numeric', month: 'short'});
        }

        // --- DARK MODE LOGIC ---
        function toggleDarkMode() {
            const html = document.documentElement;
            const body = document.body;
            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                localStorage.setItem('holiday_theme', 'light');
            } else {
                body.classList.add('dark');
                localStorage.setItem('holiday_theme', 'dark');
            }
        }
        
        // Init Dark Mode
        if (localStorage.getItem('holiday_theme') === 'dark') {
            document.body.classList.add('dark');
        }

        // --- AUTHENTICATION ---
        const CORRECT_PASS = "96419161";
        const loginScreen = document.getElementById('login-screen');
        const passInput = document.getElementById('password-input');
        
        if (sessionStorage.getItem('invoice_authorized') === 'true' && loginScreen) { loginScreen.style.display = 'none'; }

        function attemptLogin() {
            if (passInput && passInput.value === CORRECT_PASS) {
                sessionStorage.setItem('invoice_authorized', 'true');
                if(loginScreen) loginScreen.style.display = 'none';
            } else {
                const err = document.getElementById('login-error');
                if(err) err.classList.remove('hidden');
                if(passInput) passInput.value = '';
            }
        }
        
        if (passInput) {
            passInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') attemptLogin(); });
            passInput.focus();
        }

        // --- DATA GETTERS ---
        function getHisabData() { return JSON.parse(localStorage.getItem(STORAGE_HISAB) || '[]'); }
        function getDueData() { return JSON.parse(localStorage.getItem(STORAGE_DUE) || '[]'); }
        function getExpenseData() { return JSON.parse(localStorage.getItem(STORAGE_EXPENSE) || '[]'); }
        function getNotes() { return JSON.parse(localStorage.getItem(STORAGE_NOTES) || '[]'); }
        function getSalamReminders() { return JSON.parse(localStorage.getItem(STORAGE_SALAM) || '[]'); }

        // --- TABS ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            const activeTab = document.getElementById(`tab-${tabName}`);
            if(activeTab) activeTab.classList.add('active');
            
            // Reset buttons
            document.querySelectorAll('.tabs-nav button').forEach(btn => {
                btn.className = "flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50";
            });
            
            // Activate current button
            const currentBtn = document.getElementById(`btn-tab-${tabName}`);
            if(currentBtn) {
                 currentBtn.className = "flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all bg-gray-900 text-white shadow-md";
            }

            if(tabName === 'hisab') loadHisab();
            if(tabName === 'dashboard') {
                updateDashboard();
                loadNotes(); 
                loadSalamReminders();
            }
            if(tabName === 'due') loadDueData();
            if(tabName === 'expense') loadExpense();
            if(tabName === 'notes') loadNotes(); 
            if(tabName === 'invoice') {
                const tbody = document.getElementById('items-table-body');
                if(tbody && tbody.children.length === 0) window.addRow();
            }
        }

        // --- TRASH & LOG SYSTEM LOGIC ---
        function getTrashData() {
            return JSON.parse(localStorage.getItem(STORAGE_TRASH) || '[]');
        }

        function logSystemActivity(type, source, desc, oldVal = null, newVal = null, fullItem = null) {
            const logs = JSON.parse(localStorage.getItem(STORAGE_LOG) || '[]');
            logs.unshift({
                id: Date.now(),
                date: new Date().toISOString(),
                type, // 'create', 'edit', 'delete'
                source,
                desc,
                oldVal,
                newVal,
                fullItem // For restore
            });
            if (logs.length > 500) logs.pop(); // Keep last 500 actions
            localStorage.setItem(STORAGE_LOG, JSON.stringify(logs));
        }

        function openLogModal(source) {
            currentTrashSource = source; 
            const titles = {
                'hisab': 'Ticketing History',
                'notes': 'Notes History',
                'salam': 'Check-in Log',
                'due': 'Due & Bank Log',
                'expense': 'Expense Log'
            };
            document.getElementById('log-modal-title').textContent = titles[source] || 'Activity Log';
            loadLogModalData();
            document.getElementById('log-modal').style.display = 'flex';
        }

        function closeLogModal() {
            document.getElementById('log-modal').style.display = 'none';
            currentTrashSource = null;
        }

        // ADDED CLEAR LOG FUNCTION
        function clearLog() {
            if(!confirm("Clear this activity log? This cannot be undone.")) return;
            
            let logs = JSON.parse(localStorage.getItem(STORAGE_LOG) || '[]');
            
            if (currentTrashSource) {
                logs = logs.filter(item => item.source !== currentTrashSource);
            } else {
                logs = [];
            }
            
            localStorage.setItem(STORAGE_LOG, JSON.stringify(logs));
            loadLogModalData();
        }

        function restoreLogItem(id) {
            const logs = JSON.parse(localStorage.getItem(STORAGE_LOG) || '[]');
            const index = logs.findIndex(l => l.id === id);
            if(index === -1) return;
            const logEntry = logs[index];
            
            if(logEntry.type !== 'delete') return; 
            
            const item = logEntry.fullItem;
            if(!item) return alert("Cannot restore: Data missing.");

            // Restore logic based on source
            if(logEntry.source === 'hisab') {
                const data = getHisabData();
                data.push(item);
                localStorage.setItem(STORAGE_HISAB, JSON.stringify(data));
                if(document.getElementById('tab-hisab').classList.contains('active')) loadHisab();
            } else if(logEntry.source === 'notes') {
                const data = getNotes();
                data.push(item);
                localStorage.setItem(STORAGE_NOTES, JSON.stringify(data));
                // Notes are now in dashboard
                if(document.getElementById('tab-dashboard').classList.contains('active')) loadNotes();
            } else if(logEntry.source === 'salam') {
                const data = getSalamReminders();
                data.push(item);
                localStorage.setItem(STORAGE_SALAM, JSON.stringify(data));
                // Salam is now in dashboard
                if(document.getElementById('tab-dashboard').classList.contains('active')) loadSalamReminders();
            } else if(logEntry.source === 'due') {
                const data = getDueData();
                data.push(item);
                localStorage.setItem(STORAGE_DUE, JSON.stringify(data));
                if(document.getElementById('tab-due').classList.contains('active')) loadDueData();
            } else if(logEntry.source === 'expense') {
                const data = getExpenseData();
                data.push(item);
                localStorage.setItem(STORAGE_EXPENSE, JSON.stringify(data));
                if(document.getElementById('tab-expense').classList.contains('active')) loadExpense();
            }

            // Mark as restored by removing the log entry (or we could change type to 'restored')
            logs.splice(index, 1);
            localStorage.setItem(STORAGE_LOG, JSON.stringify(logs));
            
            logSystemActivity('create', logEntry.source, `Restored: ${logEntry.desc}`);
            loadLogModalData(); // Refresh modal
            alert("Item Restored Successfully!");
        }

        function loadLogModalData() {
            const tbody = document.getElementById('log-modal-body');
            let logs = JSON.parse(localStorage.getItem(STORAGE_LOG) || '[]');
            tbody.innerHTML = '';

            // Filter by current source context
            if (currentTrashSource) {
                logs = logs.filter(item => item.source === currentTrashSource);
            }

            if (logs.length === 0) {
                document.getElementById('log-modal-empty').classList.remove('hidden');
            } else {
                document.getElementById('log-modal-empty').classList.add('hidden');
                
                // Sort by date desc
                logs.sort((a,b) => new Date(b.date) - new Date(a.date));

                logs.forEach(log => {
                    const row = document.createElement('tr');
                    
                    let badgeClass = "bg-gray-100 text-gray-700";
                    if(log.type === 'create') badgeClass = "bg-green-100 text-green-700";
                    if(log.type === 'edit') badgeClass = "bg-blue-100 text-blue-700";
                    if(log.type === 'delete') badgeClass = "bg-red-100 text-red-700";

                    let changeText = "-";
                    if (log.type === 'edit') {
                        // Safe check for nulls
                        const oVal = log.oldVal !== null ? log.oldVal : '';
                        const nVal = log.newVal !== null ? log.newVal : '';
                        changeText = `<span class="text-red-500 line-through mr-1">${oVal}</span> <i data-lucide="arrow-right" class="w-3 h-3 inline text-gray-400"></i> <span class="text-green-600 font-bold ml-1">${nVal}</span>`;
                    } else if (log.type === 'delete') {
                        changeText = `<span class="text-red-600 font-bold">Deleted</span>`;
                    } else {
                        changeText = `<span class="text-green-600">Added</span>`;
                    }

                    let restoreBtn = "";
                    if(log.type === 'delete') {
                        restoreBtn = `<button onclick="restoreLogItem(${log.id})" class="text-white bg-green-600 hover:bg-green-700 px-2 py-1 rounded text-xs font-bold flex items-center gap-1 mx-auto"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> Restore</button>`;
                    }

                    // Fix Invalid Date issue for Log Table
                    let logTime = '-';
                    if(log.date && log.date !== "Invalid Date") {
                         const d = new Date(log.date);
                         if(!isNaN(d.getTime())) {
                             logTime = d.toLocaleString();
                         }
                    }

                    row.innerHTML = `
                        <td class="text-xs text-gray-500">${logTime}</td>
                        <td class="text-center"><span class="px-2 py-1 rounded text-xs font-bold uppercase ${badgeClass}">${log.type}</span></td>
                        <td class="text-sm font-medium text-gray-700">
                            ${log.desc}
                        </td>
                        <td class="text-sm font-mono text-center">${changeText}</td>
                        <td class="text-center">${restoreBtn}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            lucide.createIcons();
        }

        // --- DASHBOARD LOGIC ---
        function updateDashboard() {
            const data = getHisabData();
            const dueData = getDueData(); // Get dues for dashboard
            
            // Calculate Aggregates
            let yearSell = 0, yearProfit = 0;
            let monthSell = 0, monthProfit = 0;
            let lastMonthSell = 0, lastMonthProfit = 0;

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-11

            // Calculate Last Month (handling year rollover)
            let lastMonthIndex = currentMonth - 1;
            let lastMonthYear = currentYear;
            if (lastMonthIndex < 0) {
                lastMonthIndex = 11;
                lastMonthYear -= 1;
            }

            data.forEach(item => {
                if (!item.date) return;
                
                // Parse date & values safely - Using String Split to avoid timezone issues
                const parts = item.date.split('-'); // YYYY-MM-DD
                if (parts.length !== 3) return;
                
                const iYear = parseInt(parts[0]);
                const iMonth = parseInt(parts[1]) - 1; // 0-11
                
                // Fallback for sale/sell property name
                const sellVal = parseFloat(item.sell || item.sale) || 0;
                const netVal = parseFloat(item.net) || 0;
                const profit = sellVal - netVal;
                
                // 1. Yearly Stats (Current Year)
                if (iYear === currentYear) {
                    yearSell += sellVal;
                    yearProfit += profit;
                }

                // 2. This Month Stats
                if (iYear === currentYear && iMonth === currentMonth) {
                    monthSell += sellVal;
                    monthProfit += profit;
                }

                // 3. Last Month Stats
                if (iYear === lastMonthYear && iMonth === lastMonthIndex) {
                    lastMonthSell += sellVal;
                    lastMonthProfit += profit;
                }
            });
            
            // Calculate Total Due from Due & Banking tab
            let totalDue = 0;
            dueData.forEach(item => {
                const amt = parseFloat(item.amount) || 0;
                if (item.type === 'customer' && (item.status === 'Pending' || item.status === 'Urgent')) {
                    totalDue += amt;
                }
            });

            // Update UI
            const tSell = document.getElementById('dash-total-sell'); if(tSell) tSell.textContent = yearSell.toFixed(3);
            const tProf = document.getElementById('dash-total-profit'); if(tProf) tProf.textContent = yearProfit.toFixed(3);
            const tDue = document.getElementById('dash-total-due'); if(tDue) tDue.textContent = totalDue.toFixed(3);

            const mSell = document.getElementById('dash-month-sell'); if(mSell) mSell.textContent = monthSell.toFixed(3);
            const mProf = document.getElementById('dash-month-profit'); if(mProf) mProf.textContent = monthProfit.toFixed(3);
            
            const lmSell = document.getElementById('dash-last-month-sell'); if(lmSell) lmSell.textContent = lastMonthSell.toFixed(3);
            const lmProf = document.getElementById('dash-last-month-profit'); if(lmProf) lmProf.textContent = lastMonthProfit.toFixed(3);
            
            // CHECK-IN ALERTS
            updateDashboardCheckins();
        }

        function updateDashboardCheckins() {
            const reminders = getSalamReminders(); 
            const today = new Date();
            today.setHours(0,0,0,0);
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            const urgent = [];
            
            reminders.forEach(r => {
                const flightDate = new Date(r.date);
                flightDate.setHours(0,0,0,0);
                
                if (flightDate.getTime() === today.getTime() || flightDate.getTime() === tomorrow.getTime()) {
                    urgent.push(r);
                }
            });
            
            const alertBox = document.getElementById('dashboard-alerts');
            if (!alertBox) return;

            if (urgent.length > 0) {
                alertBox.classList.remove('hidden');
                let html = `
                <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r shadow-sm">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center">
                            <i data-lucide="bell-ring" class="h-6 w-6 text-amber-600 mr-3 animate-pulse"></i>
                            <div>
                                <h3 class="text-lg font-bold text-amber-900">Urgent Check-ins Needed (${urgent.length})</h3>
                                <p class="text-sm text-amber-700">Passengers flying within 48 hours.</p>
                            </div>
                        </div>
                        <button onclick="switchTab('notes')" class="bg-amber-600 text-white text-xs px-4 py-1.5 rounded-lg font-bold hover:bg-amber-700 shadow-sm transition-colors">
                            Go to Check-in
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">`;
                    
                urgent.forEach(r => {
                     const fDate = new Date(r.date);
                     fDate.setHours(0,0,0,0);
                     const isToday = fDate.getTime() === today.getTime();
                     const badge = isToday 
                        ? `<span class="bg-red-100 text-red-700 text-[10px] px-2 py-0.5 rounded font-bold uppercase border border-red-200">Flight Today</span>` 
                        : `<span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded font-bold uppercase border border-blue-200">Tomorrow</span>`;
                     
                     html += `
                      <div class="flex justify-between items-center bg-white p-2.5 rounded border border-amber-100 shadow-sm">
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-800 text-sm">${r.name}</span>
                            <span class="font-mono text-xs text-gray-500">PNR: ${r.pnr}</span>
                        </div>
                        ${badge}
                      </div>`;
                });
                
                html += `</div></div>`;
                alertBox.innerHTML = html;
                lucide.createIcons();
            } else {
                alertBox.classList.add('hidden');
                alertBox.innerHTML = '';
            }
        }

        // --- HISAB (TICKETING) FUNCTIONS ---
        function loadHisab() {
            const data = getHisabData();
            const filterMonth = document.getElementById('hisab-month-filter').value; // YYYY-MM
            const tbody = document.getElementById('hisab-table-body');
            tbody.innerHTML = '';
            
            let totNet = 0, totSell = 0, totProfit = 0;

            const filtered = data.filter(item => !filterMonth || item.date.startsWith(filterMonth));
            
            filtered.sort((a,b) => new Date(b.date) - new Date(a.date));

            filtered.forEach(item => {
                const sell = parseFloat(item.sell) || 0;
                const net = parseFloat(item.net) || 0;
                const profit = sell - net;

                totNet += net;
                totSell += sell;
                totProfit += profit;

                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-50 cursor-pointer';
                row.onclick = (e) => {
                    if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'I') editHisab(item.id);
                };
                
                row.innerHTML = `
                    <td class="text-center font-bold text-xs text-gray-500">${item.date}</td>
                    <td class="font-bold text-gray-800" title="${item.name}">${item.name}</td>
                    <td class="text-center font-mono text-xs">${item.pnr || '-'}</td>
                    <td class="text-center text-xs text-blue-600">${formatDateSafe(item.flight_date)}</td>
                    <td class="text-right text-red-600 font-medium">${net.toFixed(3)}</td>
                    <td class="text-right text-green-600 font-bold">${sell.toFixed(3)}</td>
                    <td class="text-right font-black ${profit>=0 ? 'text-blue-600' : 'text-red-500'} bg-blue-50">${profit.toFixed(3)}</td>
                    <td class="text-xs text-gray-500">${item.sector || '-'}</td>
                    <td class="text-xs font-mono text-gray-500">${item.phone || '-'}</td>
                    <td class="text-xs text-gray-500 italic truncate max-w-[100px]" title="${item.remark}">${item.remark || '-'}</td>
                    <td class="text-center no-print">
                        <button onclick="deleteHisab(${item.id}, event)" class="p-1 text-red-400 hover:text-red-600 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('tot-net').textContent = totNet.toFixed(3);
            document.getElementById('tot-sell').textContent = totSell.toFixed(3);
            document.getElementById('tot-profit').textContent = totProfit.toFixed(3);
            document.getElementById('sheet-header-date').textContent = filterMonth ? `Statement: ${filterMonth}` : 'All Time Records';
            lucide.createIcons();
        }

        function addHisabEntry() {
            const data = getHisabData();
            const id = document.getElementById('h-edit-id').value;
            const date = document.getElementById('h-date').value || new Date().toISOString().split('T')[0];
            const name = document.getElementById('h-name').value;
            const pnr = document.getElementById('h-pnr').value;
            // Use date as default flight date if empty
            const fdate = document.getElementById('h-fdate').value || date; 
            const sector = document.getElementById('h-sector').value;
            const phone = document.getElementById('h-phone').value;
            const net = document.getElementById('h-net').value;
            const sell = document.getElementById('h-sell').value;
            const remark = document.getElementById('h-remark').value;

            const entry = {
                id: id ? parseInt(id) : Date.now(),
                date, name, pnr, flight_date: fdate, sector, phone, net, sell, remark
            };

            if (id) {
                const index = data.findIndex(i => i.id == id);
                if (index > -1) {
                    const oldItem = data[index];
                    logSystemActivity('edit', 'hisab', `Edited Ticket: ${name}`, oldItem.sell, entry.sell);
                    data[index] = entry;
                }
            } else {
                data.push(entry);
                logSystemActivity('create', 'hisab', `New Ticket: ${name}`);
            }

            localStorage.setItem(STORAGE_HISAB, JSON.stringify(data));
            loadHisab();
            cancelEdit();
        }

        function editHisab(id) {
            const data = getHisabData();
            const item = data.find(i => i.id === id);
            if (!item) return;

            document.getElementById('h-edit-id').value = item.id;
            document.getElementById('h-date').value = item.date;
            document.getElementById('h-name').value = item.name;
            document.getElementById('h-pnr').value = item.pnr || '';
            document.getElementById('h-fdate').value = item.flight_date || '';
            document.getElementById('h-sector').value = item.sector || '';
            document.getElementById('h-phone').value = item.phone || '';
            document.getElementById('h-net').value = item.net;
            document.getElementById('h-sell').value = item.sell;
            document.getElementById('h-remark').value = item.remark || '';

            document.getElementById('btn-add-update').textContent = 'UPDATE';
            document.getElementById('btn-add-update').className = "flex-grow bg-orange-500 text-white p-1.5 rounded font-bold hover:bg-orange-600 text-xs h-[38px] mt-6 shadow-sm transition-colors";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
        }

        function cancelEdit() {
            document.querySelector('#tab-hisab form').reset();
            document.getElementById('h-edit-id').value = '';
            document.getElementById('btn-add-update').textContent = 'ADD';
            document.getElementById('btn-add-update').className = "flex-grow bg-blue-600 text-white p-1.5 rounded font-bold hover:bg-blue-700 text-xs h-[38px] mt-6 shadow-sm transition-colors";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            // Reset Date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('h-date').value = today;
        }

        function deleteHisab(id, e) {
            e.stopPropagation();
            if (!confirm('Delete this record?')) return;
            const data = getHisabData();
            const index = data.findIndex(i => i.id === id);
            if(index > -1) {
                const item = data[index];
                logSystemActivity('delete', 'hisab', `Deleted Ticket: ${item.name}`, null, null, item);
                data.splice(index, 1);
                localStorage.setItem(STORAGE_HISAB, JSON.stringify(data));
                loadHisab();
            }
        }
        
        function addHisabTransaction(txData) {
            const data = getHisabData();
            txData.id = Date.now();
            data.push(txData);
            localStorage.setItem(STORAGE_HISAB, JSON.stringify(data));
            logSystemActivity('create', 'hisab', `Auto-Ledger from Invoice #${txData.invoiceId}`);
        }

        // --- DUE & BANKING FUNCTIONS ---
        function loadDueData() {
            const data = getDueData();
            const activeView = document.getElementById('due-active-view');
            const historyView = document.getElementById('due-history-view');
            
            // Clear tables
            ['customer', 'payable', 'bank', 'history', 'bank-history'].forEach(t => {
                document.getElementById(`due-table-${t}`).innerHTML = '';
            });

            // Handle View Toggle
            if (dueViewMode === 'active') {
                activeView.classList.remove('hidden');
                historyView.classList.add('hidden');
                document.getElementById('btn-due-active').className = "px-6 py-1.5 rounded-md text-sm font-bold bg-white text-gray-800 shadow-sm transition-all";
                document.getElementById('btn-due-history').className = "px-6 py-1.5 rounded-md text-sm font-bold text-gray-600 hover:bg-gray-300 transition-all";
            } else {
                activeView.classList.add('hidden');
                historyView.classList.remove('hidden');
                document.getElementById('btn-due-active').className = "px-6 py-1.5 rounded-md text-sm font-bold text-gray-600 hover:bg-gray-300 transition-all";
                document.getElementById('btn-due-history').className = "px-6 py-1.5 rounded-md text-sm font-bold bg-white text-gray-800 shadow-sm transition-all";
            }

            let totRec = 0, totPay = 0, totBank = 0;

            // Sort by date desc
            data.sort((a,b) => (b.date || '').localeCompare(a.date || ''));

            data.forEach(item => {
                const amt = parseFloat(item.amount) || 0;
                let tableId = '';

                // Calculate Totals & Assign Table
                if (item.type === 'customer') {
                    if (item.status === 'Paid') {
                        tableId = 'due-table-history';
                    } else {
                        tableId = 'due-table-customer';
                        totRec += amt;
                    }
                } else if (item.type === 'payable') {
                    if (item.status === 'Paid') {
                        tableId = 'due-table-history';
                    } else {
                        tableId = 'due-table-payable';
                        totPay += amt;
                    }
                } else if (item.type === 'bank') {
                    tableId = 'due-table-bank'; // In active view
                    // Also add to bank history
                    renderDueRow(item, 'due-table-bank-history');
                    totBank += amt;
                }

                if (tableId) renderDueRow(item, tableId);
            });

            document.getElementById('due-total-receive').textContent = totRec.toFixed(3);
            document.getElementById('due-total-pay').textContent = totPay.toFixed(3);
            document.getElementById('due-total-bank').textContent = totBank.toFixed(3);
            document.getElementById('due-total-balance').textContent = (totRec + totBank - totPay).toFixed(3);
            lucide.createIcons();
        }

        function renderDueRow(item, tableId) {
            const tbody = document.getElementById(tableId);
            if (!tbody) return; // For bank history when in active mode
            
            const row = document.createElement('tr');
            const amt = parseFloat(item.amount).toFixed(3);
            
            // Common Actions
            const deleteBtn = `<button onclick="deleteDue(${item.id})" class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
            
            if (tableId === 'due-table-customer') {
                row.innerHTML = `
                    <td class="font-bold text-gray-800">${item.name}</td>
                    <td class="font-mono text-xs text-gray-500">${item.phone || '-'}</td>
                    <td class="font-bold text-red-600">${amt}</td>
                    <td class="text-xs text-gray-500 italic">${item.notes || '-'}</td>
                    <td><button onclick="toggleDueStatus(${item.id})" class="px-2 py-1 rounded bg-orange-100 text-orange-700 text-xs font-bold hover:bg-orange-200">Pending</button></td>
                    <td class="text-center no-print">${deleteBtn}</td>
                `;
            } else if (tableId === 'due-table-payable') {
                row.innerHTML = `
                    <td class="font-bold text-gray-800">${item.name}</td>
                    <td class="font-bold text-red-600">${amt}</td>
                    <td class="text-xs text-gray-500">${item.date || '-'}</td>
                    <td><button onclick="toggleDueStatus(${item.id})" class="px-2 py-1 rounded bg-red-100 text-red-700 text-xs font-bold hover:bg-red-200">Unpaid</button></td>
                    <td class="text-center no-print">${deleteBtn}</td>
                `;
            } else if (tableId === 'due-table-bank' || tableId === 'due-table-bank-history') {
                row.innerHTML = `
                    <td class="text-xs text-gray-500">${item.date}</td>
                    <td class="font-bold text-gray-800">${item.name}</td>
                    <td class="font-bold text-green-600 font-mono">${amt}</td>
                    <td class="text-center no-print">${deleteBtn}</td>
                `;
            } else if (tableId === 'due-table-history') {
                const isPayable = item.type === 'payable';
                const color = isPayable ? 'text-red-600' : 'text-blue-600';
                const badge = isPayable 
                    ? `<span class="bg-red-50 text-red-600 px-2 py-1 rounded text-xs font-bold">Payable</span>`
                    : `<span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">Receivable</span>`;
                
                row.innerHTML = `
                    <td>${badge}</td>
                    <td class="font-bold text-gray-800">${item.name}</td>
                    <td class="font-bold ${color}">${amt}</td>
                    <td class="text-xs text-gray-500">${item.notes || item.date || '-'}</td>
                    <td class="text-xs text-gray-500">${item.paidDate || '-'}</td>
                    <td><button onclick="toggleDueStatus(${item.id})" class="px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-bold hover:bg-green-200">Paid/Done</button></td>
                    <td class="text-center no-print">${deleteBtn}</td>
                `;
            }
            tbody.appendChild(row);
        }

        function addDueRow(type) {
            let name, amount, notes, date;
            
            if (type === 'customer') {
                name = prompt("Customer Name:");
                if (!name) return;
                amount = prompt("Amount (OMR):");
                notes = prompt("Notes (Optional):");
            } else if (type === 'payable') {
                name = prompt("Pay To (Name):");
                if (!name) return;
                amount = prompt("Amount (OMR):");
                date = prompt("Due Date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
            } else if (type === 'bank') {
                name = prompt("Bank Name / Details:");
                if (!name) return;
                amount = prompt("Deposit Amount (OMR):");
                date = new Date().toISOString().split('T')[0];
            }

            if (!amount) return;

            const data = getDueData();
            const newItem = {
                id: Date.now(),
                type,
                name,
                amount: parseFloat(amount),
                notes,
                date,
                status: 'Pending', // For cust/payable
                phone: '' // Optional
            };
            
            logSystemActivity('create', 'due', `Added ${type}: ${name} (${amount})`);
            data.push(newItem);
            localStorage.setItem(STORAGE_DUE, JSON.stringify(data));
            loadDueData();
        }

        function toggleDueStatus(id) {
            const data = getDueData();
            const item = data.find(i => i.id === id);
            if (item) {
                if (item.status === 'Paid') {
                    item.status = 'Pending';
                    item.paidDate = null;
                } else {
                    item.status = 'Paid';
                    item.paidDate = new Date().toISOString().split('T')[0];
                }
                localStorage.setItem(STORAGE_DUE, JSON.stringify(data));
                loadDueData();
            }
        }

        function deleteDue(id) {
            if(!confirm("Delete this entry?")) return;
            const data = getDueData();
            const index = data.findIndex(i => i.id === id);
            if(index > -1) {
                const item = data[index];
                logSystemActivity('delete', 'due', `Deleted ${item.type}: ${item.name}`, null, null, item);
                data.splice(index, 1);
                localStorage.setItem(STORAGE_DUE, JSON.stringify(data));
                loadDueData();
            }
        }
        
        function setDueView(mode) {
            dueViewMode = mode;
            loadDueData();
        }

        // --- EXPENSE FUNCTIONS ---
        function loadExpense() {
            const data = getExpenseData();
            const filterMonth = document.getElementById('expense-month-filter').value;
            const tbody = document.getElementById('expense-table-body');
            tbody.innerHTML = '';
            
            let tOffice = 0, tPersonal = 0;

            const filtered = data.filter(item => !filterMonth || item.date.startsWith(filterMonth));
            filtered.sort((a,b) => new Date(b.date) - new Date(a.date));

            filtered.forEach(item => {
                const amt = parseFloat(item.amount) || 0;
                if (item.type === 'Office') tOffice += amt;
                else tPersonal += amt;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-xs text-gray-500">${item.date}</td>
                    <td class="font-medium text-gray-800">${item.desc}</td>
                    <td class="text-center"><span class="px-2 py-0.5 rounded text-[10px] uppercase font-bold ${item.type==='Office'?'bg-blue-100 text-blue-700':'bg-purple-100 text-purple-700'}">${item.type}</span></td>
                    <td class="font-bold text-red-600 font-mono">${amt.toFixed(3)}</td>
                    <td class="text-center no-print"><button onclick="deleteExpense(${item.id})" class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('exp-total-office').textContent = tOffice.toFixed(3);
            document.getElementById('exp-total-personal').textContent = tPersonal.toFixed(3);
            document.getElementById('exp-total-grand').textContent = (tOffice + tPersonal).toFixed(3);
            lucide.createIcons();
        }

        function addExpenseEntry() {
            const date = document.getElementById('exp-date').value;
            const desc = document.getElementById('exp-desc').value;
            const type = document.getElementById('exp-type').value;
            const amount = document.getElementById('exp-amount').value;

            if(!desc || !amount) return;

            const data = getExpenseData();
            const item = { id: Date.now(), date, desc, type, amount };
            data.push(item);
            
            logSystemActivity('create', 'expense', `Added Expense: ${desc} (${amount})`);
            localStorage.setItem(STORAGE_EXPENSE, JSON.stringify(data));
            
            document.getElementById('exp-desc').value = '';
            document.getElementById('exp-amount').value = '';
            loadExpense();
        }

        function deleteExpense(id) {
            if(!confirm("Delete expense?")) return;
            const data = getExpenseData();
            const index = data.findIndex(i => i.id === id);
            if(index > -1) {
                const item = data[index];
                logSystemActivity('delete', 'expense', `Deleted Expense: ${item.desc}`, null, null, item);
                data.splice(index, 1);
                localStorage.setItem(STORAGE_EXPENSE, JSON.stringify(data));
                loadExpense();
            }
        }

        // --- NOTES / TASKS FUNCTIONS ---
        function loadNotes() {
            const data = getNotes();
            const list = document.getElementById('notes-list');
            if(!list) return;
            list.innerHTML = '';
            
            data.forEach((note, index) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-gray-50 p-3 rounded border border-gray-200";
                li.innerHTML = `
                    <span class="text-sm font-medium text-gray-700">${note.text}</span>
                    <button onclick="deleteNote(${index})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                list.appendChild(li);
            });
            lucide.createIcons();
        }

        function addNote() {
            const inp = document.getElementById('note-input');
            const text = inp.value;
            if(!text) return;
            
            const data = getNotes();
            const item = { id: Date.now(), text, date: new Date().toISOString() };
            data.push(item);
            logSystemActivity('create', 'notes', `Added Task: ${text}`);
            
            localStorage.setItem(STORAGE_NOTES, JSON.stringify(data));
            inp.value = '';
            loadNotes();
        }

        function deleteNote(index) {
            const data = getNotes();
            const item = data[index];
            logSystemActivity('delete', 'notes', `Deleted Task: ${item.text}`, null, null, item);
            data.splice(index, 1);
            localStorage.setItem(STORAGE_NOTES, JSON.stringify(data));
            loadNotes();
        }

        // --- SALAMAIR REMINDER FUNCTIONS ---
        function loadSalamReminders() {
            const data = getSalamReminders();
            const activeList = document.getElementById('salam-active-list');
            const historyList = document.getElementById('salam-history-list');
            if(!activeList || !historyList) return;
            
            activeList.innerHTML = '';
            historyList.innerHTML = '';
            
            let activeCount = 0;
            const today = new Date();
            today.setHours(0,0,0,0);

            // Sort by Date Ascending
            data.sort((a,b) => new Date(a.date) - new Date(b.date));

            data.forEach(item => {
                const fDate = new Date(item.date);
                fDate.setHours(0,0,0,0);
                
                // Determine if history (flight passed)
                const isHistory = fDate < today;
                
                const row = document.createElement('tr');
                row.className = isHistory ? "bg-gray-50" : "bg-white border-l-4 border-green-500";
                
                const dateDisplay = fDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                
                row.innerHTML = `
                    <td class="text-xs font-bold ${isHistory?'text-gray-500':'text-green-700'}">${dateDisplay}</td>
                    <td class="font-mono text-xs font-bold">${item.pnr}</td>
                    <td class="font-bold text-gray-800 text-sm">${item.name}</td>
                    <td class="text-xs text-gray-500 italic">${item.remark || '-'}</td>
                    <td class="text-center">
                        <button onclick="deleteSalam(${item.id})" class="p-1 text-red-400 hover:text-red-600 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                `;

                if(isHistory) {
                    historyList.appendChild(row);
                } else {
                    activeList.appendChild(row);
                    activeCount++;
                }
            });
            
            const emptyMsg = document.getElementById('salam-empty');
            if(emptyMsg) emptyMsg.style.display = activeCount === 0 ? 'block' : 'none';
            
            updateDashboardCheckins(); // Also update dashboard alerts
            lucide.createIcons();
        }

        function addSalamReminder() {
            const pnr = document.getElementById('salam-pnr').value;
            const name = document.getElementById('salam-name').value;
            const date = document.getElementById('salam-date').value;
            const remark = document.getElementById('salam-remark').value;
            
            if(!pnr || !name || !date) return alert("Fill required fields");

            const data = getSalamReminders();
            const item = { id: Date.now(), pnr, name, date, remark };
            data.push(item);
            
            logSystemActivity('create', 'salam', `Added Check-in: ${name} (${pnr})`);
            localStorage.setItem(STORAGE_SALAM, JSON.stringify(data));
            
            // Clear Form
            document.getElementById('salam-pnr').value = '';
            document.getElementById('salam-name').value = '';
            document.getElementById('salam-remark').value = '';
            
            loadSalamReminders();
        }

        function deleteSalam(id) {
            if(!confirm("Remove this check-in reminder?")) return;
            const data = getSalamReminders();
            const index = data.findIndex(i => i.id === id);
            if(index > -1) {
                const item = data[index];
                logSystemActivity('delete', 'salam', `Deleted Check-in: ${item.name}`, null, null, item);
                data.splice(index, 1);
                localStorage.setItem(STORAGE_SALAM, JSON.stringify(data));
                loadSalamReminders();
            }
        }

        function toggleSalamHistory() {
            const el = document.getElementById('salam-history-container');
            el.classList.toggle('hidden');
        }

        // --- BACKUP & RESTORE ---
        function backupData() {
            const data = {
                hisab: getHisabData(),
                due: getDueData(),
                expense: getExpenseData(),
                notes: getNotes(),
                salam: getSalamReminders(),
                invoices: {}, // Collect invoices
                logs: JSON.parse(localStorage.getItem(STORAGE_LOG) || '[]')
            };
            
            // Backup invoices
            for (let i = 0; i < localStorage.length; i++){
                const key = localStorage.key(i);
                if (key.startsWith(STORAGE_PREFIX)) {
                    data.invoices[key] = localStorage.getItem(key);
                }
            }

            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `holiday_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.hisab) localStorage.setItem(STORAGE_HISAB, JSON.stringify(data.hisab));
                    if (data.due) localStorage.setItem(STORAGE_DUE, JSON.stringify(data.due));
                    if (data.expense) localStorage.setItem(STORAGE_EXPENSE, JSON.stringify(data.expense));
                    if (data.notes) localStorage.setItem(STORAGE_NOTES, JSON.stringify(data.notes));
                    if (data.salam) localStorage.setItem(STORAGE_SALAM, JSON.stringify(data.salam));
                    if (data.logs) localStorage.setItem(STORAGE_LOG, JSON.stringify(data.logs));
                    
                    if (data.invoices) {
                        for (const key in data.invoices) {
                            localStorage.setItem(key, data.invoices[key]);
                        }
                    }
                    alert("Data Restored Successfully!");
                    location.reload();
                } catch (err) {
                    alert("Invalid Backup File");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }
        
        // --- EXPORT TO EXCEL (CSV) ---
        function exportHisab(mode) {
             const data = getHisabData();
             const filterMonth = document.getElementById('hisab-month-filter').value;
             const filtered = mode === 'month' ? data.filter(item => !filterMonth || item.date.startsWith(filterMonth)) : data;
             
             let csvContent = "data:text/csv;charset=utf-8,Date,Name,PNR,Flight Date,Sector,Net,Sell,Profit,Remark\n";
             filtered.forEach(row => {
                 const profit = (parseFloat(row.sell) - parseFloat(row.net)).toFixed(3);
                 csvContent += `${row.date},${row.name},${row.pnr},${row.flight_date},${row.sector},${row.net},${row.sell},${profit},${row.remark}\n`;
             });
             
             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", `ticketing_report_${filterMonth||'all'}.csv`);
             document.body.appendChild(link);
             link.click();
        }

        function exportExpense() {
             const data = getExpenseData();
             const filterMonth = document.getElementById('expense-month-filter').value;
             const filtered = data.filter(item => !filterMonth || item.date.startsWith(filterMonth));
             
             let csvContent = "data:text/csv;charset=utf-8,Date,Description,Type,Amount\n";
             filtered.forEach(row => {
                 csvContent += `${row.date},${row.desc},${row.type},${row.amount}\n`;
             });
             
             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", `expense_report_${filterMonth||'all'}.csv`);
             document.body.appendChild(link);
             link.click();
        }

        // --- INVOICE LOGIC ---
        const invoiceNumberElement = document.getElementById('invoice-number');
        
        function setupAutoClear(id, defaultText) {
            const el = document.getElementById(id);
            if(!el) return;
            el.addEventListener('focus', () => { if(el.innerText.trim() === defaultText) el.innerText = ''; });
            el.addEventListener('blur', () => { if(el.innerText.trim() === '') el.innerText = defaultText; });
        }
        setupAutoClear('customer-name', 'Customer Name');
        setupAutoClear('customer-phone', 'Phone Number');

        // --- NEW INVOICE ID LOGIC ---
        function getTodayPrefix() {
            const today = new Date();
            const yy = String(today.getFullYear()).slice(-2);
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yy}${mm}${dd}`;
        }

        function calculateNextInvoiceId() {
            const prefix = getTodayPrefix();
            // Get raw string to preserve format
            const lastId = localStorage.getItem(STORAGE_KEY_COUNTER); 
            
            // Check if last stored ID belongs to today
            if (lastId && String(lastId).startsWith(prefix)) {
                const suffix = String(lastId).substring(prefix.length);
                const nextSeq = parseInt(suffix, 10) + 1;
                return `${prefix}${nextSeq}`;
            } else {
                // New day or first run with new format
                return `${prefix}1`;
            }
        }

        function setInvoiceNumberDisplay(num) { 
            if(invoiceNumberElement) invoiceNumberElement.textContent = num; 
        }
        
        function initializeInvoiceNumber() {
            const nextId = calculateNextInvoiceId();
            setInvoiceNumberDisplay(nextId);
        }

        function setTodayDate() {
            const today = new Date();
            const d = String(today.getDate()).padStart(2, '0');
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const y = today.getFullYear();
            
            const invDate = document.getElementById('invoice-date');
            if(invDate) invDate.textContent = `${d}/${m}/${y}`;
            
            const monthStr = `${y}-${m}`;
            const monthFilter = document.getElementById('hisab-month-filter');
            if(monthFilter) monthFilter.value = monthStr;
            const expMonthFilter = document.getElementById('expense-month-filter');
            if(expMonthFilter) expMonthFilter.value = monthStr;

            const hDate = document.getElementById('h-date');
            if(hDate) hDate.valueAsDate = today;
            const expDate = document.getElementById('exp-date');
            if(expDate) expDate.valueAsDate = today;
            const salamDate = document.getElementById('salam-date');
            if(salamDate) salamDate.valueAsDate = today; 
        }

        function resetInvoiceDate() {
            const today = new Date();
            const d = String(today.getDate()).padStart(2, '0');
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const invDate = document.getElementById('invoice-date');
            if(invDate) invDate.textContent = `${d}/${m}/${today.getFullYear()}`;
        }

        const itemsTableBody = document.getElementById('items-table-body');

        window.calculateTotal = () => {
            let subtotal = 0;
            document.querySelectorAll('.item-amount').forEach(el => {
                subtotal += parseFloat(el.innerText.replace(/[^0-9.-]+/g,"")) || 0;
            });
            const sub = document.getElementById('subtotal');
            const tot = document.getElementById('total');
            if(sub) sub.textContent = subtotal.toFixed(3);
            if(tot) tot.textContent = subtotal.toFixed(3);
        };

        window.addRow = (desc = "DHAKA TO SALALAH", price = "0.000") => {
            const tbody = document.getElementById('items-table-body');
            if(!tbody) return;

            const newRow = document.createElement('tr');
            newRow.className = 'item-row border-b border-gray-100 hover:bg-gray-50';
            newRow.innerHTML = `
                <td class="p-3 align-top"><div class="flex flex-col gap-1"><span contenteditable="true" class="item-desc editable w-full block font-medium text-gray-800" data-placeholder="Description">${desc}</span></div></td>
                <td class="p-3 align-top text-right"><span contenteditable="true" class="item-amount editable w-full block text-right font-mono text-lg text-gray-700">${price}</span></td>
                <td class="p-3 text-center no-print align-middle"><button onclick="window.deleteRow(this)" class="delete-row text-red-400 hover:text-red-600 font-bold p-1 rounded hover:bg-red-50"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
            `;
            tbody.appendChild(newRow);
            lucide.createIcons();
            
            const amountCell = newRow.querySelector('.item-amount');
            const descCell = newRow.querySelector('.item-desc');
            [amountCell, descCell].forEach(cell => cell.addEventListener('input', window.calculateTotal));
            amountCell.addEventListener('blur', (e) => {
                const val = parseFloat(e.target.innerText.replace(/[^0-9.-]+/g,"")) || 0;
                e.target.innerText = val.toFixed(3);
                window.calculateTotal();
            });
            descCell.addEventListener('focus', function() { if (this.innerText.includes("DHAKA TO SALALAH")) this.innerText = ""; });
            window.calculateTotal();
        };
        
        window.deleteRow = (btn) => { btn.closest('tr').remove(); window.calculateTotal(); };

        function showMessage(text, type = 'success') {
            const msg = document.getElementById('system-message');
            if(!msg) { console.log(text); return; }
            msg.textContent = text;
            msg.className = type === 'error' ? 'text-red-500 font-bold ml-4 hidden' : 'text-sm font-bold text-blue-600 ml-4';
            msg.classList.remove('hidden');
            setTimeout(() => { msg.classList.add('hidden'); }, 3000);
        }

        window.saveInvoice = function() {
            if(!invoiceNumberElement) return;
            const id = parseInt(invoiceNumberElement.textContent, 10);
            const dateStr = document.getElementById('invoice-date').innerText;
            const custName = document.getElementById('customer-name').innerText;
            const phoneText = document.getElementById('customer-phone').innerText;
            const phone = (phoneText === "Phone Number") ? "" : phoneText;
            
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                items.push({ desc: row.querySelector('.item-desc').innerText, amount: row.querySelector('.item-amount').innerText });
            });

            const paidEl = document.getElementById('paid-toggle');
            const data = {
                id: id, date: dateStr, customerName: custName,
                customerPhone: phone,
                items: items, paid: paidEl ? paidEl.checked : false
            };
            localStorage.setItem(STORAGE_PREFIX + id, JSON.stringify(data));
            
            let currentHigh = parseInt(localStorage.getItem(STORAGE_KEY_COUNTER) || 0, 10);
            if (id > currentHigh) localStorage.setItem(STORAGE_KEY_COUNTER, id);

            // Auto-Add Invoice to Ledger with Safe Date Parsing
            const totEl = document.getElementById('total');
            const totalAmount = totEl ? parseFloat(totEl.textContent) : 0;
            if (totalAmount > 0) {
                let isoDate = new Date().toISOString().split('T')[0]; // Default to today
                
                try {
                    // Try parsing DD/MM/YYYY
                    if (dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                             // Check if valid numbers
                             if (!isNaN(parts[0]) && !isNaN(parts[1]) && !isNaN(parts[2])) {
                                 isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                             }
                        }
                    }
                } catch(e) { console.log("Date parse error, using today"); }

                addHisabTransaction({
                    date: isoDate,
                    name: custName === "Customer Name" ? "Walk-in" : custName,
                    pnr: '',
                    flight_date: '',
                    sector: items[0]?.desc || 'Invoice',
                    phone: phone,
                    net: 0, 
                    sell: totalAmount,
                    due: 0,
                    invoiceId: id
                });
            }
            alert(`Invoice #${id} Saved & Added to Ledger!`);
        }

        window.searchInvoice = function() {
            const term = document.getElementById('search-input').value;
            if (!term) return alert('Enter a number');
            const dataStr = localStorage.getItem(STORAGE_PREFIX + parseInt(term, 10));
            if (!dataStr) return alert('Invoice Not Found');
            
            try {
                const data = JSON.parse(dataStr);
                setInvoiceNumberDisplay(data.id);
                document.getElementById('invoice-date').innerText = data.date;
                document.getElementById('customer-name').innerText = data.customerName;
                document.getElementById('customer-phone').innerText = data.customerPhone || "Phone Number";
                
                const paidEl = document.getElementById('paid-toggle');
                if(paidEl) {
                    paidEl.checked = data.paid;
                    window.togglePaidStamp();
                }
                
                const tbody = document.getElementById('items-table-body');
                if(tbody) {
                    tbody.innerHTML = ''; // Clear existing rows
                    if(data.items && data.items.length > 0) {
                         data.items.forEach(item => window.addRow(item.desc, item.amount));
                    } else {
                         window.addRow();
                    }
                }
            } catch(e) {
                alert("Error loading invoice data");
                console.error(e);
            }
        }
        
        window.resetSearch = function() {
            document.getElementById('search-input').value = '';
            window.generateNewInvoice();
        }

        window.generateNewInvoice = function() {
            const nextId = calculateNextInvoiceId();
            setInvoiceNumberDisplay(nextId);
            resetInvoiceDate(); 
            document.getElementById('customer-name').innerText = "Customer Name";
            document.getElementById('customer-phone').innerText = "Phone Number";
            const paidEl = document.getElementById('paid-toggle');
            if(paidEl) {
                paidEl.checked = false;
                window.togglePaidStamp();
            }
            document.getElementById('search-input').value = '';
            
            const tbody = document.getElementById('items-table-body');
            if(tbody) tbody.innerHTML = '';
            
            window.addRow("DHAKA TO SALALAH", "0.000");
        }

        window.togglePaidStamp = function() {
            const paidEl = document.getElementById('paid-toggle');
            const stamp = document.getElementById('paid-watermark');
            if (paidEl && paidEl.checked) {
                if(stamp) {
                    stamp.classList.add('is-visible');
                    stamp.style.display = 'block';
                }
            } else {
                if(stamp) {
                    stamp.classList.remove('is-visible');
                    stamp.style.display = 'none';
                }
            }
        }

        // --- APP INITIALIZATION ---
        // Run these functions when the script loads to ensure state is correct
        setTodayDate();
        initializeInvoiceNumber();
        if(itemsTableBody && itemsTableBody.children.length === 0) addRow();
        
        // ** FIX: Force update dashboard on load so charts appear immediately **
        updateDashboard(); 
        // Load notes for dashboard
        loadNotes();
        // ** ADDED: Force SalamAir data load **
        loadSalamReminders();

    </script>
</body>
</html>