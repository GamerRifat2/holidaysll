<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Travels - Cloud Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; transition: background-color 0.3s, color 0.3s; }
        .arabic-text { font-family: 'Cairo', sans-serif; direction: rtl; }
        
        body.dark { background-color: #111827; color: #e5e7eb; }
        body.dark .bg-white { background-color: #1f2937; border-color: #374151; color: #e5e7eb; }
        body.dark .bg-gray-50 { background-color: #111827; border-color: #374151; }
        body.dark input, body.dark select, body.dark textarea { background-color: #374151; color: white; border-color: #4b5563; }
        body.dark .text-gray-800 { color: #f3f4f6; }
        body.dark .text-gray-600 { color: #9ca3af; }
        body.dark .excel-table th { background-color: #374151; color: #e5e7eb; border-color: #4b5563; }
        body.dark .excel-table td { border-color: #4b5563; }

        body.dark #global-header { background-color: white !important; border-color: #e5e7eb !important; }
        body.dark #global-header .text-gray-800 { color: #1f2937 !important; } 

        .invoice-paper {
            max-width: 210mm; min-height: 297mm; margin: 0 auto; padding: 2rem;
            background-color: white; color: black; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; position: relative;
        }
        body.dark .invoice-paper { background-color: white; color: black; }
        body.dark .invoice-paper div[contenteditable="true"] { outline: none; }
        body.dark .invoice-paper div[contenteditable="true"]:focus { background-color: #f3f4f6; border-radius: 4px; }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .excel-table { border-collapse: collapse; width: 100%; font-size: 11px; } 
        .excel-table th, .excel-table td { border: 1px solid #d1d5db; padding: 6px 4px; }
        .excel-table th { background-color: #f3f4f6; font-weight: 700; text-align: center; white-space: nowrap; }
        .excel-table tr:nth-child(even) { background-color: #f9fafb; }
        .excel-table tr:hover { background-color: #eff6ff; cursor: pointer; }
        .row-selected { background-color: #fff7ed !important; border-left: 3px solid #f97316; }

        .paid-seal { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            border: 0.4rem solid #22c55e; border-radius: 0.8rem; padding: 0.5rem 2rem;
            text-align: center; opacity: 0; pointer-events: none; z-index: 50; transition: opacity 0.3s ease;
            color: #22c55e; background-color: rgba(255, 255, 255, 0.9); box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;
        }
        .paid-seal.is-visible { opacity: 0.4 !important; display: block !important; }

        .print-only-header { display: none; }

        @media print {
            @page { margin: 0; size: A4 landscape; } 
            .no-print, .tabs-nav, #global-header, #login-screen { display: none !important; }
            .invoice-paper { box-shadow: none; margin: 0; width: 100%; padding: 5mm; min-height: auto; height: auto; }
            .tab-content { display: none !important; }
            .tab-content.active { display: block !important; }
            body { background: white !important; color: black !important; }
            
            #tab-due.active .print-only-header { 
                display: flex !important; 
                justify-content: space-between; 
                align-items: center; 
                border-bottom: 2px solid #333; 
                margin-bottom: 20px; 
                padding-bottom: 10px;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- CLOUD STATUS INDICATOR -->
    <div id="cloud-sync-indicator" class="fixed bottom-4 right-4 z-[100] flex items-center gap-2 bg-gray-900 text-white px-3 py-1.5 rounded-full text-[10px] font-bold shadow-lg opacity-0 transition-opacity duration-500">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        <span>CLOUD SYNCED</span>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-gray-100 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center border border-gray-200">
            <div class="mb-6 flex justify-center"><img src="LOGO.png" alt="Holiday Travels" class="h-24 w-auto object-contain"></div>
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Login Required</h2>
            <p class="text-gray-500 mb-6 text-sm">Access the cloud management system.</p>
            <input type="password" id="password-input" placeholder="Passcode" class="w-full p-3 border border-gray-200 rounded-lg mb-4 text-center text-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <button id="login-btn" onclick="attemptLogin()" class="w-full bg-gray-900 text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition-all shadow-lg">Login & Sync</button>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden font-medium">Incorrect Code</p>
        </div>
    </div>

    <div class="max-w-[1300px] mx-auto mt-6 px-4 mb-4"> 
        
        <!-- GLOBAL HEADER -->
        <div id="global-header" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <img id="header-logo-img" src="LOGO.png" alt="Holiday Travels" class="h-12 w-auto object-contain">
                <div class="h-8 w-px bg-gray-200 hidden md:block"></div>
                <div>
                    <h1 class="text-sm font-bold uppercase tracking-tighter">Holiday Travels Cloud</h1>
                    <p id="cloud-status" class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">CONNECTING...</p>
                </div>
            </div>
            <div class="flex gap-2 items-center">
                <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="moon" class="w-5 h-5 text-gray-600 dark:hidden"></i><i data-lucide="sun" class="w-5 h-5 text-yellow-400 hidden dark:block"></i></button>
                <button onclick="exportFullBackup()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> Backup</button>
                <label class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 flex items-center gap-2 cursor-pointer"><i data-lucide="upload" class="w-4 h-4"></i> Restore<input type="file" class="hidden" onchange="restoreBackup(this)" accept=".json"></label>
            </div>
        </div>

        <!-- NAVIGATION TABS -->
        <div class="tabs-nav flex gap-2 mb-6 bg-white p-2 rounded-xl shadow-sm border border-gray-200 no-print overflow-x-auto">
            <button onclick="switchTab('dashboard')" id="btn-tab-dashboard" class="tab-btn flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all bg-gray-900 text-white shadow-md"><i data-lucide="bar-chart-3" class="w-4 h-4"></i> Dashboard</button>
            <button onclick="switchTab('hisab')" id="btn-tab-hisab" class="tab-btn flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50"><i data-lucide="plane" class="w-4 h-4"></i> Ticketing</button>
            <button onclick="switchTab('due')" id="btn-tab-due" class="tab-btn flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50"><i data-lucide="wallet" class="w-4 h-4"></i> Due & Bank</button>
            <button onclick="switchTab('notes')" id="btn-tab-notes" class="tab-btn flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50"><i data-lucide="clipboard-list" class="w-4 h-4"></i> Notes & Check-in</button>
            <button onclick="switchTab('expense')" id="btn-tab-expense" class="tab-btn flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50"><i data-lucide="calculator" class="w-4 h-4"></i> Expenses</button>
            <button onclick="switchTab('invoice')" id="btn-tab-invoice" class="tab-btn flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50"><i data-lucide="file-text" class="w-4 h-4"></i> Invoice</button>
        </div>

        <!-- TAB: DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div id="dashboard-alerts" class="p-6 pb-0 hidden"></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6">
                    <div class="bg-green-50 p-6 rounded-2xl border border-green-100 text-center">
                        <p class="text-xs font-bold text-green-600 uppercase tracking-widest">Yearly Sales</p>
                        <p id="dash-total-sell" class="text-3xl font-black text-gray-800">0.000</p>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 text-center">
                        <p class="text-xs font-bold text-blue-600 uppercase tracking-widest">Yearly Profit</p>
                        <p id="dash-total-profit" class="text-3xl font-black text-gray-800">0.000</p>
                    </div>
                    <div class="bg-orange-50 p-6 rounded-2xl border border-orange-100 text-center">
                        <p class="text-xs font-bold text-orange-600 uppercase tracking-widest">Outstanding Due</p>
                        <p id="dash-total-due" class="text-3xl font-black text-gray-800">0.000</p>
                    </div>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-gray-100">
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><h3 class="text-lg font-bold mb-4 text-gray-700">Monthly Sales vs Cost</h3><canvas id="salesChart" height="250"></canvas></div>
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><h3 class="text-lg font-bold mb-4 text-gray-700">Monthly Profit Trend</h3><canvas id="profitChart" height="250"></canvas></div>
                </div>
            </div>
        </div>

        <!-- TAB: TICKETING LEDGER -->
        <div id="tab-hisab" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 bg-gray-50 border-b flex justify-between items-center no-print">
                    <div class="flex items-center gap-2">
                        <h2 class="text-lg font-bold flex items-center gap-2"><i data-lucide="plane" class="text-blue-600"></i> Ticketing Ledger</h2>
                        <input type="month" id="hisab-month-filter" class="p-1 border rounded text-sm font-bold" onchange="renderHisab()">
                    </div>
                    <button onclick="window.print()" class="bg-gray-800 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-gray-700 flex items-center gap-1"><i data-lucide="printer" class="w-3 h-3"></i> Print</button>
                </div>
                <div class="p-6 border-b no-print">
                    <form onsubmit="handleHisabSubmit(event)" id="hisab-form" class="grid grid-cols-2 md:grid-cols-5 lg:grid-cols-10 gap-2 items-end">
                        <input type="hidden" id="h-id">
                        <div class="col-span-1"><label class="text-[10px] font-bold text-gray-400 uppercase">Date</label><input type="date" id="h-date" class="w-full p-1.5 border rounded text-xs"></div>
                        <div class="col-span-2"><label class="text-[10px] font-bold text-gray-400 uppercase">Passenger Name</label><input type="text" id="h-name" class="w-full p-1.5 border rounded text-xs" placeholder="Passenger Name" required></div>
                        <div class="col-span-1"><label class="text-[10px] font-bold text-gray-400 uppercase">PNR</label><input type="text" id="h-pnr" class="w-full p-1.5 border rounded text-xs font-mono uppercase"></div>
                        <div class="col-span-1"><label class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">Flight Date</label><input type="date" id="h-fdate" class="w-full p-1.5 border rounded text-xs"></div>
                        <div class="col-span-1"><label class="text-[10px] font-bold text-gray-400 uppercase">Sector</label><input type="text" id="h-sector" class="w-full p-1.5 border rounded text-xs" placeholder="DXB-MCT"></div>
                        <div class="col-span-1"><label class="text-[10px] font-bold text-red-600 uppercase">Cost</label><input type="number" step="0.001" id="h-net" class="w-full p-1.5 border border-red-100 rounded text-xs" required></div>
                        <div class="col-span-1"><label class="text-[10px] font-bold text-green-600 uppercase">Sale</label><input type="number" step="0.001" id="h-sell" class="w-full p-1.5 border border-green-100 rounded text-xs" required></div>
                        <div class="col-span-1"><label class="text-[10px] font-bold text-orange-500 uppercase">Due</label><input type="number" step="0.001" id="h-due" class="w-full p-1.5 border border-orange-100 rounded text-xs"></div>
                        <div class="col-span-1 flex gap-1">
                            <button id="hisab-submit-btn" class="flex-grow bg-blue-600 text-white py-2 rounded text-xs font-bold mt-4">ADD</button>
                            <button type="button" onclick="resetHisabForm()" class="bg-gray-100 text-gray-400 px-2 rounded mt-4">X</button>
                        </div>
                    </form>
                </div>
                <div class="p-6 overflow-x-auto">
                    <div class="grid grid-cols-4 gap-0 mb-4 border border-gray-300 text-center text-xs font-bold bg-gray-50">
                        <div class="p-2 border-r border-gray-300 text-red-700">Total Net: <span id="tot-net">0.000</span></div>
                        <div class="p-2 border-r border-gray-300 text-green-700">Total Sell: <span id="tot-sell">0.000</span></div>
                        <div class="p-2 border-r border-gray-300 text-blue-800">Total Profit: <span id="tot-profit">0.000</span></div>
                        <div class="p-2 text-orange-600">Total Due: <span id="tot-due">0.000</span></div>
                    </div>
                    <table class="excel-table">
                        <thead><tr><th>DATE</th><th>PASSENGER</th><th>PNR</th><th>FLIGHT</th><th>NET</th><th>SELL</th><th>PROFIT</th><th>SECTOR</th><th>DUE</th><th class="no-print"></th></tr></thead>
                        <tbody id="hisab-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: DUE & BANK TRACKER -->
        <div id="tab-due" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="print-only-header hidden">
                    <img src="LOGO.png" class="h-20 object-contain">
                    <div class="text-right">
                        <h1 class="font-bold text-xl">HOLIDAY TRAVELS</h1>
                        <p class="text-xs">NEAR PAK MOSJID SALALAH</p>
                        <p class="text-xs">Salalah, Sultanate of Oman</p>
                        <p class="text-xs font-bold">Phone: 78594007</p>
                    </div>
                </div>

                <div class="p-6 bg-gray-50 border-b flex flex-col gap-4 no-print">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="wallet" class="text-blue-600"></i> Due & Banking Cloud</h2>
                        <button onclick="window.print()" class="bg-gray-800 text-white px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 hover:bg-gray-700"><i data-lucide="printer" class="w-3 h-3"></i> Print Statement</button>
                    </div>
                    <div class="flex justify-center">
                        <div class="bg-gray-200 p-1 rounded-lg flex gap-1">
                            <button onclick="setDueView('active')" id="btn-due-active" class="px-6 py-1.5 rounded-md text-sm font-bold bg-white text-gray-800 shadow-sm transition-all">Active / Pending</button>
                            <button onclick="setDueView('history')" id="btn-due-history" class="px-6 py-1.5 rounded-md text-sm font-bold text-gray-600 hover:bg-gray-300 transition-all">History / Paid</button>
                        </div>
                    </div>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 bg-white border-b">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-center"><p class="text-[10px] font-bold text-blue-400 uppercase">Receivable</p><p id="due-sum-receive" class="text-2xl font-black">0.000</p></div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100 text-center"><p class="text-[10px] font-bold text-red-400 uppercase">Payable</p><p id="due-sum-pay" class="text-2xl font-black">0.000</p></div>
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100 text-center"><p class="text-[10px] font-bold text-green-400 uppercase">Bank Balance</p><p id="due-sum-bank" class="text-2xl font-black">0.000</p></div>
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100 text-center"><p class="text-[10px] font-bold text-purple-400 uppercase">Projected Net</p><p id="due-sum-net" class="text-2xl font-black">0.000</p></div>
                </div>
                <div id="due-active-view" class="p-6 space-y-8">
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 border-b flex items-center gap-2"><i data-lucide="arrow-down-left" class="text-blue-500 w-4 h-4"></i> Customer Dues</h3>
                        <table class="excel-table w-full"><thead><tr><th>Name</th><th>Phone</th><th>Amount</th><th>Date</th><th>Status</th><th class="no-print"></th></tr></thead><tbody id="due-table-customer"></tbody></table>
                        <button onclick="addDueCloudRow('customer')" class="w-full mt-2 bg-blue-100 text-blue-700 text-xs font-bold py-2 rounded-lg border-2 border-dashed border-blue-300 no-print">+ Add Customer Due</button>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 border-b flex items-center gap-2"><i data-lucide="arrow-up-right" class="text-red-500 w-4 h-4"></i> My Payables</h3>
                        <table class="excel-table w-full"><thead><tr><th>Pay To</th><th>Amount</th><th>Pay Date</th><th>Status</th><th class="no-print"></th></tr></thead><tbody id="due-table-payable"></tbody></table>
                        <button onclick="addDueCloudRow('payable')" class="w-full mt-2 bg-red-100 text-red-700 text-xs font-bold py-2 rounded-lg border-2 border-dashed border-red-300 no-print">+ Add Payable</button>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 border-b flex items-center gap-2"><i data-lucide="landmark" class="text-green-600 w-4 h-4"></i> Bank Deposits</h3>
                        <table class="excel-table w-full"><thead><tr><th>Date</th><th>Details</th><th>Amount</th><th class="no-print"></th></tr></thead><tbody id="due-table-bank"></tbody></table>
                        <button onclick="addDueCloudRow('bank')" class="w-full mt-2 bg-green-100 text-green-700 text-xs font-bold py-2 rounded-lg border-2 border-dashed border-green-300 no-print">+ Add Deposit</button>
                    </div>
                </div>
                <div id="due-history-view" class="p-6 hidden">
                    <h3 class="font-bold text-gray-700 mb-2 flex items-center gap-2"><i data-lucide="history"></i> Paid Records History</h3>
                    <table class="excel-table w-full"><thead><tr><th>TYPE</th><th>NAME</th><th>AMOUNT</th><th>DATE</th><th class="no-print"></th></tr></thead><tbody id="due-table-history"></tbody></table>
                </div>
            </div>
        </div>

        <!-- TAB: NOTES & CHECK-IN -->
        <div id="tab-notes" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl border border-gray-200">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="check-square" class="text-indigo-600"></i> Office Tasks</h2>
                    <form onsubmit="addTask(event)" class="flex gap-2 mb-6"><input type="text" id="task-input" class="flex-grow p-3 border rounded-xl text-sm" placeholder="Add task..."><button class="bg-indigo-600 text-white px-6 rounded-xl font-bold">Add</button></form>
                    <ul id="task-list" class="space-y-2"></ul>
                </div>
                <div class="bg-white p-6 rounded-xl border border-gray-200">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-lg font-bold flex items-center gap-2"><i data-lucide="plane" class="text-green-600"></i> SalamAir Tracker</h2><button onclick="document.getElementById('salam-history-card').classList.toggle('hidden')" class="text-xs text-gray-400 underline">Show History</button></div>
                    <form onsubmit="addSalam(event)" class="space-y-2 mb-6">
                        <div class="grid grid-cols-2 gap-2"><input type="text" id="salam-pnr" class="p-2 border rounded text-sm uppercase font-mono" placeholder="PNR" required><input type="text" id="salam-name" class="p-2 border rounded text-sm" placeholder="Last Name" required></div>
                        <input type="date" id="salam-date" class="w-full p-2 border rounded text-sm" required>
                        <button class="w-full bg-green-600 text-white py-2 rounded font-bold text-sm">Track Check-in</button>
                    </form>
                    <div id="salam-active-list" class="space-y-2"></div>
                    <div id="salam-history-card" class="hidden mt-4 pt-4 border-t opacity-60"><h4 class="text-[10px] font-bold text-gray-400 mb-2 uppercase">Recent Check-ins</h4><div id="salam-history-list" class="space-y-2"></div></div>
                </div>
            </div>
        </div>

        <!-- TAB: EXPENSES -->
        <div id="tab-expense" class="tab-content">
            <div class="bg-white rounded-xl border p-6 overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="calculator" class="text-red-500"></i> Expense Hub</h2>
                    <input type="month" id="exp-month-filter" class="p-2 border rounded font-bold" onchange="renderExpenses()">
                </div>
                <form onsubmit="addExpense(event)" class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-6 bg-gray-50 p-4 rounded-xl border">
                    <input type="date" id="exp-date" class="p-2 border rounded text-sm"><input type="text" id="exp-desc" class="p-2 border rounded text-sm md:col-span-2" placeholder="Description"><input type="number" step="0.001" id="exp-amt" class="p-2 border rounded text-sm" placeholder="Amount"><button class="bg-red-600 text-white rounded font-bold">Add</button>
                </form>
                <div class="p-4 bg-red-50 rounded-xl mb-4 text-center border border-red-100"><p class="text-xs font-bold text-red-400 uppercase tracking-widest">Monthly Total</p><p id="exp-sum" class="text-3xl font-black">0.000</p></div>
                <table class="excel-table"><thead><tr><th>DATE</th><th>DESCRIPTION</th><th>AMOUNT</th><th class="no-print"></th></tr></thead><tbody id="expense-table-body"></tbody></table>
            </div>
        </div>

        <!-- TAB: INVOICE GENERATOR -->
        <div id="tab-invoice" class="tab-content">
            <div class="no-print bg-white p-4 rounded-xl border border-gray-200 mb-4 flex justify-between items-center flex-wrap gap-4">
                <div class="flex gap-2"><input type="number" id="search-invoice" placeholder="Invoice #" class="p-2 border rounded text-sm"><button onclick="loadInvoice()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm">Load Cloud</button></div>
                <div class="flex gap-3 items-center">
                    <label class="flex items-center gap-1 text-xs font-bold cursor-pointer text-gray-500 hover:text-green-600"><input type="checkbox" id="paid-toggle" onchange="togglePaidStamp()"> Mark as PAID</label>
                    <button onclick="resetInvoice()" class="bg-gray-100 px-4 py-2 rounded text-sm font-bold border">New</button>
                    <button onclick="saveInvoice()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold shadow-lg">Save Cloud</button>
                    <button onclick="window.print()" class="bg-green-600 text-white px-4 py-2 rounded font-bold">Print</button>
                </div>
            </div>
            <div class="invoice-paper" id="invoice-render">
                <div id="paid-watermark" class="paid-seal"><div class="text-5xl font-black uppercase">PAID</div><div class="text-3xl font-bold arabic-text mt-0">مدفوع</div></div>
                <header class="flex justify-between items-center pb-8 border-b-2">
                    <div class="w-1/3">
                        <h1 class="font-bold text-lg text-gray-800 leading-tight">HOLIDAY TRAVELS</h1>
                        <p class="text-xs text-gray-600 uppercase font-bold tracking-tighter">NEAR PAK MOSJID SALALAH</p>
                        <p class="text-xs text-gray-500">Salalah, Sultanate of Oman</p>
                        <p class="text-xs text-gray-500 mt-1 font-bold">Phone: 78594007</p>
                        <p class="text-[10px] text-gray-400">Email: HOLIDAYTRAVELS.OM@GMAIL.COM</p>
                    </div>
                    <div class="w-1/3 text-center"><img src="LOGO.png" class="h-24 mx-auto object-contain"></div>
                    <div class="w-1/3 text-right arabic-text">
                        <h2 class="text-2xl font-bold">سفريات هوليداي</h2>
                        <p class="text-sm">بالقرب من المسجد الباكستاني</p>
                        <p class="text-sm">صلالة، سلطنة عمان</p>
                        <p class="text-sm mt-1">هاتف: <span class="font-sans">78594007</span></p>
                        <p class="text-[10px] text-gray-400 font-sans">HOLIDAYTRAVELS.OM@GMAIL.COM</p>
                    </div>
                </header>
                <div class="flex justify-between items-center my-8">
                    <div class="flex flex-col"><span class="text-[10px] text-gray-400 font-bold uppercase">Invoice No</span><span id="inv-num" contenteditable="true" class="text-2xl font-bold font-mono">0001</span></div>
                    <div class="text-center font-black tracking-widest text-3xl opacity-20">INVOICE <span class="arabic-text font-normal text-xl">فاتورة</span></div>
                    <div class="flex flex-col text-right"><span class="text-[10px] text-gray-400 font-bold uppercase">Date</span><span id="inv-date" contenteditable="true" class="text-sm font-bold">01/01/2026</span></div>
                </div>
                <div class="bg-gray-50 p-6 rounded-2xl mb-8 border">
                    <div class="flex justify-between mb-4"><span class="text-[10px] font-bold text-gray-400 uppercase">Bill To</span><span class="text-[10px] font-bold text-gray-400 uppercase arabic-text">فاتورة إلى</span></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] text-gray-400 uppercase font-bold">Customer Name</label><div id="inv-client" contenteditable="true" class="text-lg font-bold border-b border-gray-200 py-1">Customer Name</div></div>
                        <div class="text-right"><label class="text-[10px] text-gray-400 uppercase font-bold">Phone</label><div id="inv-phone" contenteditable="true" class="text-lg font-mono py-1">968...</div></div>
                    </div>
                </div>
                <table class="w-full mb-10">
                    <thead><tr class="bg-gray-800 text-white text-[10px] uppercase font-bold tracking-widest">
                        <th class="p-4 text-left rounded-tl-lg rounded-bl-lg"><div class="flex justify-between"><span>Description</span><span class="arabic-text font-normal">تفاصيل</span></div></th>
                        <th class="p-4 text-right rounded-tr-lg rounded-br-lg" style="width: 150px;"><div class="flex flex-col items-end"><span>Amount (OMR)</span><span class="arabic-text text-[8px]">المبلغ</span></div></th>
                        <th class="w-8 no-print"></th>
                    </tr></thead>
                    <tbody id="inv-items"></tbody>
                </table>
                <button onclick="addInvRow()" class="no-print text-[10px] font-black text-blue-600 uppercase tracking-widest">+ Add Description</button>
                <div class="mt-auto pt-10 border-t flex justify-end">
                    <div class="w-72">
                        <div class="flex justify-between py-2 border-b"><span class="text-gray-400 text-xs font-bold uppercase">Subtotal</span><span id="inv-subtotal" class="font-bold">0.000</span></div>
                        <div class="flex justify-between items-center py-4 bg-gray-100 px-6 rounded-xl mt-4 border border-gray-200"><span class="text-xl font-black">TOTAL</span><span class="text-2xl font-black text-blue-800"><span id="inv-total">0.000</span> <span class="text-xs">OMR</span></span></div>
                    </div>
                </div>
                <footer class="mt-16 pt-8 border-t border-gray-100 flex justify-between items-end">
                    <div class="text-[9px] text-gray-400 space-y-1">
                        <p class="font-bold uppercase text-gray-600">Sajer Desert Rare Trading Company</p>
                        <p class="font-bold text-gray-600 arabic-text">شركة صحراء ساجر للتجارة النادرة</p>
                        <p>CR No: 1588173 | This copy is electronically generated</p>
                    </div>
                    <div class="opacity-30 grayscale"><img src="WHATSAPP.jpg" class="h-10 object-contain"></div>
                </footer>
            </div>
        </div>

    </div>

    <!-- FIREBASE & CORE ENGINE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // FALLBACK CONFIG FOR VERCEL
        const firebaseConfig = {
            apiKey: "AIzaSyArysNQse_b9nJsq7FctkUOxjUCQX46bKo",
            authDomain: "iday-travels.firebaseapp.com",
            projectId: "iday-travels",
            storageBucket: "iday-travels.firebasestorage.app",
            messagingSenderId: "145637577276",
            appId: "1:145637577276:web:5419bf357a2900a3d96939"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'holiday-travels-online-v3'; // Unique App ID

        window.cloudState = { ledger: [], dues: [], tasks: [], salam: [], expenses: [], counter: 9876 };
        window.currentTab = 'dashboard';
        let dueViewMode = 'active';

        // AUTHENTICATION
        const authenticate = async () => {
            try {
                // Check if session token exists or standard anonymously
                await signInAnonymously(auth);
            } catch (err) {
                console.error("Auth failed:", err);
            }
        };

        window.attemptLogin = async () => {
            const input = document.getElementById('password-input');
            const pass = input.value;
            if (pass === "96419161") {
                document.getElementById('login-screen').style.display = 'none';
                sessionStorage.setItem('holiday_authorized', 'true');
                await authenticate();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
                input.value = '';
                input.focus();
            }
        };

        // Keyboard Support for Login
        document.getElementById('password-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') window.attemptLogin();
        });

        // Check Session on Load
        if (sessionStorage.getItem('holiday_authorized') === 'true') {
            document.getElementById('login-screen').style.display = 'none';
            authenticate();
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('cloud-status').textContent = 'CLOUD ONLINE';
                document.getElementById('cloud-status').className = 'text-[10px] text-green-500 font-bold uppercase tracking-widest';
                startRealtimeSync();
            }
        });

        function startRealtimeSync() {
            const syncEl = document.getElementById('cloud-sync-indicator');
            const listen = (coll, key, renderer) => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', coll), (snap) => {
                    window.cloudState[key] = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if(renderer) renderer();
                    if(key === 'ledger' || key === 'dues' || key === 'salam') updateDashboard();
                    syncEl.style.opacity = '1';
                    setTimeout(() => syncEl.style.opacity = '0', 1000);
                }, (err) => console.error(err));
            };

            listen('ledger', 'ledger', renderHisab);
            listen('dues', 'dues', renderDues);
            listen('tasks', 'tasks', renderTasks);
            listen('salam', 'salam', renderSalam);
            listen('expenses', 'expenses', renderExpenses);
            
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), (snap) => {
                if(snap.exists()) {
                    window.cloudState.counter = snap.data().invoiceNum;
                    const el = document.getElementById('inv-num');
                    if(el && document.activeElement !== el) el.textContent = String(snap.data().invoiceNum).padStart(4, '0');
                }
            });
        }

        // CLOUD OPERATIONS
        window.cloudSave = async (coll, data) => {
            if (!auth.currentUser) return;
            const id = data.id || Date.now().toString();
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id), data);
        };
        window.cloudDelete = async (coll, id) => {
            if (!auth.currentUser) return;
            if(confirm("Permanently delete from cloud?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id));
        };

        // RENDER FUNCTIONS
        function renderHisab() {
            const tbody = document.getElementById('hisab-table-body');
            const month = document.getElementById('hisab-month-filter').value;
            const data = window.cloudState.ledger.filter(l => !month || l.date.startsWith(month)).sort((a,b) => b.id - a.id);
            
            tbody.innerHTML = data.map(i => `
                <tr onclick="editHisabRow('${i.id}')">
                    <td class="font-mono text-[10px]">${i.date}</td>
                    <td class="font-bold">${i.name}</td>
                    <td class="font-mono text-[10px] uppercase">${i.pnr || '-'}</td>
                    <td class="text-gray-400 text-[10px]">${i.fdate || '-'}</td>
                    <td class="text-right text-red-500">${i.net.toFixed(3)}</td>
                    <td class="text-right text-green-600 font-bold">${i.sell.toFixed(3)}</td>
                    <td class="text-right text-blue-600 font-bold">${(i.sell - i.net).toFixed(3)}</td>
                    <td class="text-[10px] uppercase">${i.sector || '-'}</td>
                    <td class="text-right text-orange-600 font-black">${(i.due || 0).toFixed(3)}</td>
                    <td class="no-print"><button onclick="event.stopPropagation(); cloudDelete('ledger', '${i.id}')" class="text-red-300 hover:text-red-500">×</button></td>
                </tr>
            `).join('');

            document.getElementById('tot-net').textContent = data.reduce((a,v) => a + v.net, 0).toFixed(3);
            document.getElementById('tot-sell').textContent = data.reduce((a,v) => a + v.sell, 0).toFixed(3);
            document.getElementById('tot-profit').textContent = data.reduce((a,v) => a + (v.sell - v.net), 0).toFixed(3);
            document.getElementById('tot-due').textContent = data.reduce((a,v) => a + (v.due || 0), 0).toFixed(3);
            lucide.createIcons();
        }

        window.setDueView = (mode) => {
            dueViewMode = mode;
            document.getElementById('btn-due-active').className = mode === 'active' ? 'px-6 py-1.5 rounded-md text-sm font-bold bg-white text-gray-800 shadow-sm transition-all' : 'px-6 py-1.5 rounded-md text-sm font-bold text-gray-600 hover:bg-gray-300 transition-all';
            document.getElementById('btn-due-history').className = mode === 'history' ? 'px-6 py-1.5 rounded-md text-sm font-bold bg-white text-gray-800 shadow-sm transition-all' : 'px-6 py-1.5 rounded-md text-sm font-bold text-gray-600 hover:bg-gray-300 transition-all';
            document.getElementById('due-active-view').classList.toggle('hidden', mode === 'history');
            document.getElementById('due-history-view').classList.toggle('hidden', mode === 'active');
            renderDues();
        }

        function renderDues() {
            const data = window.cloudState.dues.sort((a,b) => b.id - a.id);
            const activeCust = document.getElementById('due-table-customer');
            const activePay = document.getElementById('due-table-payable');
            const activeBank = document.getElementById('due-table-bank');
            const historyBody = document.getElementById('due-table-history');

            activeCust.innerHTML = ''; activePay.innerHTML = ''; activeBank.innerHTML = ''; historyBody.innerHTML = '';

            data.forEach(d => {
                if(d.status === 'Paid' || d.status === 'Completed') {
                    historyBody.innerHTML += `<tr><td class="text-[10px] font-black uppercase text-gray-400">${d.type}</td><td class="font-bold">${d.name}</td><td class="font-mono text-right">${d.amount.toFixed(3)}</td><td>${d.date}</td><td class="no-print"><button onclick="cloudDelete('dues', '${d.id}')" class="text-red-300">×</button></td></tr>`;
                } else if(d.type === 'bank') {
                    activeBank.innerHTML += `<tr><td>${d.date}</td><td><input type="text" class="w-full bg-transparent border-none" value="${d.name}" onblur="cloudSave('dues', {...${JSON.stringify(d)}, name: this.value})"></td><td><input type="number" step="0.001" class="w-full bg-transparent border-none text-right font-black text-green-700" value="${d.amount}" onblur="cloudSave('dues', {...${JSON.stringify(d)}, amount: parseFloat(this.value)})"></td><td class="no-print"><button onclick="cloudDelete('dues', '${d.id}')" class="text-red-300">×</button></td></tr>`;
                } else {
                    const rowHtml = `<tr>
                        <td class="font-bold text-gray-700"><input type="text" class="w-full bg-transparent border-none" value="${d.name}" onblur="cloudSave('dues', {...${JSON.stringify(d)}, name: this.value})"></td>
                        ${d.type === 'customer' ? `<td><input type="text" class="w-full bg-transparent border-none text-xs text-gray-400" value="${d.phone || ''}" onblur="cloudSave('dues', {...${JSON.stringify(d)}, phone: this.value})"></td>` : ''}
                        <td><input type="number" step="0.001" class="w-full bg-transparent border-none text-right font-black" value="${d.amount}" onblur="cloudSave('dues', {...${JSON.stringify(d)}, amount: parseFloat(this.value)})"></td>
                        <td><input type="date" class="w-full bg-transparent border-none text-xs" value="${d.date}" onchange="cloudSave('dues', {...${JSON.stringify(d)}, date: this.value})"></td>
                        <td><select class="text-[10px] font-bold p-1 rounded bg-orange-100 text-orange-600" onchange="cloudSave('dues', {...${JSON.stringify(d)}, status: this.value})"><option value="Pending">Pending</option><option value="Paid">Paid</option></select></td>
                        <td class="no-print"><button onclick="cloudDelete('dues', '${d.id}')" class="text-red-300">×</button></td>
                    </tr>`;
                    if(d.type === 'customer') activeCust.innerHTML += rowHtml; else activePay.innerHTML += rowHtml;
                }
            });

            const r = data.filter(d => d.type === 'customer' && d.status === 'Pending').reduce((a,v) => a + v.amount, 0);
            const p = data.filter(d => d.type === 'payable' && d.status === 'Pending').reduce((a,v) => a + v.amount, 0);
            const b = data.filter(d => d.type === 'bank').reduce((a,v) => a + v.amount, 0);
            document.getElementById('due-sum-receive').textContent = r.toFixed(3);
            document.getElementById('due-sum-pay').textContent = p.toFixed(3);
            document.getElementById('due-sum-bank').textContent = b.toFixed(3);
            document.getElementById('due-sum-net').textContent = (r + b - p).toFixed(3);
        }

        function renderTasks() {
            const list = document.getElementById('task-list');
            list.innerHTML = window.cloudState.tasks.sort((a,b) => b.id - a.id).map(t => `<li class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100 shadow-sm"><span class="text-sm font-medium text-gray-700">${t.text}</span><button onclick="cloudDelete('tasks', '${t.id}')" class="text-red-300 hover:text-red-500">×</button></li>`).join('');
        }

        function renderSalam() {
            const activeList = document.getElementById('salam-active-list');
            const historyList = document.getElementById('salam-history-list');
            const data = window.cloudState.salam.sort((a,b) => new Date(a.date) - new Date(b.date));
            const today = new Date().toISOString().split('T')[0];
            
            activeList.innerHTML = data.filter(s => s.status !== 'Completed').map(s => `
                <div class="p-3 rounded-xl border-l-4 ${s.date <= today ? 'bg-red-50 border-red-500' : 'bg-gray-50 border-green-500'} shadow-sm">
                    <div class="flex justify-between font-bold text-[10px]"><span>PNR: ${s.pnr}</span><span>FLIGHT: ${s.date}</span></div>
                    <div class="text-sm font-bold text-gray-700">${s.name}</div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="cloudSave('salam', {...${JSON.stringify(s)}, status: 'Completed'})" class="text-[8px] font-black text-green-600 bg-white border border-green-200 px-3 py-1 rounded uppercase">Done</button>
                        <button onclick="cloudDelete('salam', '${s.id}')" class="text-[8px] font-black text-red-300 uppercase px-3 py-1">Delete</button>
                    </div>
                </div>
            `).join('');

            historyList.innerHTML = data.filter(s => s.status === 'Completed').map(s => `
                <div class="p-2 bg-gray-100 rounded text-[10px] flex justify-between items-center">
                    <span>${s.name} (${s.pnr}) - ${s.date}</span>
                    <button onclick="cloudSave('salam', {...${JSON.stringify(s)}, status: 'Active'})" class="text-blue-500 font-bold uppercase">Restore</button>
                </div>
            `).join('');
        }

        function renderExpenses() {
            const body = document.getElementById('expense-table-body');
            const filter = document.getElementById('exp-month-filter').value;
            const data = window.cloudState.expenses.filter(e => !filter || e.date.startsWith(filter)).sort((a,b) => b.id - a.id);
            body.innerHTML = data.map(e => `<tr><td>${e.date}</td><td class="font-medium">${e.desc}</td><td class="text-right font-black text-red-600 font-mono">${e.amount.toFixed(3)}</td><td class="no-print"><button onclick="cloudDelete('expenses', '${e.id}')" class="text-gray-300">×</button></td></tr>`).join('');
            document.getElementById('exp-sum').textContent = data.reduce((a,v) => a + v.amount, 0).toFixed(3);
        }

        // ACTIONS
        window.handleHisabSubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('h-id').value || Date.now().toString();
            await cloudSave('ledger', {
                id, date: document.getElementById('h-date').value || new Date().toISOString().split('T')[0],
                name: document.getElementById('h-name').value, pnr: document.getElementById('h-pnr').value,
                fdate: document.getElementById('h-fdate').value, sector: document.getElementById('h-sector').value,
                net: parseFloat(document.getElementById('h-net').value), sell: parseFloat(document.getElementById('h-sell').value),
                due: parseFloat(document.getElementById('h-due').value) || 0
            });
            resetHisabForm();
        };

        window.addDueCloudRow = async (type) => {
            await cloudSave('dues', { type, name: type === 'bank' ? 'Bank Deposit' : 'New Entry', amount: 0, status: 'Pending', date: new Date().toISOString().split('T')[0], id: Date.now().toString() });
        };

        window.addTask = async (e) => {
            e.preventDefault();
            const text = document.getElementById('task-input').value;
            if(!text) return;
            await cloudSave('tasks', { text, id: Date.now().toString() });
            document.getElementById('task-input').value = '';
        };

        window.addSalam = async (e) => {
            e.preventDefault();
            await cloudSave('salam', { pnr: document.getElementById('salam-pnr').value, name: document.getElementById('salam-name').value, date: document.getElementById('salam-date').value, status: 'Active', id: Date.now().toString() });
            e.target.reset();
        };

        window.addExpense = async (e) => {
            e.preventDefault();
            await cloudSave('expenses', { date: document.getElementById('exp-date').value || new Date().toISOString().split('T')[0], desc: document.getElementById('exp-desc').value, amount: parseFloat(document.getElementById('exp-amt').value), id: Date.now().toString() });
            e.target.reset();
        };

        // DASHBOARD ENGINE
        let sChart, pChart;
        window.updateDashboard = () => {
            const l = window.cloudState.ledger;
            const sell = l.reduce((a,v) => a + v.sell, 0);
            const profit = l.reduce((a,v) => a + (v.sell - v.net), 0);
            const due = window.cloudState.dues.filter(d => d.type === 'customer' && d.status === 'Pending').reduce((a,v) => a + v.amount, 0);

            document.getElementById('dash-total-sell').textContent = sell.toFixed(3);
            document.getElementById('dash-total-profit').textContent = profit.toFixed(3);
            document.getElementById('dash-total-due').textContent = due.toFixed(3);

            // Alerts
            const alertBox = document.getElementById('dashboard-alerts');
            const today = new Date().toISOString().split('T')[0];
            const urgent = window.cloudState.salam.filter(s => s.status !== 'Completed' && s.date <= today);
            if(urgent.length > 0) {
                alertBox.classList.remove('hidden');
                alertBox.innerHTML = `<div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-xl flex justify-between items-center shadow-sm"><div class="flex items-center gap-3"><i data-lucide="bell-ring" class="text-amber-600 animate-pulse"></i><div><p class="font-bold text-amber-900">${urgent.length} URGENT CHECK-INS</p><p class="text-[10px] text-amber-600 font-bold uppercase">Flights scheduled for today or past</p></div></div><button onclick="switchTab('notes')" class="bg-amber-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold shadow-sm">Go to Tracker</button></div>`;
                lucide.createIcons();
            } else { alertBox.classList.add('hidden'); }

            // Charts
            const months = [...new Set(l.map(i => i.date.substring(0,7)))].sort().slice(-6);
            const sData = months.map(m => l.filter(i => i.date.startsWith(m)).reduce((a,v) => a+v.sell, 0));
            const pData = months.map(m => l.filter(i => i.date.startsWith(m)).reduce((a,v) => a+(v.sell-v.net), 0));

            if(sChart) sChart.destroy();
            sChart = new Chart(document.getElementById('salesChart'), { type: 'bar', data: { labels: months, datasets: [{ label: 'Sales', data: sData, backgroundColor: '#3b82f6' }] } });
            if(pChart) pChart.destroy();
            pChart = new Chart(document.getElementById('profitChart'), { type: 'line', data: { labels: months, datasets: [{ label: 'Profit', data: pData, borderColor: '#10b981', tension: 0.3 }] } });
        };

        // INVOICE SYSTEM
        window.togglePaidStamp = () => document.getElementById('paid-watermark').classList.toggle('is-visible', document.getElementById('paid-toggle').checked);
        
        window.saveInvoice = async () => {
            const num = document.getElementById('inv-num').textContent.trim();
            const client = document.getElementById('inv-client').textContent;
            const total = parseFloat(document.getElementById('inv-total').textContent);
            const date = document.getElementById('inv-date').textContent;
            
            const data = {
                num, date, client, phone: document.getElementById('inv-phone').textContent, total,
                items: Array.from(document.querySelectorAll('.inv-row')).map(r => ({ d: r.querySelector('.d').textContent, a: parseFloat(r.querySelector('.a').textContent) })),
                paid: document.getElementById('paid-toggle').checked
            };
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'invoices', num), data);
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), { invoiceNum: parseInt(num) + 1 });
            
            if(total > 0 && confirm("Add this invoice to the ledger?")) {
                const parts = date.split('/');
                const isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                await cloudSave('ledger', { id: 'INV_'+num, date: isoDate, name: client, net: 0, sell: total, sector: 'Invoice: '+num });
            }
            alert("Invoice Synced to Cloud Successfully");
        };

        window.loadInvoice = async () => {
            const num = document.getElementById('search-invoice').value;
            if(!num) return;
            const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'invoices', num.padStart(4, '0')));
            if(snap.exists()){
                const d = snap.data();
                document.getElementById('inv-num').textContent = d.num;
                document.getElementById('inv-date').textContent = d.date;
                document.getElementById('inv-client').textContent = d.client;
                document.getElementById('inv-phone').textContent = d.phone;
                document.getElementById('paid-toggle').checked = d.paid || false;
                togglePaidStamp();
                document.getElementById('inv-items').innerHTML = '';
                d.items.forEach(i => addInvRow(i.d, i.a.toFixed(3)));
            } else { alert("Invoice not found in cloud archive"); }
        };

        window.addInvRow = (desc = "Air Ticket / Sector Detail", amt = "0.000") => {
            const tr = document.createElement('tr'); tr.className = "inv-row border-b";
            tr.innerHTML = `<td class="p-4 d font-medium" contenteditable="true">${desc}</td><td class="p-4 a text-right font-black font-mono" contenteditable="true" oninput="calcInv()">${amt}</td><td class="no-print text-center"><button onclick="this.parentElement.parentElement.remove(); calcInv()" class="text-red-300 hover:text-red-500">×</button></td>`;
            document.getElementById('inv-items').appendChild(tr); calcInv();
        };

        window.calcInv = () => {
            const total = Array.from(document.querySelectorAll('.a')).reduce((acc, v) => acc + (parseFloat(v.textContent) || 0), 0);
            document.getElementById('inv-subtotal').textContent = total.toFixed(3);
            document.getElementById('inv-total').textContent = total.toFixed(3);
        };

        // UI HELPERS
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => b.className = "tab-btn flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50");
            document.getElementById(`btn-tab-${tab}`).className = "tab-btn flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all bg-gray-900 text-white shadow-md";
            window.currentTab = tab;
            if(tab === 'due') renderDues();
        };

        window.toggleDarkMode = () => document.body.classList.toggle('dark');
        window.resetHisabForm = () => { document.getElementById('hisab-form').reset(); document.getElementById('h-id').value = ''; document.getElementById('hisab-submit-btn').textContent = "ADD"; };
        window.editHisabRow = (id) => {
            const i = window.cloudState.ledger.find(item => item.id === id); if(!i) return;
            document.getElementById('h-id').value = id; document.getElementById('h-date').value = i.date;
            document.getElementById('h-name').value = i.name; document.getElementById('h-pnr').value = i.pnr;
            document.getElementById('h-fdate').value = i.fdate || ''; document.getElementById('h-sector').value = i.sector || '';
            document.getElementById('h-net').value = i.net; document.getElementById('h-sell').value = i.sell;
            document.getElementById('h-due').value = i.due; document.getElementById('hisab-submit-btn').textContent = "UPDATE";
        };

        window.exportFullBackup = () => {
            const blob = new Blob([JSON.stringify(window.cloudState)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `Holiday_Cloud_FullBackup_${new Date().toISOString().slice(0,10)}.json`; a.click();
        };

        window.restoreBackup = async (input) => {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = JSON.parse(e.target.result);
                if(confirm("Sync this backup to the cloud? This will update all cloud items.")) {
                    if(data.ledger) for(const i of data.ledger) await cloudSave('ledger', i);
                    if(data.dues) for(const i of data.dues) await cloudSave('dues', i);
                    if(data.tasks) for(const i of data.tasks) await cloudSave('tasks', i);
                    if(data.salam) for(const i of data.salam) await cloudSave('salam', i);
                    if(data.expenses) for(const i of data.expenses) await cloudSave('expenses', i);
                    alert("Cloud Restore Finished!");
                }
            };
            reader.readAsText(file);
        };

        window.resetInvoice = () => {
            document.getElementById('inv-client').textContent = "Customer Name";
            document.getElementById('inv-phone').textContent = "968...";
            document.getElementById('inv-items').innerHTML = '';
            document.getElementById('paid-toggle').checked = false;
            togglePaidStamp();
            addInvRow();
        };

        // AUTO-CLEAR FEATURE
        function setupAutoClear(id, defaultText) {
            const el = document.getElementById(id);
            if(!el) return;
            el.addEventListener('focus', () => { if(el.innerText.trim() === defaultText) el.innerText = ''; });
            el.addEventListener('blur', () => { if(el.innerText.trim() === '') el.innerText = defaultText; });
        }

        // INIT
        document.getElementById('hisab-month-filter').value = new Date().toISOString().substring(0,7);
        document.getElementById('exp-month-filter').value = new Date().toISOString().substring(0,7);
        document.getElementById('inv-date').textContent = new Date().toLocaleDateString('en-GB');
        addInvRow();
        lucide.createIcons();
        setupAutoClear('inv-client', 'Customer Name');
        setupAutoClear('inv-phone', '968...');
    </script>
</body>
</html>