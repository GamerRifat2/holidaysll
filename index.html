<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Travels - Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; transition: background-color 0.3s, color 0.3s; }
        .arabic-text { font-family: 'Cairo', sans-serif; direction: rtl; }
        
        /* Dark Mode Styles */
        body.dark { background-color: #111827; color: #e5e7eb; }
        body.dark .bg-white { background-color: #1f2937; border-color: #374151; color: #e5e7eb; }
        body.dark .bg-gray-50 { background-color: #111827; border-color: #374151; }
        body.dark .bg-gray-100 { background-color: #374151; }
        body.dark input, body.dark select, body.dark textarea { background-color: #374151; color: white; border-color: #4b5563; }
        body.dark .text-gray-800 { color: #f3f4f6; }
        body.dark .text-gray-700 { color: #d1d5db; }
        body.dark .text-gray-600 { color: #9ca3af; }
        body.dark .text-gray-500 { color: #9ca3af; }
        body.dark .border-gray-200 { border-color: #374151; }
        body.dark .border-gray-300 { border-color: #4b5563; }
        body.dark .hover\:bg-gray-50:hover { background-color: #374151; }
        body.dark .excel-table th { background-color: #374151; color: #e5e7eb; border-color: #4b5563; }
        body.dark .excel-table td { border-color: #4b5563; }
        body.dark .excel-table tr:nth-child(even) { background-color: #1f2937; } 
        body.dark .excel-table tr:hover { background-color: #374151; }
        
        /* Specific Dark Mode Overrides */
        body.dark .bg-blue-50 { background-color: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.2); }
        body.dark .bg-green-50 { background-color: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.2); }
        body.dark .bg-red-50 { background-color: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); }
        body.dark .bg-purple-50 { background-color: rgba(168, 85, 247, 0.1); border-color: rgba(168, 85, 247, 0.2); }
        body.dark .bg-orange-50 { background-color: rgba(249, 115, 22, 0.1); border-color: rgba(249, 115, 22, 0.2); }
        body.dark .bg-yellow-50 { background-color: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.2); }
        body.dark .bg-amber-50 { background-color: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.2); }

        /* Force Header to Stay White in Dark Mode */
        body.dark #global-header {
            background-color: white !important;
            border-color: #e5e7eb !important;
        }
        /* Restore Dark Text for Header in Dark Mode */
        body.dark #global-header .text-gray-800 { color: #1f2937 !important; } 
        body.dark #global-header .text-gray-600 { color: #4b5563 !important; }
        body.dark #global-header .text-gray-500 { color: #6b7280 !important; }

        /* Invoice Paper (Always White) */
        .invoice-paper {
            max-width: 210mm; min-height: 297mm; margin: 0 auto; padding: 2rem;
            background-color: white; 
            color: black;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; position: relative;
        }
        body.dark .invoice-paper {
            background-color: white; 
            color: black;
        }
        body.dark .invoice-paper .editable { color: black; }
        body.dark .invoice-paper input { background-color: transparent; color: black; border-color: #ddd; }

        /* Tab Animations */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Paid Stamp */
        .paid-seal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            border: 0.4rem solid #22c55e; border-radius: 0.8rem; padding: 0.5rem 2rem;
            text-align: center; opacity: 0; pointer-events: none; z-index: 50; transition: opacity 0.3s ease;
            color: #22c55e; background-color: rgba(255, 255, 255, 0.9); box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;
        }
        .paid-seal.is-visible { opacity: 0.4 !important; display: block !important; }

        /* Excel-like Table Styles */
        .excel-table { border-collapse: collapse; width: 100%; font-size: 11px; } 
        .excel-table th, .excel-table td { border: 1px solid #d1d5db; padding: 6px 4px; }
        .excel-table th { background-color: #f3f4f6; font-weight: 700; text-align: center; white-space: nowrap; }
        .excel-table tr:nth-child(even) { background-color: #f9fafb; }
        .excel-table tr:hover { background-color: #eff6ff; cursor: pointer; }
        .excel-table td { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .row-selected { background-color: #fff7ed !important; border-left: 3px solid #f97316; }
        body.dark .row-selected { background-color: rgba(249, 115, 22, 0.2) !important; }
        
        .print-header { display: none; }

        /* Print Settings */
        @media print {
            @page { margin: 0; size: A4 portrait; } 
            body { background: white !important; color: black !important; margin: 0; padding: 0; }
            .no-print, .controls, #login-screen, .tabs-nav, #global-header, .add-row-btn { display: none !important; }
            
            .tab-content { display: none !important; }
            .tab-content.active { display: block !important; }

            .invoice-paper { box-shadow: none; margin: 0; width: 100%; max-width: 100%; padding: 5mm; min-height: auto; height: auto; }
            
            #tab-invoice.active header { flex-direction: row !important; display: flex !important; }
            #tab-invoice.active header > div { width: 33.33% !important; }
            #tab-invoice.active .grid { display: grid !important; grid-template-columns: 1fr 1fr !important; }
            
            #tab-hisab.active { width: 100%; }
            #tab-expense.active { width: 100%; }
            #tab-notes.active { width: 100%; }
            
            /* Due Tab Print Styling */
            #tab-due.active .print-header { display: flex !important; flex-direction: row; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
            #tab-due.active .print-header img { height: 60px; }
            #tab-due.active .print-header .company-details { text-align: right; }
            #tab-due.active .grid { display: block !important; } 
            #tab-due.active .grid > div { margin-bottom: 15px; border: 1px solid #000; page-break-inside: avoid; background: #fff !important; } 
            #tab-due.active .grid-cols-1 { display: block !important; } 
            #tab-due.active #due-active-view { display: block !important; }
            #tab-due.active #due-active-view > div { margin-bottom: 30px; page-break-inside: avoid; } 
            
            .excel-table th, .excel-table td { border: 1px solid #000 !important; font-size: 10px; color: black !important; background: white !important; } 
            .excel-table input, .excel-table select { border: none !important; padding: 0 !important; background: transparent !important; width: auto !important; }

            #tab-dashboard.active .chart-container { page-break-inside: avoid; }
            
            .paid-seal.is-visible { display: block !important; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- PASSWORD SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-gray-100 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center border border-gray-200">
            <div class="mb-6 flex justify-center">
                <img id="login-logo-img" src="LOGO.png" alt="Holiday Travels" class="h-24 w-auto object-contain">
            </div>
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Login Required</h2>
            <p class="text-gray-500 mb-6 text-sm">Enter passcode to access.</p>
            <input type="password" id="password-input" placeholder="Passcode" class="w-full p-3 border border-gray-200 rounded-lg mb-4 text-center text-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="attemptLogin()" class="w-full bg-gray-900 text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition-all shadow-lg">Login</button>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden font-medium">Incorrect Code</p>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="max-w-[290mm] mx-auto mt-6 px-4 mb-4"> 
        
        <!-- GLOBAL HEADER -->
        <div id="global-header" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <img id="header-logo-img" src="LOGO.png" alt="Holiday Travels" class="h-12 w-auto object-contain">
            </div>
            <div class="flex gap-2 w-full md:w-auto items-center">
                <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-gray-100 transition-colors mr-2" title="Toggle Dark Mode">
                    <i data-lucide="moon" class="w-5 h-5 text-gray-600 dark:hidden"></i>
                    <i data-lucide="sun" class="w-5 h-5 text-yellow-400 hidden dark:block"></i>
                </button>
                
                <button onclick="backupData()" class="flex-1 md:flex-none bg-gray-800 text-white px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-gray-700 flex items-center justify-center gap-2 transition-all shadow-sm">
                    <i data-lucide="download-cloud" class="w-4 h-4"></i> Backup
                </button>
                <label class="flex-1 md:flex-none bg-blue-600 text-white px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-blue-700 flex items-center justify-center gap-2 cursor-pointer transition-all shadow-sm">
                    <i data-lucide="upload-cloud" class="w-4 h-4"></i> Restore
                    <input type="file" class="hidden" onchange="restoreData(this)" accept=".json">
                </label>
            </div>
        </div>

        <!-- NAVIGATION TABS -->
        <div class="tabs-nav flex gap-2 mb-6 bg-white p-2 rounded-xl shadow-sm border border-gray-200 no-print max-w-[210mm] mx-auto overflow-x-auto">
            <button onclick="switchTab('dashboard')" id="btn-tab-dashboard" class="flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all bg-gray-900 text-white shadow-md">
                <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Dashboard
            </button>
            <button onclick="switchTab('hisab')" id="btn-tab-hisab" class="flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50">
                <i data-lucide="plane" class="w-4 h-4"></i> Ticketing
            </button>
             <button onclick="switchTab('notes')" id="btn-tab-notes" class="flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50">
                <i data-lucide="clipboard-list" class="w-4 h-4"></i> Notes & Check-in
            </button>
            <button onclick="switchTab('due')" id="btn-tab-due" class="flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50">
                <i data-lucide="wallet" class="w-4 h-4"></i> Due & Bank
            </button>
            <button onclick="switchTab('expense')" id="btn-tab-expense" class="flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50">
                <i data-lucide="calculator" class="w-4 h-4"></i> Expenses
            </button>
            <button onclick="switchTab('invoice')" id="btn-tab-invoice" class="flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50">
                <i data-lucide="file-text" class="w-4 h-4"></i> Invoice
            </button>
        </div>

        <!-- TAB 1: DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden max-w-[210mm] mx-auto">
                <div class="p-6 bg-gray-50 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="bar-chart-3" class="text-blue-600"></i> Sales Dashboard</h2>
                    <p class="text-sm text-gray-500">Yearly Performance Overview</p>
                </div>

                <!-- NEW: URGENT CHECK-IN ALERTS -->
                <div id="dashboard-alerts" class="p-6 pb-0 hidden">
                    <!-- Injected via JS -->
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 bg-white">
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-2xl border border-green-200 shadow-sm">
                        <div class="text-green-600 font-bold uppercase text-xs tracking-wider mb-1">Total Sell (Year)</div>
                        <div class="text-3xl font-black text-gray-800" id="dash-total-sell">0.000</div>
                        <div class="text-xs text-green-700 mt-1">OMR</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-2xl border border-blue-200 shadow-sm">
                        <div class="text-blue-600 font-bold uppercase text-xs tracking-wider mb-1">Total Profit (Year)</div>
                        <div class="text-3xl font-black text-gray-800" id="dash-total-profit">0.000</div>
                        <div class="text-xs text-blue-700 mt-1">OMR</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-2xl border border-orange-200 shadow-sm">
                        <div class="text-orange-600 font-bold uppercase text-xs tracking-wider mb-1">Total Due</div>
                        <div class="text-3xl font-black text-gray-800" id="dash-total-due">0.000</div>
                        <div class="text-xs text-orange-700 mt-1">OMR</div>
                    </div>
                </div>

                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="chart-container bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">Monthly Sales vs Net Cost</h3>
                        <canvas id="salesChart" width="400" height="250"></canvas>
                    </div>
                    <div class="chart-container bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">Monthly Profit Trend</h3>
                        <canvas id="profitChart" width="400" height="250"></canvas>
                    </div>
                </div>

                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-gray-200">
                    <div class="chart-container bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">Expenses Breakdown (Year)</h3>
                        <div class="h-64 flex justify-center">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">Outstanding Balances</h3>
                        <canvas id="dueChart" width="400" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: TRAVEL LEDGER (HISAB) -->
        <div id="tab-hisab" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 bg-gray-50 no-print">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center gap-2">
                            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i data-lucide="plane" class="text-blue-600 w-5 h-5"></i> Ticketing Ledger</h2>
                            <div class="h-6 w-px bg-gray-300 mx-2"></div>
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wide">Month:</span>
                            <input type="month" id="hisab-month-filter" class="p-1 border border-gray-300 rounded text-sm font-bold text-gray-800" onchange="loadHisab()">
                        </div>
                        <div class="flex gap-2">
                             <button onclick="window.print()" class="bg-gray-800 text-white px-3 py-2 rounded text-xs font-bold hover:bg-gray-700 flex items-center gap-1"><i data-lucide="printer" class="w-3 h-3"></i> Print</button>
                             <button onclick="exportHisab('month')" class="bg-green-600 text-white px-3 py-2 rounded text-xs font-bold hover:bg-green-700 flex items-center gap-1"><i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Export Excel</button>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 bg-white border-b border-gray-200 no-print">
                    <form onsubmit="event.preventDefault(); addHisabEntry();" class="grid grid-cols-2 md:grid-cols-5 lg:grid-cols-10 gap-2 items-end">
                        <input type="hidden" id="h-edit-id"> 
                        <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1">DATE</label><input type="date" id="h-date" class="w-full p-1.5 border border-gray-300 rounded text-xs bg-yellow-50" title="Leave empty for Today's Date"></div>
                        <div class="col-span-1 md:col-span-2"><label class="block text-[10px] font-bold text-gray-500 mb-1">NAME</label><input type="text" id="h-name" placeholder="Passenger Name" class="w-full p-1.5 border border-gray-300 rounded text-xs" required></div>
                        <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1">PNR</label><input type="text" id="h-pnr" placeholder="PNR" class="w-full p-1.5 border border-gray-300 rounded text-xs"></div>
                        <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1">FLIGHT DATE</label><input type="date" id="h-fdate" class="w-full p-1.5 border border-gray-300 rounded text-xs" title="Leave empty to use Entry Date"></div>
                        <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1">SECTOR</label><input type="text" id="h-sector" placeholder="DXB-MCT" class="w-full p-1.5 border border-gray-300 rounded text-xs"></div>
                        <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1">PHONE</label><input type="text" id="h-phone" placeholder="968..." class="w-full p-1.5 border border-gray-300 rounded text-xs"></div>
                        <div class="col-span-1"><label class="block text-[10px] font-bold text-red-600 mb-1">NET (COST)</label><input type="number" step="0.001" id="h-net" placeholder="0.000" class="w-full p-1.5 border border-red-200 rounded text-xs focus:border-red-500" required></div>
                        <div class="col-span-1"><label class="block text-[10px] font-bold text-green-600 mb-1">SELL (SALE)</label><input type="number" step="0.001" id="h-sell" placeholder="0.000" class="w-full p-1.5 border border-green-200 rounded text-xs focus:border-green-500" required></div>
                        <div class="col-span-1"><label class="block text-[10px] font-bold text-orange-500 mb-1">DUE</label><input type="number" step="0.001" id="h-due" placeholder="0.000" class="w-full p-1.5 border border-orange-200 rounded text-xs"></div>
                        <div class="col-span-1 md:col-span-1 flex gap-1">
                            <button type="submit" id="btn-add-update" class="flex-grow bg-blue-600 text-white p-1.5 rounded font-bold hover:bg-blue-700 text-xs h-[30px] mt-4 shadow-sm transition-colors">ADD</button>
                            <button type="button" id="btn-cancel-edit" onclick="cancelEdit()" class="hidden bg-gray-200 text-gray-600 p-1.5 rounded font-bold hover:bg-gray-300 text-xs h-[30px] mt-4 w-8 flex items-center justify-center"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                    </form>
                </div>

                <div class="p-6 bg-white min-h-[500px]">
                    <div class="text-center mb-4">
                        <h1 class="text-xl font-bold text-gray-800 uppercase tracking-widest">Travel Agency Ledger</h1>
                        <p class="text-sm text-gray-500" id="sheet-header-date">January 2026</p>
                    </div>
                    <div class="grid grid-cols-4 gap-0 mb-4 border border-gray-300 text-center text-xs font-bold bg-gray-50">
                        <div class="p-2 border-r border-gray-300 text-red-700">Total Net (Cost): <span id="tot-net">0.000</span></div>
                        <div class="p-2 border-r border-gray-300 text-green-700">Total Sell: <span id="tot-sell">0.000</span></div>
                        <div class="p-2 border-r border-gray-300 text-blue-800">Total Profit: <span id="tot-profit">0.000</span></div>
                        <div class="p-2 text-orange-600">Total Due: <span id="tot-due">0.000</span></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th style="width: 8%">DATE</th><th style="width: 15%">NAME</th><th style="width: 8%">PNR</th><th style="width: 8%">FLIGHT DATE</th><th style="width: 8%">NET</th><th style="width: 8%">SELL</th><th style="width: 8%; background-color: #e0f2fe;">PROFIT</th><th style="width: 10%">SECTOR</th><th style="width: 10%">PHONE</th><th style="width: 8%; background-color: #fff7ed;">DUE</th><th class="no-print" style="width: 4%"></th>
                                </tr>
                            </thead>
                            <tbody id="hisab-table-body" class="text-gray-700 font-mono"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: NOTES & CHECK-IN -->
        <div id="tab-notes" class="tab-content">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-[290mm] mx-auto">
                 
                 <!-- SECTION 1: GENERAL TASKS -->
                 <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-fit">
                    <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i data-lucide="clipboard-list" class="text-indigo-600"></i> Tasks & Notes</h2>
                    </div>
                    <div class="p-4">
                        <form onsubmit="event.preventDefault(); addNote();" class="flex gap-2 mb-4">
                            <input type="text" id="note-input" placeholder="Add a new task..." class="flex-grow p-2 border border-gray-300 rounded text-sm" required>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-indigo-700">Add</button>
                        </form>
                        <ul id="notes-list" class="space-y-2 max-h-[400px] overflow-y-auto">
                            <!-- Notes inserted here -->
                        </ul>
                    </div>
                 </div>

                 <!-- SECTION 2: SALAMAIR CHECK-IN TRACKER -->
                 <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i data-lucide="plane" class="text-green-600"></i> SalamAir Check-in Tracker</h2>
                        <button onclick="toggleSalamHistory()" class="text-xs font-bold text-gray-500 hover:text-gray-700 underline">Show History</button>
                    </div>
                    <div class="p-4 border-b border-gray-100">
                        <form onsubmit="event.preventDefault(); addSalamReminder();" class="flex flex-wrap gap-2 items-end">
                            <div class="flex-grow">
                                <label class="block text-[10px] font-bold text-gray-500 mb-1">PNR</label>
                                <input type="text" id="salam-pnr" class="w-full p-2 border border-gray-300 rounded text-sm font-mono" placeholder="ABC123" required>
                            </div>
                            <div class="flex-grow">
                                <label class="block text-[10px] font-bold text-gray-500 mb-1">Last Name</label>
                                <input type="text" id="salam-name" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Surname" required>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-1">Flight Date</label>
                                <input type="date" id="salam-date" class="w-full p-2 border border-gray-300 rounded text-sm" required>
                            </div>
                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-green-700 h-[38px]">Track</button>
                        </form>
                    </div>
                    
                    <!-- Active Reminders -->
                    <div class="p-0">
                         <table class="excel-table w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th style="width: 25%">Flight Date</th>
                                    <th style="width: 20%">PNR</th>
                                    <th style="width: 35%">Last Name</th>
                                    <th style="width: 20%">Action</th>
                                </tr>
                            </thead>
                            <tbody id="salam-active-list"></tbody>
                        </table>
                        <div id="salam-empty" class="text-center py-8 text-gray-400 text-xs italic">No pending check-ins.</div>
                    </div>

                    <!-- History (Hidden by default) -->
                    <div id="salam-history-container" class="hidden border-t border-gray-200 mt-4">
                        <div class="p-2 bg-gray-100 text-xs font-bold text-gray-600 text-center uppercase tracking-wide">Check-in History</div>
                        <table class="excel-table w-full opacity-60">
                            <tbody id="salam-history-list"></tbody>
                        </table>
                    </div>
                 </div>

             </div>
        </div>

        <!-- TAB 4: DUE & BANKING TRACKER -->
        <div id="tab-due" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden max-w-[210mm] mx-auto">
                
                <!-- PRINT HEADER (Hidden on Screen, Visible on Print) -->
                <div class="print-header hidden">
                     <img src="LOGO.png" alt="Logo" class="h-24 w-auto object-contain">
                     <div class="company-details text-right">
                        <h1 class="font-bold text-gray-800 text-lg uppercase leading-tight mb-1">HOLIDAY TRAVELS</h1>
                        <p class="text-xs text-gray-600">NEAR PAK MOSJID SALALAH</p>
                        <p class="text-xs text-gray-600">Salalah, Sultanate of Oman</p>
                        <p class="text-xs text-gray-600 mt-1"><strong>Phone:</strong> 78594007</p>
                     </div>
                </div>
                <!-- END PRINT HEADER -->

                <div class="p-6 bg-gray-50 border-b border-gray-200 flex flex-col gap-4 no-print">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <i data-lucide="wallet" class="text-blue-600"></i> Due & Banking
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="window.print()" class="bg-gray-800 text-white px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 hover:bg-gray-700"><i data-lucide="printer" class="w-3 h-3"></i> Print</button>
                            <button id="btn-undo-due" onclick="undoDeleteDue()" class="hidden bg-gray-700 text-white px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> Undo</button>
                        </div>
                    </div>
                    
                    <!-- View Toggle -->
                    <div class="flex justify-center">
                        <div class="bg-gray-200 p-1 rounded-lg flex gap-1">
                            <button onclick="setDueView('active')" id="btn-due-active" class="px-6 py-1.5 rounded-md text-sm font-bold bg-white text-gray-800 shadow-sm transition-all">Active / Pending</button>
                            <button onclick="setDueView('history')" id="btn-due-history" class="px-6 py-1.5 rounded-md text-sm font-bold text-gray-600 hover:bg-gray-300 transition-all">History / Paid</button>
                        </div>
                    </div>
                </div>

                <!-- Stats (Modified for Print to look like Summary Box) -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-6 bg-white">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <p class="text-xs font-bold text-blue-600 uppercase">Customer Due (Receivable)</p>
                        <p class="text-2xl font-black text-gray-800" id="due-total-receive">0.000</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                        <p class="text-xs font-bold text-red-600 uppercase">My Payables (Liability)</p>
                        <p class="text-2xl font-black text-gray-800" id="due-total-pay">0.000</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                        <p class="text-xs font-bold text-green-600 uppercase">Total Bank Deposit</p>
                        <p class="text-2xl font-black text-gray-800" id="due-total-bank">0.000</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <p class="text-xs font-bold text-purple-600 uppercase">Projected Net Balance</p>
                        <p class="text-2xl font-black text-gray-800" id="due-total-balance">0.000</p>
                        <p class="text-[9px] text-purple-400 mt-1 uppercase tracking-wide">Due + Bank - Payables</p>
                    </div>
                </div>

                <!-- ACTIVE VIEW -->
                <div id="due-active-view" class="grid grid-cols-1 gap-6 p-6">
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-1 flex items-center gap-2"><i data-lucide="arrow-down-left" class="text-blue-500 w-4 h-4"></i> Customer Dues (Receivables)</h3>
                        <table class="excel-table w-full">
                            <thead>
                                <tr>
                                    <th style="width: 25%">Customer Name</th>
                                    <th style="width: 15%">Phone (Opt)</th>
                                    <th style="width: 20%">Amount</th>
                                    <th style="width: 20%">Promise Date (Opt)</th>
                                    <th style="width: 15%">Status</th>
                                    <th class="no-print" style="width: 5%"></th>
                                </tr>
                            </thead>
                            <tbody id="due-table-customer"></tbody>
                        </table>
                        <button onclick="addDueRow('customer')" class="add-row-btn w-full mt-2 bg-blue-100 text-blue-700 text-xs font-bold py-2 rounded hover:bg-blue-200 dashed-border border-blue-300 border-2 border-dashed">+ Add Customer Due</button>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-1 flex items-center gap-2"><i data-lucide="arrow-up-right" class="text-red-500 w-4 h-4"></i> My Payables (Pending)</h3>
                        <table class="excel-table w-full">
                            <thead><tr><th style="width: 30%">Pay To (Name)</th><th style="width: 20%">Amount</th><th style="width: 20%">Pay Date</th><th style="width: 20%">Status</th><th class="no-print" style="width: 10%"></th></tr></thead>
                            <tbody id="due-table-payable"></tbody>
                        </table>
                        <button onclick="addDueRow('payable')" class="add-row-btn w-full mt-2 bg-red-100 text-red-700 text-xs font-bold py-2 rounded hover:bg-red-200 dashed-border border-red-300 border-2 border-dashed">+ Add Payable</button>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-1 flex items-center gap-2"><i data-lucide="landmark" class="text-green-600 w-4 h-4"></i> Recent Bank Deposits</h3>
                        <table class="excel-table w-full">
                            <thead><tr><th style="width: 20%">Date</th><th style="width: 40%">Bank Name / Details</th><th style="width: 30%">Amount</th><th class="no-print" style="width: 10%"></th></tr></thead>
                            <tbody id="due-table-bank"></tbody>
                        </table>
                        <button onclick="addDueRow('bank')" class="add-row-btn w-full mt-2 bg-green-100 text-green-700 text-xs font-bold py-2 rounded hover:bg-green-200 dashed-border border-green-300 border-2 border-dashed">+ Add Bank Deposit</button>
                    </div>
                </div>

                <!-- HISTORY VIEW (Hidden by default) -->
                <div id="due-history-view" class="hidden p-6">
                    <div class="mb-8">
                        <h3 class="font-bold text-gray-700 mb-2 border-b pb-1 flex items-center gap-2"><i data-lucide="history" class="text-gray-500 w-4 h-4"></i> Completed / Paid Dues History</h3>
                        <table class="excel-table w-full">
                            <thead>
                                <tr>
                                    <th style="width: 10%">Type</th>
                                    <th style="width: 25%">Name / Details</th>
                                    <th style="width: 15%">Amount</th>
                                    <th style="width: 15%">Promise Date</th>
                                    <th style="width: 15%">Paid Date</th>
                                    <th style="width: 10%">Status</th>
                                    <th class="no-print" style="width: 10%"></th>
                                </tr>
                            </thead>
                            <tbody id="due-table-history"></tbody>
                        </table>
                        <p class="text-xs text-gray-400 mt-2 text-center">Showing Paid Dues & Payables</p>
                    </div>

                    <div>
                         <h3 class="font-bold text-gray-700 mb-2 border-b pb-1 flex items-center gap-2"><i data-lucide="landmark" class="text-green-600 w-4 h-4"></i> All Bank Deposits History</h3>
                         <table class="excel-table w-full">
                            <thead><tr><th style="width: 20%">Date</th><th style="width: 40%">Bank Name / Details</th><th style="width: 30%">Amount</th><th class="no-print" style="width: 10%"></th></tr></thead>
                            <tbody id="due-table-bank-history"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- TAB 5: EXPENSE CALCULATOR (NEW) -->
        <div id="tab-expense" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden max-w-[210mm] mx-auto">
                <!-- Expense Header -->
                <div class="p-6 bg-gray-50 border-b border-gray-200 flex justify-between items-center no-print">
                    <div class="flex items-center gap-2">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="calculator" class="text-purple-600"></i> Expense Calculator</h2>
                        <div class="h-6 w-px bg-gray-300 mx-2"></div>
                        <input type="month" id="expense-month-filter" class="p-1 border border-gray-300 rounded text-sm font-bold text-gray-800" onchange="loadExpense()">
                    </div>
                    <div class="flex gap-2">
                         <button onclick="window.print()" class="bg-gray-800 text-white px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 hover:bg-gray-700"><i data-lucide="printer" class="w-3 h-3"></i> Print</button>
                         <button onclick="exportExpense()" class="bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-green-700 flex items-center gap-1"><i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Export</button>
                    </div>
                </div>

                <!-- Expense Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 bg-white">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <p class="text-xs font-bold text-blue-600 uppercase">Office Expenses</p>
                        <p class="text-2xl font-black text-gray-800" id="exp-total-office">0.000</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <p class="text-xs font-bold text-purple-600 uppercase">Personal Expenses</p>
                        <p class="text-2xl font-black text-gray-800" id="exp-total-personal">0.000</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                        <p class="text-xs font-bold text-red-600 uppercase">Total Expenses</p>
                        <p class="text-2xl font-black text-gray-800" id="exp-total-grand">0.000</p>
                    </div>
                </div>

                <!-- Add Expense Form -->
                <div class="px-6 py-4 bg-white border-b border-gray-200 no-print">
                    <form onsubmit="event.preventDefault(); addExpenseEntry();" class="flex flex-wrap gap-2 items-end">
                         <div class="w-36">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Date</label>
                            <input type="date" id="exp-date" class="w-full p-2 border border-gray-300 rounded text-sm bg-gray-50" required>
                        </div>
                        <div class="flex-grow min-w-[200px]">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Description</label>
                            <input type="text" id="exp-desc" placeholder="Expense Details..." class="w-full p-2 border border-gray-300 rounded text-sm bg-gray-50" required>
                        </div>
                        <div class="w-32">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Type</label>
                            <select id="exp-type" class="w-full p-2 border border-gray-300 rounded text-sm bg-gray-50">
                                <option value="Office">Office</option>
                                <option value="Personal">Personal</option>
                            </select>
                        </div>
                        <div class="w-28">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Amount</label>
                            <input type="number" step="0.001" id="exp-amount" placeholder="0.000" class="w-full p-2 border border-gray-300 rounded text-sm bg-gray-50" required>
                        </div>
                        <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded font-bold hover:bg-red-700 h-[38px] text-sm shadow-sm">Add</button>
                    </form>
                </div>

                <!-- Expense Table -->
                <div class="p-6 bg-white min-h-[300px]">
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th style="width: 15%">Date</th>
                                <th style="width: 45%">Description</th>
                                <th style="width: 15%">Type</th>
                                <th style="width: 15%">Amount</th>
                                <th class="no-print" style="width: 10%"></th>
                            </tr>
                        </thead>
                        <tbody id="expense-table-body" class="text-gray-700 font-mono"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 5: INVOICE GENERATOR -->
        <div id="tab-invoice" class="tab-content">
            <!-- Controls -->
            <div class="controls bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-wrap gap-4 justify-between items-center mb-6 max-w-[210mm] mx-auto">
                <div class="flex items-center gap-2 flex-grow max-w-md">
                    <input type="number" id="search-input" placeholder="Search Invoice No" class="flex-grow p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:outline-none text-sm">
                    <button onclick="searchInvoice()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm hover:bg-gray-700">Search</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="generateNewInvoice()" class="flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-2 rounded text-sm hover:bg-gray-200 font-bold border border-gray-300"><i data-lucide="plus" class="w-4 h-4"></i> New</button>
                    <button onclick="saveInvoice()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 font-bold shadow-sm"><i data-lucide="save" class="w-4 h-4"></i> Save</button>
                    <button onclick="window.print()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 font-bold shadow-sm"><i data-lucide="printer" class="w-4 h-4"></i> Print</button>
                </div>
                <div class="w-full flex justify-end mt-2 items-center gap-2">
                    <label class="flex items-center gap-2 cursor-pointer hover:text-green-600 font-bold text-sm text-gray-500">
                        <input type="checkbox" id="paid-toggle" class="rounded text-green-600 focus:ring-green-500">
                        <span>Mark as PAID</span>
                    </label>
                </div>
            </div>

            <!-- INVOICE PAPER -->
            <div class="invoice-paper" id="invoice-view">
                <div id="paid-watermark" class="paid-seal"><div class="text-5xl font-black uppercase tracking-wider">PAID</div><div class="text-3xl font-bold arabic-text mt-0">مدفوع</div></div>
                
                <header class="flex flex-col md:flex-row justify-between items-center pb-6 border-b relative z-10 gap-4">
                    <div class="text-center md:text-left w-full md:w-1/3 pt-2">
                        <h1 class="font-bold text-gray-800 text-lg uppercase leading-tight mb-1">HOLIDAY TRAVELS</h1>
                        <p class="text-xs text-gray-600">NEAR PAK MOSJID SALALAH</p>
                        <p class="text-xs text-gray-600">Salalah, Sultanate of Oman</p>
                        <p class="text-xs text-gray-600 mt-1"><strong>Phone:</strong> 78594007</p>
                        <p class="text-xs text-gray-600"><strong>Email:</strong> HOLIDAYTRAVELS.OM@GMAIL.COM</p>
                    </div>
                    <div class="text-center w-full md:w-1/3 flex justify-center">
                        <img id="invoice-logo-img" src="LOGO.png" onerror="this.style.display='none'" alt="Logo" class="h-28 w-auto object-contain mx-auto">
                    </div>
                    <div class="text-center md:text-right w-full md:w-1/3 pt-2 arabic-text">
                        <h1 contenteditable="true" class="editable font-bold text-gray-800 text-xl leading-tight mb-1">سفريات هوليداي</h1>
                        <p contenteditable="true" class="editable text-sm text-gray-600">بالقرب من المسجد الباكستاني</p>
                        <p contenteditable="true" class="editable text-sm text-gray-600">صلالة، سلطنة عمان</p>
                        <p class="text-sm text-gray-600 mt-1"><strong class="mx-1">هاتف:</strong><span class="font-sans" contenteditable="true">78594007</span></p>
                        <p class="text-sm text-gray-600"><strong class="mx-1">بريد إلكتروني:</strong><span class="font-sans text-xs" contenteditable="true">HOLIDAYTRAVELS.OM@GMAIL.COM</span></p>
                    </div>
                </header>

                <div class="flex justify-between items-center mt-6 mb-6">
                    <div class="text-left">
                        <div class="flex flex-col">
                            <span class="text-gray-500 text-xs font-bold uppercase">Invoice No</span>
                            <span id="invoice-number" contenteditable="true" class="editable text-xl font-bold text-gray-800 font-mono outline-none" title="Click to edit">9877</span>
                        </div>
                    </div>
                    <div class="text-center"><h2 class="text-3xl font-bold uppercase text-gray-800 tracking-wide">INVOICE <span class="arabic-text font-normal text-2xl">فاتورة</span></h2></div>
                    <div class="text-right"><div class="flex flex-col"><span class="text-gray-500 text-xs font-bold uppercase">Date</span><span id="invoice-date" contenteditable="true" class="editable text-xl font-bold text-gray-800"></span></div></div>
                </div>

                <section class="mb-8 bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="flex justify-between items-end mb-2"><h3 class="text-xs font-bold uppercase text-gray-500 tracking-wider">Billed To</h3><h3 class="text-sm font-bold text-gray-500 arabic-text">فاتورة إلى</h3></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs text-gray-400">Customer Name</label><div contenteditable="true" id="customer-name" class="editable text-lg font-bold text-gray-800 w-full p-1" data-placeholder="Name">Customer Name</div></div>
                        <div class="md:text-right"><label class="block text-xs text-gray-400">Phone</label><div contenteditable="true" id="customer-phone" class="editable text-gray-600 w-full p-1 font-sans" data-placeholder="Phone">Phone Number</div></div>
                    </div>
                </section>

                <section class="flex-grow">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-gray-800 text-white">
                                <th class="p-3 text-sm font-semibold uppercase tracking-wider w-3/4 rounded-tl-lg rounded-bl-lg"><div class="flex justify-between"><span>Item Description</span><span class="arabic-text font-normal">تفاصيل</span></div></th>
                                <th class="p-3 text-right text-sm font-semibold uppercase tracking-wider w-1/4 rounded-tr-lg rounded-br-lg"><div class="flex flex-col items-end"><span>Amount (OMR)</span><span class="arabic-text text-xs text-gray-300">المبلغ</span></div></th>
                                <th class="w-10 no-print bg-white"></th>
                            </tr>
                        </thead>
                        <tbody id="items-table-body"></tbody>
                    </table>
                    <button id="add-item-btn" onclick="addRow()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Add Item</button>
                </section>

                <section class="mt-8 flex justify-end">
                    <div class="w-72">
                        <div class="flex justify-between items-center py-2 border-b border-gray-200"><span class="text-gray-600 font-medium text-sm">Subtotal</span><span class="font-bold text-gray-800"><span id="subtotal">0.000</span></span></div>
                        <div class="flex justify-between items-center py-3 bg-gray-100 px-4 rounded-lg mt-3 border border-gray-200"><span class="text-lg font-bold text-gray-800">Total</span><span class="text-xl font-bold text-blue-900"><span id="total">0.000</span> <span class="text-sm text-gray-500">OMR</span></span></div>
                    </div>
                </section>

                <footer class="mt-12 pt-6 border-t border-gray-200 text-gray-500 text-sm">
                    <div class="flex flex-col md:flex-row justify-between items-end">
                        <div class="text-left space-y-1">
                            <p class="text-xs uppercase font-bold text-gray-800">Company Reg Details</p>
                            <p class="font-bold text-gray-700">Sajer Desert Rare Trading Company</p>
                            <p class="font-bold text-gray-700 arabic-text">شركة صحراء ساجر للتجارة النادرة</p>
                            <p><strong class="text-xs">CR No:</strong> <span class="font-mono">1588173</span></p>
                        </div>
                        <div class="mt-4 md:mt-0 flex flex-col items-center">
                            <img src="WHATSAPP.jpg" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png'" alt="WhatsApp" class="w-16 h-16 object-contain mb-1">
                            <p class="text-xs font-bold text-green-600">Contact Support</p>
                        </div>
                    </div>
                    <p class="mt-8 italic text-center text-[10px] text-gray-400">This invoice is electronically generated / هذه الفاتورة صادرة إلكترونياً</p>
                </footer>
            </div>
        </div>

    </div>

    <script>
        const STORAGE_PREFIX = 'holiday_inv_';
        const STORAGE_KEY_COUNTER = 'holidayTravelsInvoiceNum';
        const STORAGE_HISAB = 'holiday_ledger_data';
        const STORAGE_DUE = 'holiday_due_data';
        const STORAGE_EXPENSE = 'holiday_expense_data';
        const STORAGE_NOTES = 'holiday_notes_data';
        const STORAGE_SALAM = 'holiday_salam_data';
        const STORAGE_SALAM_HISTORY = 'holiday_salam_history';
        let dueViewMode = 'active'; 
        
        lucide.createIcons();

        // --- DARK MODE LOGIC ---
        function toggleDarkMode() {
            const html = document.documentElement;
            const body = document.body;
            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                localStorage.setItem('holiday_theme', 'light');
            } else {
                body.classList.add('dark');
                localStorage.setItem('holiday_theme', 'dark');
            }
        }
        
        // Init Dark Mode
        if (localStorage.getItem('holiday_theme') === 'dark') {
            document.body.classList.add('dark');
        }

        // --- AUTHENTICATION ---
        const CORRECT_PASS = "96419161";
        const loginScreen = document.getElementById('login-screen');
        const passInput = document.getElementById('password-input');
        
        if (sessionStorage.getItem('invoice_authorized') === 'true' && loginScreen) { loginScreen.style.display = 'none'; }

        function attemptLogin() {
            if (passInput && passInput.value === CORRECT_PASS) {
                sessionStorage.setItem('invoice_authorized', 'true');
                if(loginScreen) loginScreen.style.display = 'none';
            } else {
                const err = document.getElementById('login-error');
                if(err) err.classList.remove('hidden');
                if(passInput) passInput.value = '';
            }
        }
        
        if (passInput) {
            passInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') attemptLogin(); });
            passInput.focus();
        }

        // --- LOGO UPLOADER ---
        // Removed click handler as per user request to remove upload feature
        // Code below just checks if custom logo exists to display it if needed, but primary is LOGO.png
        
        // --- TABS ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            const activeTab = document.getElementById(`tab-${tabName}`);
            if(activeTab) activeTab.classList.add('active');
            
            // Reset buttons
            document.querySelectorAll('.tabs-nav button').forEach(btn => {
                btn.className = "flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all text-gray-600 hover:bg-gray-50";
            });
            
            // Activate current button
            const currentBtn = document.getElementById(`btn-tab-${tabName}`);
            if(currentBtn) {
                currentBtn.className = "flex-1 min-w-[120px] py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all bg-gray-900 text-white shadow-md";
            }

            if(tabName === 'hisab') loadHisab();
            if(tabName === 'dashboard') updateDashboard();
            if(tabName === 'due') loadDueData();
            if(tabName === 'expense') loadExpense();
            if(tabName === 'notes') loadNotes(); 
            if(tabName === 'invoice') {
                if(itemsTableBody && itemsTableBody.children.length === 0) addRow();
            }
        }

        // --- INVOICE LOGIC ---
        const invoiceNumberElement = document.getElementById('invoice-number');
        
        function setupAutoClear(id, defaultText) {
            const el = document.getElementById(id);
            if(!el) return;
            el.addEventListener('focus', () => { if(el.innerText.trim() === defaultText) el.innerText = ''; });
            el.addEventListener('blur', () => { if(el.innerText.trim() === '') el.innerText = defaultText; });
        }
        setupAutoClear('customer-name', 'Customer Name');
        setupAutoClear('customer-phone', 'Phone Number');

        function setInvoiceNumberDisplay(num) { 
            if(invoiceNumberElement) invoiceNumberElement.textContent = String(num).padStart(4, '0'); 
        }
        
        function initializeInvoiceNumber() {
            let lastNum = localStorage.getItem(STORAGE_KEY_COUNTER);
            if (!lastNum) { lastNum = 9876; localStorage.setItem(STORAGE_KEY_COUNTER, lastNum); }
            setInvoiceNumberDisplay(parseInt(lastNum, 10) + 1);
        }

        function setTodayDate() {
            const today = new Date();
            const d = String(today.getDate()).padStart(2, '0');
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const y = today.getFullYear();
            
            const invDate = document.getElementById('invoice-date');
            if(invDate) invDate.textContent = `${d}/${m}/${y}`;
            
            const monthStr = `${y}-${m}`;
            const monthFilter = document.getElementById('hisab-month-filter');
            if(monthFilter) monthFilter.value = monthStr;
            const expMonthFilter = document.getElementById('expense-month-filter');
            if(expMonthFilter) expMonthFilter.value = monthStr;

            const hDate = document.getElementById('h-date');
            if(hDate) hDate.valueAsDate = today;
            const expDate = document.getElementById('exp-date');
            if(expDate) expDate.valueAsDate = today;
            const salamDate = document.getElementById('salam-date');
            if(salamDate) salamDate.valueAsDate = today; 
        }

        function resetInvoiceDate() {
            const today = new Date();
            const d = String(today.getDate()).padStart(2, '0');
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const invDate = document.getElementById('invoice-date');
            if(invDate) invDate.textContent = `${d}/${m}/${today.getFullYear()}`;
        }

        const itemsTableBody = document.getElementById('items-table-body');

        const calculateTotal = () => {
            let subtotal = 0;
            document.querySelectorAll('.item-amount').forEach(el => {
                subtotal += parseFloat(el.innerText.replace(/[^0-9.-]+/g,"")) || 0;
            });
            const sub = document.getElementById('subtotal');
            const tot = document.getElementById('total');
            if(sub) sub.textContent = subtotal.toFixed(3);
            if(tot) tot.textContent = subtotal.toFixed(3);
        };

        window.addRow = (desc = "DHAKA TO SALALAH", price = "0.000") => {
            if(!itemsTableBody) return;
            const newRow = document.createElement('tr');
            newRow.className = 'item-row border-b border-gray-100 hover:bg-gray-50';
            newRow.innerHTML = `
                <td class="p-3 align-top"><div class="flex flex-col gap-1"><span contenteditable="true" class="item-desc editable w-full block font-medium text-gray-800" data-placeholder="Description">${desc}</span></div></td>
                <td class="p-3 align-top text-right"><span contenteditable="true" class="item-amount editable w-full block text-right font-mono text-lg text-gray-700">${price}</span></td>
                <td class="p-3 text-center no-print align-middle"><button onclick="deleteRow(this)" class="delete-row text-red-400 hover:text-red-600 font-bold p-1 rounded hover:bg-red-50"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
            `;
            itemsTableBody.appendChild(newRow);
            lucide.createIcons();
            
            const amountCell = newRow.querySelector('.item-amount');
            const descCell = newRow.querySelector('.item-desc');
            [amountCell, descCell].forEach(cell => cell.addEventListener('input', calculateTotal));
            amountCell.addEventListener('blur', (e) => {
                const val = parseFloat(e.target.innerText.replace(/[^0-9.-]+/g,"")) || 0;
                e.target.innerText = val.toFixed(3);
                calculateTotal();
            });
            descCell.addEventListener('focus', function() { if (this.innerText.includes("DHAKA TO SALALAH")) this.innerText = ""; });
            calculateTotal();
        };
        
        window.deleteRow = (btn) => { btn.closest('tr').remove(); calculateTotal(); };

        function showMessage(text, type = 'success') {
            const msg = document.getElementById('system-message');
            if(!msg) return;
            msg.textContent = text;
            msg.className = type === 'error' ? 'text-red-500 font-bold' : 'text-blue-600 font-bold';
            setTimeout(() => { msg.textContent = 'Ready'; msg.className = 'font-medium'; }, 3000);
        }

        function saveInvoice() {
            if(!invoiceNumberElement) return;
            const id = parseInt(invoiceNumberElement.textContent, 10);
            const dateStr = document.getElementById('invoice-date').innerText;
            const custName = document.getElementById('customer-name').innerText;
            const phone = document.getElementById('customer-phone').innerText;
            
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                items.push({ desc: row.querySelector('.item-desc').innerText, amount: row.querySelector('.item-amount').innerText });
            });

            const paidEl = document.getElementById('paid-toggle');
            const data = {
                id: id, date: dateStr, customerName: custName,
                customerPhone: phone,
                items: items, paid: paidEl ? paidEl.checked : false
            };
            localStorage.setItem(STORAGE_PREFIX + id, JSON.stringify(data));
            
            let currentHigh = parseInt(localStorage.getItem(STORAGE_KEY_COUNTER) || 0, 10);
            if (id > currentHigh) localStorage.setItem(STORAGE_KEY_COUNTER, id);

            // Auto-Add Invoice to Ledger
            const totEl = document.getElementById('total');
            const totalAmount = totEl ? parseFloat(totEl.textContent) : 0;
            if (totalAmount > 0) {
                const parts = dateStr.split('/');
                const isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                addHisabTransaction({
                    date: isoDate,
                    name: custName,
                    pnr: '',
                    flight_date: '',
                    sector: items[0]?.desc || 'Invoice',
                    phone: phone,
                    net: 0, 
                    sell: totalAmount,
                    due: 0,
                    invoiceId: id
                });
            }
            showMessage(`Invoice #${id} Saved & Added to Ledger!`);
        }

        function searchInvoice() {
            const term = document.getElementById('search-input').value;
            if (!term) return showMessage('Enter a number', 'error');
            const dataStr = localStorage.getItem(STORAGE_PREFIX + parseInt(term, 10));
            if (!dataStr) return showMessage('Not Found', 'error');
            const data = JSON.parse(dataStr);
            setInvoiceNumberDisplay(data.id);
            document.getElementById('invoice-date').innerText = data.date;
            document.getElementById('customer-name').innerText = data.customerName;
            document.getElementById('customer-phone').innerText = data.customerPhone;
            const paidEl = document.getElementById('paid-toggle');
            if(paidEl) paidEl.checked = data.paid;
            togglePaidStamp();
            itemsTableBody.innerHTML = '';
            data.items.forEach(item => addRow(item.desc, item.amount));
            showMessage(`Invoice #${term} Loaded`);
        }

        function generateNewInvoice() {
            let lastNum = localStorage.getItem(STORAGE_KEY_COUNTER) || 9876;
            setInvoiceNumberDisplay(parseInt(lastNum, 10) + 1);
            resetInvoiceDate(); 
            document.getElementById('customer-name').innerText = "Customer Name";
            document.getElementById('customer-phone').innerText = "Phone Number";
            const paidEl = document.getElementById('paid-toggle');
            if(paidEl) paidEl.checked = false;
            togglePaidStamp();
            document.getElementById('search-input').value = '';
            if(itemsTableBody) itemsTableBody.innerHTML = '';
            addRow("DHAKA TO SALALAH", "0.000");
            showMessage('New Invoice Created');
        }

        function togglePaidStamp() {
            const paidEl = document.getElementById('paid-toggle');
            const stamp = document.getElementById('paid-watermark');
            if (paidEl && paidEl.checked) {
                if(stamp) stamp.classList.add('is-visible');
            } else {
                if(stamp) stamp.classList.remove('is-visible');
            }
        }
        const paidToggle = document.getElementById('paid-toggle');
        if(paidToggle) paidToggle.addEventListener('change', togglePaidStamp);

        // --- LEDGER LOGIC ---
        function getHisabData() {
            const raw = localStorage.getItem(STORAGE_HISAB);
            return raw ? JSON.parse(raw) : [];
        }

        function updateHisabTransaction(id, updatedEntry) {
            const data = getHisabData();
            const index = data.findIndex(e => e.id === parseInt(id));
            if (index !== -1) {
                data[index] = { ...data[index], ...updatedEntry }; 
                localStorage.setItem(STORAGE_HISAB, JSON.stringify(data));
                loadHisab();
                cancelEdit(); 
            }
        }

        function addHisabTransaction(entry) {
            const data = getHisabData();
            if(entry.invoiceId) {
                const exists = data.findIndex(e => e.invoiceId === entry.invoiceId);
                if(exists > -1) {
                    const old = data[exists];
                    entry.net = old.net > 0 ? old.net : entry.net; 
                    data[exists] = { ...old, ...entry, id: old.id };
                } else {
                    entry.id = Date.now();
                    data.push(entry);
                }
            } else {
                entry.id = Date.now();
                data.push(entry);
            }
            localStorage.setItem(STORAGE_HISAB, JSON.stringify(data));
            loadHisab();
        }

        function addHisabEntry() {
            let dateEl = document.getElementById('h-date');
            let date = dateEl.value;

            if (!date) {
                const today = new Date();
                const d = String(today.getDate()).padStart(2, '0');
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const y = today.getFullYear();
                date = `${y}-${m}-${d}`;
                dateEl.value = date;
            }

            const name = document.getElementById('h-name').value;
            const pnr = document.getElementById('h-pnr').value;
            const fdate = document.getElementById('h-fdate').value || date;
            const sector = document.getElementById('h-sector').value;
            const phone = document.getElementById('h-phone').value;
            const net = parseFloat(document.getElementById('h-net').value) || 0;
            const sell = parseFloat(document.getElementById('h-sell').value) || 0;
            const due = parseFloat(document.getElementById('h-due').value) || 0;

            if(!name) return alert('Name is required');

            const entryData = {
                date: date, name: name, pnr: pnr, flight_date: fdate,
                sector: sector, phone: phone, net: net, sell: sell, due: due
            };

            const editId = document.getElementById('h-edit-id').value;
            
            if (editId) {
                updateHisabTransaction(editId, entryData);
            } else {
                addHisabTransaction({ ...entryData, invoiceId: null });
                ['h-name','h-pnr','h-fdate','h-sector','h-phone','h-net','h-sell','h-due'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('h-name').focus();
            }
        }

        function generateInvoiceFromLedger(id) {
            event.stopPropagation();
            const data = getHisabData().find(e => e.id === id);
            if (!data) return alert("Transaction not found");

            switchTab('invoice');

            if (data.date) {
                const parts = data.date.split('-');
                if(parts.length === 3) {
                    const invDate = document.getElementById('invoice-date');
                    if(invDate) invDate.textContent = `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
            }
            
            document.getElementById('customer-name').innerText = data.name || "Customer Name";
            document.getElementById('customer-phone').innerText = data.phone || "";

            const tbody = document.getElementById('items-table-body');
            if(tbody) tbody.innerHTML = ''; 

            let desc = "Air Ticket";
            if (data.sector) desc += ` / ${data.sector}`;
            if (data.pnr) desc += ` (PNR: ${data.pnr})`;
            if (data.flight_date) desc += ` - Travel Date: ${data.flight_date}`;

            addRow(desc, data.sell.toFixed(3));
            showMessage("Invoice Generated from Ledger!");
        }

        function editRow(id) {
            const data = getHisabData().find(e => e.id === id);
            if(!data) return;

            document.getElementById('h-date').value = data.date;
            document.getElementById('h-name').value = data.name;
            document.getElementById('h-pnr').value = data.pnr || '';
            document.getElementById('h-fdate').value = data.flight_date || '';
            document.getElementById('h-sector').value = data.sector || '';
            document.getElementById('h-phone').value = data.phone || '';
            document.getElementById('h-net').value = data.net;
            document.getElementById('h-sell').value = data.sell;
            document.getElementById('h-due').value = data.due || 0;

            document.getElementById('h-edit-id').value = id;
            
            const btn = document.getElementById('btn-add-update');
            btn.textContent = "UPDATE";
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            btn.classList.add('bg-orange-500', 'hover:bg-orange-600');
            
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            
            document.querySelectorAll('.excel-table tr').forEach(r => r.classList.remove('row-selected'));
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if(row) row.classList.add('row-selected');
            
            const form = document.querySelector('.px-6.py-4');
            if(form) form.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('h-edit-id').value = '';
            
            const btn = document.getElementById('btn-add-update');
            btn.textContent = "ADD";
            btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            btn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.querySelectorAll('.excel-table tr').forEach(r => r.classList.remove('row-selected'));
            
            // Clear inputs BUT KEEP DATE
            ['h-name','h-pnr','h-fdate','h-sector','h-phone','h-net','h-sell','h-due'].forEach(id => document.getElementById(id).value = '');
        }

        function deleteHisabEntry(id) {
            event.stopPropagation();
            if(!confirm('Delete this entry?')) return;
            
            const data = getHisabData().filter(e => e.id !== id);
            localStorage.setItem(STORAGE_HISAB, JSON.stringify(data));
            
            if(document.getElementById('h-edit-id').value == id) cancelEdit();
            
            loadHisab();
        }

        function loadHisab() {
            const filterEl = document.getElementById('hisab-month-filter');
            if(!filterEl) return;
            const selectedMonth = filterEl.value;
            const [y, m] = selectedMonth.split('-');
            const dateObj = new Date(parseInt(y), parseInt(m)-1);
            
            const headerDate = document.getElementById('sheet-header-date');
            if(headerDate) headerDate.textContent = dateObj.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const allData = getHisabData();
            const data = allData.filter(e => e.date.startsWith(selectedMonth));
            
            data.sort((a, b) => a.date.localeCompare(b.date));

            const tbody = document.getElementById('hisab-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';

            let tNet = 0, tSell = 0, tProfit = 0, tDue = 0;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="p-8 text-center text-gray-400 italic">No transactions found for this month.</td></tr>';
            } else {
                data.forEach(item => {
                    const profit = item.sell - item.net;
                    tNet += item.net;
                    tSell += item.sell;
                    tProfit += profit;
                    tDue += (item.due || 0);

                    const row = document.createElement('tr');
                    row.setAttribute('data-id', item.id);
                    row.onclick = () => editRow(item.id); 
                    
                    const displayDate = new Date(item.date).toLocaleDateString('en-GB', {day: 'numeric', month: 'short'});
                    const fDateDisplay = item.flight_date ? new Date(item.flight_date).toLocaleDateString('en-GB', {day: 'numeric', month: 'short'}) : '-';

                    row.innerHTML = `
                        <td class="text-center">${displayDate}</td>
                        <td class="font-bold text-gray-700" title="${item.name}">${item.name}</td>
                        <td class="text-center text-xs font-mono">${item.pnr || '-'}</td>
                        <td class="text-center text-xs">${fDateDisplay}</td>
                        <td class="text-right text-red-600">${item.net.toFixed(3)}</td>
                        <td class="text-right text-green-700 font-bold">${item.sell.toFixed(3)}</td>
                        <td class="text-right text-blue-800 bg-blue-50 font-bold">${profit.toFixed(3)}</td>
                        <td class="text-xs text-center">${item.sector || '-'}</td>
                        <td class="text-xs text-center">${item.phone || '-'}</td>
                        <td class="text-right text-orange-600 font-bold bg-orange-50">${(item.due || 0).toFixed(3)}</td>
                        <td class="text-center no-print flex gap-1 justify-center items-center h-full">
                            <button onclick="generateInvoiceFromLedger(${item.id})" class="text-blue-500 hover:text-blue-700 p-1" title="Generate Invoice"><i data-lucide="file-text" class="w-3 h-3"></i></button>
                            <button onclick="deleteHisabEntry(${item.id})" class="text-gray-400 hover:text-red-500 p-1" title="Delete"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            const tNetEl = document.getElementById('tot-net'); if(tNetEl) tNetEl.textContent = tNet.toFixed(3);
            const tSellEl = document.getElementById('tot-sell'); if(tSellEl) tSellEl.textContent = tSell.toFixed(3);
            const tProfitEl = document.getElementById('tot-profit'); if(tProfitEl) tProfitEl.textContent = tProfit.toFixed(3);
            const tDueEl = document.getElementById('tot-due'); if(tDueEl) tDueEl.textContent = tDue.toFixed(3);
            
            lucide.createIcons();
        }

        function exportHisab(mode = 'month') {
            const selectedMonth = document.getElementById('hisab-month-filter').value;
            let data;
            let filename;

            if (mode === 'all') {
                data = getHisabData();
                filename = `HolidayTravels_Ledger_Full.csv`;
            } else {
                data = getHisabData().filter(e => e.date.startsWith(selectedMonth));
                filename = `Ledger_${selectedMonth}.csv`;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Name,PNR,FlightDate,Sector,Phone,Net(Cost),Sell,Profit,Due\n";

            data.sort((a, b) => a.date.localeCompare(b.date));

            data.forEach(e => {
                const profit = e.sell - e.net;
                const safeName = e.name.replace(/,/g, ' '); 
                const safePnr = (e.pnr || '').replace(/,/g, ' ');
                csvContent += `${e.date},${safeName},${safePnr},${e.flight_date || ''},${e.sector || ''},${e.phone || ''},${e.net},${e.sell},${profit},${e.due || 0}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
        }

        // --- EXPENSE LOGIC ---
        function getExpenseData() {
            const raw = localStorage.getItem(STORAGE_EXPENSE);
            return raw ? JSON.parse(raw) : [];
        }

        function addExpenseEntry() {
            const date = document.getElementById('exp-date').value;
            const desc = document.getElementById('exp-desc').value;
            const type = document.getElementById('exp-type').value;
            const amount = parseFloat(document.getElementById('exp-amount').value) || 0;

            if(!date || !desc || amount === 0) return alert('Please fill all fields');

            const data = getExpenseData();
            data.push({ id: Date.now(), date, desc, type, amount });
            localStorage.setItem(STORAGE_EXPENSE, JSON.stringify(data));
            
            // Reset
            document.getElementById('exp-desc').value = '';
            document.getElementById('exp-amount').value = '';
            loadExpense();
        }

        function deleteExpenseEntry(id) {
            if(!confirm('Delete this expense?')) return;
            const data = getExpenseData().filter(e => e.id !== id);
            localStorage.setItem(STORAGE_EXPENSE, JSON.stringify(data));
            loadExpense();
        }

        function loadExpense() {
            const filterEl = document.getElementById('expense-month-filter');
            if(!filterEl) return;
            const selectedMonth = filterEl.value;
            
            const allData = getExpenseData();
            const data = allData.filter(e => e.date.startsWith(selectedMonth));
            data.sort((a, b) => a.date.localeCompare(b.date));

            const tbody = document.getElementById('expense-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';

            let officeTotal = 0, personalTotal = 0;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400 italic">No expenses found for this month.</td></tr>';
            } else {
                data.forEach(item => {
                    if (item.type === 'Office') officeTotal += item.amount;
                    else personalTotal += item.amount;

                    const row = document.createElement('tr');
                    const displayDate = new Date(item.date).toLocaleDateString('en-GB', {day: 'numeric', month: 'short'});
                    const badgeClass = item.type === 'Office' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800';

                    row.innerHTML = `
                        <td class="text-center">${displayDate}</td>
                        <td>${item.desc}</td>
                        <td class="text-center"><span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${item.type}</span></td>
                        <td class="text-right font-mono">${item.amount.toFixed(3)}</td>
                        <td class="text-center no-print"><button onclick="deleteExpenseEntry(${item.id})" class="text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></td>
                    `;
                    tbody.appendChild(row);
                });
            }

            const expOff = document.getElementById('exp-total-office'); if(expOff) expOff.textContent = officeTotal.toFixed(3);
            const expPer = document.getElementById('exp-total-personal'); if(expPer) expPer.textContent = personalTotal.toFixed(3);
            const expGrand = document.getElementById('exp-total-grand'); if(expGrand) expGrand.textContent = (officeTotal + personalTotal).toFixed(3);
            lucide.createIcons();
        }

        function exportExpense() {
            const selectedMonth = document.getElementById('expense-month-filter').value;
            const data = getExpenseData().filter(e => e.date.startsWith(selectedMonth));
            let csvContent = "data:text/csv;charset=utf-8,Date,Description,Type,Amount\n";
            
            data.forEach(e => {
                csvContent += `${e.date},"${e.desc}",${e.type},${e.amount}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Expenses_${selectedMonth}.csv`);
            document.body.appendChild(link);
            link.click();
        }

        // --- DUE & BANKING LOGIC ---
        function setDueView(mode) {
            dueViewMode = mode;
            const activeBtn = document.getElementById('btn-due-active');
            const historyBtn = document.getElementById('btn-due-history');
            const activeView = document.getElementById('due-active-view');
            const historyView = document.getElementById('due-history-view');

            if (mode === 'active') {
                if(activeBtn) activeBtn.className = "px-6 py-1.5 rounded-md text-sm font-bold bg-white text-gray-800 shadow-sm transition-all";
                if(historyBtn) historyBtn.className = "px-6 py-1.5 rounded-md text-sm font-bold text-gray-600 hover:bg-gray-300 transition-all";
                if(activeView) activeView.classList.remove('hidden');
                if(historyView) historyView.classList.add('hidden');
            } else {
                if(historyBtn) historyBtn.className = "px-6 py-1.5 rounded-md text-sm font-bold bg-white text-gray-800 shadow-sm transition-all";
                if(activeBtn) activeBtn.className = "px-6 py-1.5 rounded-md text-sm font-bold text-gray-600 hover:bg-gray-300 transition-all";
                if(historyView) historyView.classList.remove('hidden');
                if(activeView) activeView.classList.add('hidden');
            }
            loadDueData();
        }

        function getDueData() {
            const raw = localStorage.getItem(STORAGE_DUE);
            return raw ? JSON.parse(raw) : [];
        }

        function addDueRow(type) {
            const data = getDueData();
            const newItem = {
                id: Date.now(),
                type: type, // 'customer', 'payable', 'bank'
                name: '', // Empty for placeholder
                phone: '', 
                bankName: '', // Empty for placeholder
                amount: '', // Empty for placeholder
                date: new Date().toISOString().split('T')[0],
                status: 'Pending',
                paymentDate: ''
            };
            data.push(newItem);
            localStorage.setItem(STORAGE_DUE, JSON.stringify(data));
            loadDueData();
        }

        function updateDueItem(id, field, value) {
            const data = getDueData();
            const index = data.findIndex(e => e.id === id);
            if(index !== -1) {
                data[index][field] = value;
                
                // Auto-set Payment Date when marked Paid
                if(field === 'status' && value === 'Paid' && !data[index].paymentDate) {
                    data[index].paymentDate = new Date().toISOString().split('T')[0];
                }
                // Clear Payment Date if marked Pending
                if(field === 'status' && value === 'Pending') {
                    data[index].paymentDate = '';
                }

                localStorage.setItem(STORAGE_DUE, JSON.stringify(data));
                loadDueData();
            }
        }

        let lastDeletedDue = null;

        function deleteDueItem(id) {
            if(!confirm('Delete this item?')) return;
            const data = getDueData();
            const itemIndex = data.findIndex(e => e.id === id);
            if (itemIndex > -1) {
                lastDeletedDue = data[itemIndex]; 
                data.splice(itemIndex, 1);
                localStorage.setItem(STORAGE_DUE, JSON.stringify(data));
                loadDueData();
                
                const btn = document.getElementById('btn-undo-due');
                if(btn) {
                    btn.classList.remove('hidden');
                    setTimeout(() => { btn.classList.add('hidden'); lastDeletedDue = null; }, 8000);
                }
            }
        }

        function undoDeleteDue() {
            if (!lastDeletedDue) return;
            const data = getDueData();
            data.push(lastDeletedDue);
            localStorage.setItem(STORAGE_DUE, JSON.stringify(data));
            loadDueData();
            const btn = document.getElementById('btn-undo-due');
            if(btn) btn.classList.add('hidden');
            lastDeletedDue = null;
        }

        function loadDueData() {
            const data = getDueData();
            
            // Stats Calculation (Always all data)
            let totalReceive = 0, totalPay = 0, totalBank = 0;
            data.forEach(item => {
                const amt = parseFloat(item.amount) || 0;
                if (item.type === 'customer' && item.status === 'Pending') totalReceive += amt;
                if (item.type === 'payable' && item.status === 'Pending') totalPay += amt;
                if (item.type === 'bank') totalBank += amt;
            });
            
            const rEl = document.getElementById('due-total-receive'); if(rEl) rEl.textContent = totalReceive.toFixed(3);
            const pEl = document.getElementById('due-total-pay'); if(pEl) pEl.textContent = totalPay.toFixed(3);
            const bEl = document.getElementById('due-total-bank'); if(bEl) bEl.textContent = totalBank.toFixed(3);
            
            const netBalance = (totalReceive + totalBank) - totalPay;
            const balEl = document.getElementById('due-total-balance');
            if(balEl) {
                balEl.textContent = netBalance.toFixed(3);
                balEl.className = `text-2xl font-black ${netBalance >= 0 ? 'text-gray-800' : 'text-red-600'}`;
            }

            // Containers
            const custContainer = document.getElementById('due-table-customer');
            const payContainer = document.getElementById('due-table-payable');
            const bankContainer = document.getElementById('due-table-bank');
            const historyContainer = document.getElementById('due-table-history');
            const bankHistoryContainer = document.getElementById('due-table-bank-history');
            
            if(custContainer) custContainer.innerHTML = '';
            if(payContainer) payContainer.innerHTML = '';
            if(bankContainer) bankContainer.innerHTML = '';
            if(historyContainer) historyContainer.innerHTML = '';
            if(bankHistoryContainer) bankHistoryContainer.innerHTML = '';

            // Render Rows based on View Mode
            // Sort by date desc
            data.sort((a,b) => new Date(b.date) - new Date(a.date));

            data.forEach(item => {
                const amt = parseFloat(item.amount) || 0;
                
                // ACTIVE VIEW RENDER
                if (dueViewMode === 'active') {
                    if (item.type === 'bank') {
                        // Show recent 5 banks in active
                        if (bankContainer && bankContainer.childElementCount < 5) {
                            bankContainer.appendChild(createBankRow(item));
                        }
                    } else if (item.status === 'Pending') {
                        // Show all pending
                        const row = createEditableRow(item);
                        if (item.type === 'customer' && custContainer) custContainer.appendChild(row);
                        else if(payContainer) payContainer.appendChild(row);
                    }
                }

                // HISTORY VIEW RENDER
                if (dueViewMode === 'history') {
                    if (item.type === 'bank' && bankHistoryContainer) {
                        bankHistoryContainer.appendChild(createBankRow(item));
                    } else if (item.status === 'Paid' && historyContainer) {
                        historyContainer.appendChild(createHistoryRow(item));
                    }
                }
            });
            
            lucide.createIcons();
        }

        function createEditableRow(item) {
            const row = document.createElement('tr');
            
            // Conditional HTML for Phone column (Only for Customer)
            let phoneHtml = '';
            if (item.type === 'customer') {
                phoneHtml = `<td><input type="text" class="w-full p-1 border rounded bg-white text-gray-800 text-sm" value="${item.phone || ''}" placeholder="968..." onchange="updateDueItem(${item.id}, 'phone', this.value)"></td>`;
            }

            row.innerHTML = `
                <td><input type="text" class="w-full p-1 border rounded bg-white text-gray-800 text-sm" value="${item.name === 'Name' ? '' : item.name}" placeholder="Name" onchange="updateDueItem(${item.id}, 'name', this.value)"></td>
                ${phoneHtml}
                <td><input type="number" step="0.001" class="w-full p-1 border rounded bg-white text-gray-800 text-sm font-mono" value="${(item.amount === 0 || item.amount === '0') ? '' : item.amount}" placeholder="0.000" onchange="updateDueItem(${item.id}, 'amount', this.value)"></td>
                <td><input type="date" class="w-full p-1 border rounded bg-white text-gray-800 text-sm" value="${item.date}" onchange="updateDueItem(${item.id}, 'date', this.value)"></td>
                <td>
                    <select class="w-full p-1 border rounded bg-white text-sm ${item.status === 'Paid' ? 'text-green-600 font-bold' : 'text-orange-600'}" onchange="updateDueItem(${item.id}, 'status', this.value)">
                        <option value="Pending" ${item.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Paid" ${item.status === 'Paid' ? 'selected' : ''}>Paid</option>
                    </select>
                </td>
                <td class="text-center no-print"><button onclick="deleteDueItem(${item.id})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
            `;
            return row;
        }

        function createBankRow(item) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="date" class="w-full p-1 border rounded bg-white text-gray-800 text-sm" value="${item.date}" onchange="updateDueItem(${item.id}, 'date', this.value)"></td>
                <td><input type="text" class="w-full p-1 border rounded bg-white text-gray-800 text-sm" value="${item.bankName === 'Bank Name' ? '' : item.bankName}" placeholder="Bank Name" onchange="updateDueItem(${item.id}, 'bankName', this.value)"></td>
                <td><input type="number" step="0.001" class="w-full p-1 border rounded bg-white text-green-700 font-bold text-sm font-mono" value="${(item.amount === 0 || item.amount === '0') ? '' : item.amount}" placeholder="0.000" onchange="updateDueItem(${item.id}, 'amount', this.value)"></td>
                <td class="text-center no-print"><button onclick="deleteDueItem(${item.id})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
            `;
            return row;
        }

        function createHistoryRow(item) {
            const row = document.createElement('tr');
            const typeLabel = item.type === 'customer' ? '<span class="text-blue-600 font-bold text-xs">Receive</span>' : '<span class="text-red-600 font-bold text-xs">Payable</span>';
            const dateValue = item.paymentDate || new Date().toISOString().split('T')[0]; // Default to today if missing
            
            // Display phone if available in history
            let displayDetails = item.name;
            if (item.type === 'customer' && item.phone) {
                displayDetails += ` <span class="text-xs text-gray-500">(${item.phone})</span>`;
            }

            row.innerHTML = `
                <td class="text-center">${typeLabel}</td>
                <td class="font-medium">${displayDetails}</td>
                <td class="font-mono">${parseFloat(item.amount).toFixed(3)}</td>
                <td class="text-xs text-gray-500">${item.date}</td>
                <td><input type="date" class="w-full p-1 border rounded bg-gray-50 text-xs" value="${dateValue}" onchange="updateDueItem(${item.id}, 'paymentDate', this.value)"></td>
                <td>
                    <select class="w-full p-1 border rounded bg-green-50 text-green-700 text-xs font-bold" onchange="updateDueItem(${item.id}, 'status', this.value)">
                        <option value="Paid" selected>Paid</option>
                        <option value="Pending">Revert to Pending</option>
                    </select>
                </td>
                <td class="text-center no-print"><button onclick="deleteDueItem(${item.id})" class="text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button></td>
            `;
            return row;
        }

        // --- DASHBOARD LOGIC ---
        function updateDashboard() {
            const data = getHisabData();
            
            // 1. Calculate Aggregates per Month
            const monthlyStats = {};
            let yearSell = 0, yearProfit = 0, totalDue = 0;

            data.forEach(item => {
                // Ensure item.date exists before substring
                if (!item.date) return;
                const monthKey = item.date.substring(0, 7); // "YYYY-MM"
                const profit = item.sell - item.net;
                
                if (!monthlyStats[monthKey]) {
                    monthlyStats[monthKey] = { sell: 0, net: 0, profit: 0 };
                }
                
                monthlyStats[monthKey].sell += item.sell;
                monthlyStats[monthKey].net += item.net;
                monthlyStats[monthKey].profit += profit;
                
                yearSell += item.sell;
                yearProfit += profit;
                totalDue += (item.due || 0);
            });

            // 2. Sort Months
            const sortedMonths = Object.keys(monthlyStats).sort();
            
            // 3. Prepare Chart Data
            const labels = sortedMonths; // e.g., ["2026-01", "2026-02"]
            const salesData = sortedMonths.map(m => monthlyStats[m].sell);
            const netData = sortedMonths.map(m => monthlyStats[m].net);
            const profitData = sortedMonths.map(m => monthlyStats[m].profit);

            // 4. Update Stats Cards
            const tSell = document.getElementById('dash-total-sell'); if(tSell) tSell.textContent = yearSell.toFixed(3);
            const tProf = document.getElementById('dash-total-profit'); if(tProf) tProf.textContent = yearProfit.toFixed(3);
            const tDue = document.getElementById('dash-total-due'); if(tDue) tDue.textContent = totalDue.toFixed(3);

            // 5. Render/Update Charts
            renderSalesChart(labels, salesData, netData);
            renderProfitChart(labels, profitData);
            renderExpenseChart(); // New expense chart
            renderDueChart(); // New due chart
            
            // 6. CHECK-IN ALERTS
            updateDashboardCheckins();
        }

        function updateDashboardCheckins() {
            const reminders = getSalamReminders(); // Uses existing function from Notes logic
            const today = new Date();
            today.setHours(0,0,0,0);
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            const urgent = [];
            
            reminders.forEach(r => {
                const flightDate = new Date(r.date);
                flightDate.setHours(0,0,0,0);
                
                // Check if Today or Tomorrow
                if (flightDate.getTime() === today.getTime() || flightDate.getTime() === tomorrow.getTime()) {
                    urgent.push(r);
                }
            });
            
            const alertBox = document.getElementById('dashboard-alerts');
            if (!alertBox) return;

            if (urgent.length > 0) {
                alertBox.classList.remove('hidden');
                let html = `
                <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r shadow-sm">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center">
                            <i data-lucide="bell-ring" class="h-6 w-6 text-amber-600 mr-3 animate-pulse"></i>
                            <div>
                                <h3 class="text-lg font-bold text-amber-900">Urgent Check-ins Needed (${urgent.length})</h3>
                                <p class="text-sm text-amber-700">Passengers flying within 48 hours.</p>
                            </div>
                        </div>
                        <button onclick="switchTab('notes')" class="bg-amber-600 text-white text-xs px-4 py-1.5 rounded-lg font-bold hover:bg-amber-700 shadow-sm transition-colors">
                            Go to Check-in
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">`;
                    
                urgent.forEach(r => {
                     const fDate = new Date(r.date);
                     fDate.setHours(0,0,0,0);
                     const isToday = fDate.getTime() === today.getTime();
                     const badge = isToday 
                        ? `<span class="bg-red-100 text-red-700 text-[10px] px-2 py-0.5 rounded font-bold uppercase border border-red-200">Flight Today</span>` 
                        : `<span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded font-bold uppercase border border-blue-200">Tomorrow</span>`;
                     
                     html += `
                      <div class="flex justify-between items-center bg-white p-2.5 rounded border border-amber-100 shadow-sm">
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-800 text-sm">${r.name}</span>
                            <span class="font-mono text-xs text-gray-500">PNR: ${r.pnr}</span>
                        </div>
                        ${badge}
                      </div>`;
                });
                
                html += `</div></div>`;
                alertBox.innerHTML = html;
                lucide.createIcons();
            } else {
                alertBox.classList.add('hidden');
                alertBox.innerHTML = '';
            }
        }

        let salesChartInstance = null;
        let profitChartInstance = null;
        let expenseChartInstance = null;
        let dueChartInstance = null;

        function renderSalesChart(labels, sales, net) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (salesChartInstance) salesChartInstance.destroy();

            salesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Total Sell', data: sales, backgroundColor: '#22c55e' },
                        { label: 'Total Net Cost', data: net, backgroundColor: '#ef4444' }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderProfitChart(labels, profit) {
            const ctx = document.getElementById('profitChart').getContext('2d');
            if (profitChartInstance) profitChartInstance.destroy();

            profitChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Net Profit', data: profit, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)', fill: true, tension: 0.4 }]
                },
                options: { responsive: true }
            });
        }

        function renderExpenseChart() {
            const expData = getExpenseData();
            let office = 0, personal = 0;
            // Get all time or filter by year? Let's do all time for overview
            expData.forEach(e => {
                if(e.type === 'Office') office += e.amount;
                else personal += e.amount;
            });

            const ctx = document.getElementById('expenseChart').getContext('2d');
            if (expenseChartInstance) expenseChartInstance.destroy();

            expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Office', 'Personal'],
                    datasets: [{ data: [office, personal], backgroundColor: ['#3b82f6', '#a855f7'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderDueChart() {
            const dueData = getDueData();
            let receive = 0, pay = 0;
            dueData.forEach(item => {
                const amt = parseFloat(item.amount) || 0;
                if(item.status === 'Pending') {
                    if(item.type === 'customer') receive += amt;
                    if(item.type === 'payable') pay += amt;
                }
            });

            const ctx = document.getElementById('dueChart').getContext('2d');
            if (dueChartInstance) dueChartInstance.destroy();

            dueChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Receivable (Customer Due)', 'Payable (My Due)'],
                    datasets: [{ 
                        label: 'Amount (OMR)', 
                        data: [receive, pay], 
                        backgroundColor: ['#3b82f6', '#ef4444'] 
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        window.backupData = () => {
            const data = {};
            // Loop through all local storage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Backup specific app keys + any key starting with holiday_
                if (key.startsWith('holiday_') || key === 'holidayTravelsInvoiceNum') {
                    data[key] = localStorage.getItem(key);
                }
            }
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `HolidayTravels_FullBackup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        };

        window.restoreData = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Wipe existing App Data to prevent mixing versions
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('holiday_') || key === 'holidayTravelsInvoiceNum') {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(k => localStorage.removeItem(k));

                    // Load Backup Data
                    Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                    
                    alert('Data Replaced Successfully!');
                    location.reload();
                } catch(e) { alert('Invalid File'); }
            };
            reader.readAsText(file);
        };

        setTodayDate();
        initializeInvoiceNumber();
        if(itemsTableBody && itemsTableBody.children.length === 0) addRow();
        
        // ... (Notes & Check-in Logic)

        function loadNotes() {
            loadGeneralNotes();
            loadSalamReminders();
            loadSalamHistory();
        }

        // --- General Notes ---
        function getNotes() {
            return JSON.parse(localStorage.getItem(STORAGE_NOTES) || '[]');
        }

        function addNote() {
            const input = document.getElementById('note-input');
            const text = input.value.trim();
            if (!text) return;
            
            const notes = getNotes();
            notes.push({ id: Date.now(), text: text, done: false });
            localStorage.setItem(STORAGE_NOTES, JSON.stringify(notes));
            input.value = '';
            loadGeneralNotes();
        }

        function deleteNote(id) {
            const notes = getNotes().filter(n => n.id !== id);
            localStorage.setItem(STORAGE_NOTES, JSON.stringify(notes));
            loadGeneralNotes();
        }

        function loadGeneralNotes() {
            const list = document.getElementById('notes-list');
            if(!list) return;
            list.innerHTML = '';
            const notes = getNotes();
            
            notes.forEach(note => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100";
                li.innerHTML = `
                    <span class="text-sm text-gray-700">${note.text}</span>
                    <button onclick="deleteNote(${note.id})" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                list.appendChild(li);
            });
            lucide.createIcons();
        }

        // --- SalamAir Reminders ---
        function getSalamReminders() {
            return JSON.parse(localStorage.getItem(STORAGE_SALAM) || '[]');
        }

        function getSalamHistory() {
            return JSON.parse(localStorage.getItem(STORAGE_SALAM_HISTORY) || '[]');
        }

        function addSalamReminder() {
            const pnr = document.getElementById('salam-pnr').value;
            const name = document.getElementById('salam-name').value;
            const date = document.getElementById('salam-date').value;

            if(!pnr || !name || !date) return alert('All fields required');

            const reminders = getSalamReminders();
            reminders.push({ id: Date.now(), pnr, name, date });
            localStorage.setItem(STORAGE_SALAM, JSON.stringify(reminders));
            
            // Clear inputs
            document.getElementById('salam-pnr').value = '';
            document.getElementById('salam-name').value = '';
            document.getElementById('salam-date').value = '';
            
            loadSalamReminders();
        }

        function completeSalamReminder(id) {
            const reminders = getSalamReminders();
            const index = reminders.findIndex(r => r.id === id);
            if (index > -1) {
                const item = reminders[index];
                // Move to history
                const history = getSalamHistory();
                history.push({ ...item, completedDate: new Date().toISOString().split('T')[0] });
                localStorage.setItem(STORAGE_SALAM_HISTORY, JSON.stringify(history));
                
                // Remove from active
                reminders.splice(index, 1);
                localStorage.setItem(STORAGE_SALAM, JSON.stringify(reminders));
                
                loadSalamReminders();
                loadSalamHistory();
            }
        }

        function deleteSalamReminder(id) {
            if(!confirm("Delete this reminder?")) return;
            const reminders = getSalamReminders().filter(r => r.id !== id);
            localStorage.setItem(STORAGE_SALAM, JSON.stringify(reminders));
            loadSalamReminders();
        }

        function deleteSalamHistory(id) {
            if(!confirm("Delete this history record?")) return;
            const history = getSalamHistory().filter(r => r.id !== id);
            localStorage.setItem(STORAGE_SALAM_HISTORY, JSON.stringify(history));
            loadSalamHistory();
        }

        function loadSalamReminders() {
            const tbody = document.getElementById('salam-active-list');
            if(!tbody) return;
            tbody.innerHTML = '';
            const reminders = getSalamReminders();
            
            // Sort by date (soonest first)
            reminders.sort((a,b) => new Date(a.date) - new Date(b.date));

            if(reminders.length === 0) {
                document.getElementById('salam-empty').classList.remove('hidden');
            } else {
                document.getElementById('salam-empty').classList.add('hidden');
                
                const today = new Date();
                today.setHours(0,0,0,0);
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);

                reminders.forEach(r => {
                    const flightDate = new Date(r.date);
                    flightDate.setHours(0,0,0,0);
                    
                    let rowClass = "";
                    if (flightDate.getTime() === today.getTime()) rowClass = "bg-red-50 border-l-4 border-red-500"; // Flight Today! (Urgent)
                    else if (flightDate.getTime() === tomorrow.getTime()) rowClass = "bg-yellow-50 border-l-4 border-yellow-400"; // Flight Tomorrow (Check-in time)
                    else if (flightDate < today) rowClass = "bg-gray-100 opacity-60"; // Passed

                    const row = document.createElement('tr');
                    row.className = rowClass;
                    row.innerHTML = `
                        <td class="font-mono text-xs">${r.date}</td>
                        <td class="font-bold font-mono">${r.pnr}</td>
                        <td>${r.name}</td>
                        <td class="text-center flex gap-2 justify-center">
                             <button onclick="completeSalamReminder(${r.id})" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700" title="Mark Check-in Done">Done</button>
                             <button onclick="deleteSalamReminder(${r.id})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            lucide.createIcons();
        }

        function loadSalamHistory() {
            const tbody = document.getElementById('salam-history-list');
            if(!tbody) return;
            tbody.innerHTML = '';
            const history = getSalamHistory();
            
            // Sort newest completed first
            history.sort((a,b) => b.id - a.id);

            history.forEach(r => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-xs text-gray-500">${r.date}</td>
                    <td class="text-xs">${r.pnr}</td>
                    <td class="text-xs">${r.name}</td>
                    <td class="text-center text-xs text-green-600 font-bold">
                        Checked-in
                         <button onclick="deleteSalamHistory(${r.id})" class="ml-2 text-gray-300 hover:text-red-400"><i data-lucide="x" class="w-3 h-3 inline"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            lucide.createIcons();
        }

        function toggleSalamHistory() {
            const container = document.getElementById('salam-history-container');
            container.classList.toggle('hidden');
        }
    </script>
</body>
</html>